<!DOCTYPE html>
<html>
<head>
  <title>Fault Report â€“ Electrical Panel</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="data.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f4f4;
    }

    /* Premium Header */
    .topbar {
      background: #0c0c0c;
      padding: 20px 0 25px 0;
      text-align: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.45);
    }
    .topbar img {
      width: 120px;
      filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.45));
    }
    .title {
      margin-top: 10px;
      font-size: 26px;
      font-weight: bold;
      background: linear-gradient(90deg,#ffd65a,#ffb300);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 8px rgba(0,0,0,0.4);
    }

    /* Card */
    .card {
      background: #fff;
      padding: 20px;
      max-width: 800px;
      margin: 20px auto;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      margin-top: 4px;
    }

    textarea { height: 80px; }

    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      margin-top: 12px;
      border: none;
      cursor: pointer;
      color: white;
    }

    .btn-blue { background: #007bff; }
    .btn-red { background: #c40000; }

    #formCard { display: none; }

    .section-title {
      margin-top: 18px;
      font-weight: bold;
      font-size: 17px;
      border-left: 4px solid #ffb300;
      padding-left: 10px;
    }

    img.preview {
      width: 100%;
      display: none;
      margin-top: 10px;
      border-radius: 10px;
      border: 2px solid #444;
    }

  </style>
</head>

<body>

<div class="topbar">
  <img src="logo.png">
  <div class="title">DB Fault Reporting</div>
</div>

<!-- LOGIN BOX -->
<div class="card" id="loginCard">
  <h2>Electrician Login</h2>
  <input type="password" id="loginKey" placeholder="Enter Electrician Password">
  <button class="btn btn-red" onclick="doLogin()">Login</button>
  <div id="loginError" style="color:red;margin-top:10px;"></div>
</div>

<!-- FORM CARD -->
<div class="card" id="formCard">

  <h2>Fault Report</h2>

  <label>Date & Time</label>
  <input type="datetime-local" id="fault_datetime">

  <label>Electrician Name</label>
  <input type="text" id="fault_name">

  <label>Fault Type</label>
  <select id="fault_type">
    <option>Breaker Tripped</option>
    <option>Overload</option>
    <option>Burning Smell</option>
    <option>Phase Failure</option>
    <option>Loose Connection</option>
    <option>Cable Damage</option>
    <option>Short Circuit</option>
    <option>Component Failure</option>
    <option>Other</option>
  </select>

  <label>Description</label>
  <textarea id="fault_desc"></textarea>

  <div class="section-title">Downtime</div>

  <label>Start Time</label>
  <input type="datetime-local" id="fault_start">

  <label>End Time</label>
  <input type="datetime-local" id="fault_end">

  <label>Production Loss</label>
  <select id="fault_loss">
    <option>No</option>
    <option>Yes</option>
  </select>

  <label>If Yes, describe loss</label>
  <textarea id="fault_lossDesc"></textarea>

  <div class="section-title">Additional Questions</div>
  <div id="faultQuestionsContainer">
    <p style="font-size:13px;color:#666;">Loading questions...</p>
  </div>

  <div class="section-title">Photos</div>

  <label>Photo 1</label>
  <input type="file" accept="image/*" capture="environment" onchange="previewPhoto(event,1)">
  <img id="preview1" class="preview">

  <label>Photo 2</label>
  <input type="file" accept="image/*" capture="environment" onchange="previewPhoto(event,2)">
  <img id="preview2" class="preview">

  <label>Photo 3</label>
  <input type="file" accept="image/*" capture="environment" onchange="previewPhoto(event,3)">
  <img id="preview3" class="preview">

  <label>Corrective Actions / Remarks</label>
  <textarea id="fault_comments"></textarea>

  <button class="btn btn-blue" onclick="submitFault()">Submit Fault Report</button>

</div>

<script>
/* -----------------------------
   GET DB ID
------------------------------*/
const params = new URLSearchParams(window.location.search);
const dbId = params.get("id");

/* -----------------------------
   AUTO-LOGIN CHECK
------------------------------*/
const ELECTRICIAN_KEY = "9999";

if (sessionStorage.getItem("electricianLogged") === "true") {
  showForm();
}

function doLogin() {
  const key = document.getElementById("loginKey").value.trim();
  const err = document.getElementById("loginError");

  if (key === ELECTRICIAN_KEY) {
    sessionStorage.setItem("electricianLogged", "true");
    showForm();
  } else {
    err.innerText = "Incorrect password!";
  }
}

function showForm() {
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("formCard").style.display = "block";

  const now = new Date();
  document.getElementById("fault_datetime").value = now.toISOString().slice(0,16);
}

/* -----------------------------
   PREVIEW PHOTOS
------------------------------*/
let photo1 = null, photo2 = null, photo3 = null;

function previewPhoto(event, num) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const img = document.getElementById("preview" + num);
    img.src = e.target.result;
    img.style.display = "block";

    if (num === 1) photo1 = e.target.result;
    if (num === 2) photo2 = e.target.result;
    if (num === 3) photo3 = e.target.result;
  };

  reader.readAsDataURL(file);
}

/* -----------------------------
   LOAD DYNAMIC QUESTIONS
------------------------------*/
let questionsGlobal = {};

firebase.database().ref("questions").on("value", snap => {
  questionsGlobal = snap.val() || {};
  renderFaultQuestions();
});

function renderFaultQuestions() {
  const container = document.getElementById("faultQuestionsContainer");
  const list = Object.entries(questionsGlobal)
    .filter(([id,q]) => q.applyFault && q.active !== false);

  if (!list.length) {
    container.innerHTML = "<p style='font-size:13px;color:#666;'>No additional questions.</p>";
    return;
  }

  let html = "";
  list.forEach(([id,q]) => { html += renderQ(id,q); });
  container.innerHTML = html;
}

function renderQ(id,q) {
  const fieldId = `q_fault_${id}`;
  let field = "";

  if (q.type === "text")
    field = `<input type="text" id="${fieldId}">`;

  else if (q.type === "number")
    field = `<input type="number" id="${fieldId}" style="max-width:160px;">`;

  else if (q.type === "yesno")
    field = `<select id="${fieldId}">
               <option></option>
               <option>Yes</option>
               <option>No</option>
             </select>`;

  else if (q.type === "dropdown")
    field = `<select id="${fieldId}">
               <option></option>
               ${q.options.map(o => `<option>${o}</option>`).join("")}
             </select>`;

  return `<label>${q.text}</label>${field}`;
}

function collectDynamicFault() {
  const output = {};
  Object.entries(questionsGlobal).forEach(([id,q]) => {
    if (!q.applyFault || q.active === false) return;
    const inp = document.getElementById(`q_fault_${id}`);
    if (!inp) return;
    const val = inp.value.trim();
    if (val) output[id] = val;
  });
  return Object.keys(output).length ? output : null;
}

/* -----------------------------
   SUBMIT FAULT REPORT
------------------------------*/
function submitFault() {
  const name = document.getElementById("fault_name").value.trim();
  if (!name) return alert("Enter electrician name.");

  const start = document.getElementById("fault_start").value;
  const end = document.getElementById("fault_end").value;

  let downtime = "";
  if (start && end) {
    const diff = (new Date(end) - new Date(start)) / 60000;
    downtime = diff > 0 ? Math.round(diff) : "";
  }

  const data = {
    timestamp: new Date().toISOString(),
    datetimeLocal: document.getElementById("fault_datetime").value,

    dbId: dbId,
    electricianName: name,
    faultType: document.getElementById("fault_type").value,
    description: document.getElementById("fault_desc").value,

    startTime: start,
    endTime: end,
    downtimeMinutes: downtime,

    productionLoss: document.getElementById("fault_loss").value,
    productionLossDesc: document.getElementById("fault_lossDesc").value,

    extraAnswers: collectDynamicFault(),

    photo1, photo2, photo3,

    comments: document.getElementById("fault_comments").value
  };

  saveFault(dbId, data, () => {
    alert("Fault Report Submitted.");
    window.location.href = "panel.html?id=" + encodeURIComponent(dbId);
  });
}
</script>

</body>
</html>
