<!DOCTYPE html>
<html>
<head>
<title>Report Fault</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="data.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f4f7;
    margin: 0;
}
.header {
    background: #c40000;
    color: white;
    padding: 18px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
}
.card {
    background: white;
    margin: 20px auto;
    padding: 20px;
    max-width: 700px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
label {
    font-weight: bold;
    margin-top: 15px;
    display: block;
}
select, input, textarea {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    font-size: 16px;
}
textarea {
    height: 100px;
}
button {
    padding: 12px;
    border: none;
    border-radius: 6px;
    margin-top: 20px;
    font-size: 18px;
    cursor: pointer;
    background: #c40000;
    color: white;
}
.photo-preview {
    width: 100%;
    max-height: 180px;
    margin-top: 10px;
    border-radius: 6px;
    display: none;
}
.section-title {
    font-size: 18px;
    margin-top: 15px;
    margin-bottom: 5px;
    font-weight: bold;
}
</style>
</head>

<body>

<div class="header">
    Report Fault â€“ DB: <span id="dbIdHeader"></span>
</div>

<div class="card">

    <label>Electrician Name</label>
    <input type="text" id="elecName" placeholder="Enter your name">

    <label>Fault Type</label>
    <select id="faultType">
        <option value="">Select...</option>
        <option value="Tripped breaker">Tripped breaker</option>
        <option value="Burnt smell">Burnt smell</option>
        <option value="Overheating">Overheating</option>
        <option value="Loose connection">Loose connection</option>
        <option value="Damaged cable">Damaged cable</option>
        <option value="Water leak">Water leak</option>
        <option value="Other">Other</option>
    </select>

    <label>Fault Description</label>
    <textarea id="desc" placeholder="Describe the fault in detail"></textarea>

    <label>Start Date & Time</label>
    <input type="datetime-local" id="startTime">

    <label>End Date & Time</label>
    <input type="datetime-local" id="endTime">

    <label>Production Loss?</label>
    <select id="prodLoss" onchange="toggleLossDesc()">
        <option value="">Select...</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
    </select>

    <div id="lossDescBox" style="display:none;">
        <label>Production Loss Description</label>
        <textarea id="lossDesc" placeholder="Details about production loss"></textarea>
    </div>

    <div class="section-title">Extra Fault Questions</div>
    <div id="faultExtraQuestions"></div>

    <label>Upload Photos (up to 3)</label>
    <input type="file" accept="image/*" onchange="previewPhoto(this, 'p1', 1)">
    <img id="p1" class="photo-preview">

    <input type="file" accept="image/*" onchange="previewPhoto(this, 'p2', 2)">
    <img id="p2" class="photo-preview">

    <input type="file" accept="image/*" onchange="previewPhoto(this, 'p3', 3)">
    <img id="p3" class="photo-preview">

    <button onclick="saveFault()">Submit Fault</button>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const dbId = params.get("id");

document.getElementById("dbIdHeader").innerText = dbId;

let photo1 = null, photo2 = null, photo3 = null;
let faultQuestions = {};

function toggleLossDesc() {
    document.getElementById("lossDescBox").style.display =
        document.getElementById("prodLoss").value === "Yes"
        ? "block" : "none";
}

function previewPhoto(input, previewId, index) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
        document.getElementById(previewId).src = e.target.result;
        document.getElementById(previewId).style.display = "block";

        if (index === 1) photo1 = e.target.result;
        if (index === 2) photo2 = e.target.result;
        if (index === 3) photo3 = e.target.result;
    };
    reader.readAsDataURL(file);
}

/* DYNAMIC FAULT QUESTIONS */
function loadFaultQuestions() {
  firebase.database().ref("questions").once("value", snap => {
    faultQuestions = snap.val() || {};
    renderFaultQuestions();
  });
}

function renderFaultQuestions() {
  const container = document.getElementById("faultExtraQuestions");
  if (!container) return;

  const entries = Object.entries(faultQuestions)
    .filter(([id, q]) => q.applyFault && q.active !== false);

  if (!entries.length) {
    container.innerHTML = "<p style='font-size:13px;color:#666;'>No extra fault questions defined.</p>";
    return;
  }

  let html = "";
  entries.forEach(([id, q]) => {
    html += renderFaultQuestionField(id, q);
  });
  container.innerHTML = html;
}

function renderFaultQuestionField(id, q) {
  const baseId = `q_fault_${id}`;
  let fieldHtml = "";

  if (q.type === "text") {
    fieldHtml = `<input type="text" id="${baseId}" style="width:100%;">`;
  } else if (q.type === "number") {
    fieldHtml = `<input type="number" id="${baseId}" style="width:150px;">`;
  } else if (q.type === "yesno") {
    fieldHtml = `
      <select id="${baseId}">
        <option value=""></option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    `;
  } else if (q.type === "dropdown") {
    const opts = (q.options || []);
    const optionsHtml = ['<option value=""></option>']
      .concat(opts.map(o => `<option value="${o}">${o}</option>`))
      .join("");
    fieldHtml = `<select id="${baseId}">${optionsHtml}</select>`;
  } else {
    fieldHtml = `<input type="text" id="${baseId}" style="width:100%;">`;
  }

  return `
    <div style="margin-top:10px;">
      <label style="font-weight:bold;">${q.text}</label><br>
      ${fieldHtml}
    </div>
  `;
}

function collectFaultExtras() {
  const result = {};
  Object.entries(faultQuestions).forEach(([id, q]) => {
    if (!q.applyFault || q.active === false) return;
    const input = document.getElementById(`q_fault_${id}`);
    if (!input) return;
    const val = (input.value || "").toString().trim();
    if (val) result[id] = val;
  });
  return Object.keys(result).length ? result : null;
}

function saveFault() {
    const name = document.getElementById("elecName").value;
    const faultTypeVal = document.getElementById("faultType").value;
    const descVal = document.getElementById("desc").value;
    const start = document.getElementById("startTime").value;
    const end = document.getElementById("endTime").value;
    const prodLossVal = document.getElementById("prodLoss").value;
    const lossDescVal = document.getElementById("lossDesc").value || "";

    if (!name || !faultTypeVal || !start || !end) {
        alert("Please fill required fields (Name, Fault Type, Start & End Time).");
        return;
    }

    let downMinutes = null;
    try {
        const startDate = new Date(start);
        const endDate = new Date(end);
        downMinutes = Math.floor((endDate - startDate) / (1000 * 60));
        if (downMinutes < 0) downMinutes = 0;
    } catch (err) {
        downMinutes = null;
    }

    const data = {
        dbId,
        electricianName: name,
        faultType: faultTypeVal,
        description: descVal,
        startTime: start,
        endTime: end,
        productionLoss: prodLossVal,
        productionLossDesc: prodLossVal === "Yes" ? lossDescVal : "",
        downtimeMinutes: downMinutes,
        photo1,
        photo2,
        photo3,
        extraAnswers: collectFaultExtras(),
        timestamp: new Date().toISOString()
    };

    firebase.database()
        .ref("faults/" + dbId)
        .push(data, err => {
            if (err) alert("Error: " + err);
            else alert("Fault Report Submitted Successfully.");
        });
}

loadFaultQuestions();
</script>

</body>
</html>
