<!DOCTYPE html>
<html>
<head>
  <title>Fault Report â€“ Electrical Panel</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="data.js"></script>

  <style>
    body { font-family: Arial; margin:0; background:#f4f4f4; }

    .topbar {
      background:#0c0c0c;
      padding:20px 0 25px 0;
      text-align:center;
      box-shadow:0 3px 8px rgba(0,0,0,0.45);
    }

    .topbar img { width:120px; }

    .title {
      margin-top:10px;
      font-size:26px;
      font-weight:bold;
      background:linear-gradient(90deg,#ffd65a,#ffb300);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .card {
      background:#fff;
      padding:20px;
      max-width:800px;
      margin:20px auto;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }

    label { display:block; margin-top:10px; font-weight:bold; }

    input, select, textarea {
      width:100%;
      padding:10px;
      border-radius:6px;
      border:1px solid #ccc;
      margin-top:4px;
    }

    textarea { height:80px; }

    .btn {
      width:100%;
      padding:12px;
      border-radius:8px;
      font-size:16px;
      font-weight:bold;
      margin-top:12px;
      border:none;
      cursor:pointer;
      color:white;
      background:#007bff;
    }

    img.preview {
      width:100%;
      display:none;
      margin-top:10px;
      border-radius:10px;
      border:2px solid #444;
    }

    #formCard { display:none; }
  </style>
</head>

<body>

<div class="topbar">
  <img src="logo.png">
  <div class="title">DB Fault Reporting</div>
</div>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h2>Electrician Login</h2>
  <input type="password" id="loginKey" placeholder="Enter Electrician Password">
  <button class="btn" onclick="doLogin()">Login</button>
  <div id="loginError" style="color:red;margin-top:10px;"></div>
</div>

<!-- FORM -->
<div class="card" id="formCard">

  <h2>Fault Report</h2>

  <label>Date & Time</label>
  <input type="datetime-local" id="fault_datetime">

  <label>Electrician Name</label>
  <input type="text" id="fault_name">

  <label>Fault Type</label>
  <select id="fault_type">
    <option>Breaker Tripped</option>
    <option>Overload</option>
    <option>Burning Smell</option>
    <option>Phase Failure</option>
    <option>Loose Connection</option>
    <option>Cable Damage</option>
    <option>Short Circuit</option>
    <option>Component Failure</option>
    <option>Other</option>
  </select>

  <label>Description</label>
  <textarea id="fault_desc"></textarea>

  <label>Start Time</label>
  <input type="datetime-local" id="fault_start">

  <label>End Time</label>
  <input type="datetime-local" id="fault_end">

  <label>Production Loss</label>
  <select id="fault_loss">
    <option>No</option>
    <option>Yes</option>
  </select>

  <label>If Yes, describe loss</label>
  <textarea id="fault_lossDesc"></textarea>

  <div id="faultQuestionsContainer"></div>

  <label>Photo 1</label>
  <input type="file" accept="image/*" onchange="previewPhoto(event,1)">
  <img id="preview1" class="preview">

  <label>Photo 2</label>
  <input type="file" accept="image/*" onchange="previewPhoto(event,2)">
  <img id="preview2" class="preview">

  <label>Photo 3</label>
  <input type="file" accept="image/*" onchange="previewPhoto(event,3)">
  <img id="preview3" class="preview">

  <label>Corrective Actions</label>
  <textarea id="fault_comments"></textarea>

  <button class="btn" onclick="submitFault()">Submit Fault Report</button>

</div>

<script>

/* ---------------- GET PARAMETERS ---------------- */
const params = new URLSearchParams(window.location.search);
const dbId = params.get("id");
const safetyKey = params.get("safetyKey");
/* CHECK SAFETY SCORE BEFORE ALLOWING FAULT */

if (safetyKey && dbId) {

  firebase.database()
    .ref("safetyDeclarations/" + dbId + "/" + safetyKey)
    .once("value")
    .then(snap => {

      const safetyData = snap.val();

      if (!safetyData) {
        alert("Safety record not found!");
        window.location.href = "panel.html?id=" + dbId;
        return;
      }

      if ((safetyData.checklistScore || 0) < 3) {
        alert("Safety Score is below minimum requirement (3/5). Fault reporting blocked.");
        window.location.href = "panel.html?id=" + dbId;
        return;
      }

    });
}

/* Block if no safety key */
if (!safetyKey) {
  alert("Safety Declaration Required First!");
  window.location.href = "safety.html?id=" + dbId;
}

/* ---------------- LOGIN ---------------- */
const ELECTRICIAN_KEY = "9999";

if (sessionStorage.getItem("electricianLogged") === "true") {
  showForm();
}

function doLogin() {
  const key = document.getElementById("loginKey").value.trim();
  if (key === ELECTRICIAN_KEY) {
    sessionStorage.setItem("electricianLogged","true");
    showForm();
  } else {
    document.getElementById("loginError").innerText="Incorrect password!";
  }
}

function showForm() {
  document.getElementById("loginCard").style.display="none";
  document.getElementById("formCard").style.display="block";
  document.getElementById("fault_datetime").value =
    new Date().toISOString().slice(0,16);
}

/* ---------------- PHOTO PREVIEW ---------------- */
let photo1=null, photo2=null, photo3=null;

function previewPhoto(e,num){
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=x=>{
    document.getElementById("preview"+num).src=x.target.result;
    document.getElementById("preview"+num).style.display="block";
    if(num===1) photo1=x.target.result;
    if(num===2) photo2=x.target.result;
    if(num===3) photo3=x.target.result;
  };
  reader.readAsDataURL(file);
}

/* ---------------- SUBMIT FAULT ---------------- */
function submitFault(){

  const name=document.getElementById("fault_name").value.trim();
  if(!name) return alert("Enter electrician name.");

  const start=document.getElementById("fault_start").value;
  const end=document.getElementById("fault_end").value;

  let downtime="";
  if(start && end){
    const diff=(new Date(end)-new Date(start))/60000;
    downtime=diff>0?Math.round(diff):"";
  }

  const data={
    timestamp:new Date().toISOString(),
    datetimeLocal:document.getElementById("fault_datetime").value,
    dbId,
    electricianName:name,
    faultType:document.getElementById("fault_type").value,
    description:document.getElementById("fault_desc").value,
    startTime:start,
    endTime:end,
    downtimeMinutes:downtime,
    productionLoss:document.getElementById("fault_loss").value,
    productionLossDesc:document.getElementById("fault_lossDesc").value,
    photo1,photo2,photo3,
    comments:document.getElementById("fault_comments").value
  };

  const faultRef=firebase.database()
      .ref("faults/"+dbId)
      .push();

  faultRef.set(data,function(){

    const faultKey=faultRef.key;

    firebase.database()
      .ref("safetyDeclarations/"+dbId+"/"+safetyKey)
      .update({
        status:"CLOSED",
        closedAt:new Date().toISOString(),
        faultRef:faultKey
      });

    alert("Fault Report Submitted Successfully!");
    window.location.href="panel.html?id="+encodeURIComponent(dbId);
  });
}

</script>

</body>
</html>
