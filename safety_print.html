<!DOCTYPE html>
<html>
<head>
  <title>Safety Declaration Report</title>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="data.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f4f4f4;
    }

    h1 {
      text-align: center;
      color: #f0b429;
      margin-bottom: 5px;
    }

    h3 {
      text-align: center;
      margin-top: 0;
      font-weight: normal;
      color: #555;
    }

    .section-title {
      background: #111;
      color: #f0b429;
      padding: 12px;
      font-size: 18px;
      margin-top: 30px;
      border-radius: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
    }

    td {
      border: 1px solid #ccc;
      padding: 10px;
    }

    td.label {
      background: #333;
      color: white;
      font-weight: bold;
      width: 35%;
    }

    img {
      max-width: 400px;
      margin-top: 15px;
      border: 3px solid #333;
      border-radius: 6px;
    }

    .score-low {
      color: red;
      font-weight: bold;
    }

    .score-ok {
      color: green;
      font-weight: bold;
    }

    button {
      margin-top: 25px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    @media print {
      button { display: none; }
      body { background: white; }
    }
  </style>
</head>

<body>

<h1>Safety Declaration Report</h1>
<h3>Chenab Engineering Works</h3>

<div id="reportContent">Loading...</div>

<button onclick="window.print()">Print / Save as PDF</button>

<script>

const params = new URLSearchParams(window.location.search);
const dbId = params.get("db");
const recordKey = params.get("id");

if (!dbId || !recordKey) {
  document.getElementById("reportContent").innerHTML = "Invalid record.";
} else {

  firebase.database()
    .ref("safetyDeclarations/" + dbId + "/" + recordKey)
    .once("value")
    .then(snap => {

      const data = snap.val();

      if (!data) {
        document.getElementById("reportContent").innerHTML = "Record not found.";
        return;
      }

      const openDate = data.timestamp
        ? new Date(data.timestamp).toLocaleString()
        : "";

      const scoreClass = (data.checklistScore || 0) < 3
        ? "score-low"
        : "score-ok";

      document.getElementById("reportContent").innerHTML = `

        <div class="section-title">Basic Information</div>

        <table>
          <tr>
            <td class="label">DB Number</td>
            <td>${dbId}</td>
          </tr>
          <tr>
            <td class="label">Electrician</td>
            <td>${data.electricianName || ""}</td>
          </tr>
          <tr>
            <td class="label">Date Opened</td>
            <td>${openDate}</td>
          </tr>
          <tr>
            <td class="label">Permit No</td>
            <td>${data.permitNo || ""}</td>
          </tr>
        </table>

        <div class="section-title">Safety Checklist</div>

        <table>
          <tr>
            <td class="label">PPE Worn</td>
            <td>${data.ppe || ""}</td>
          </tr>
          <tr>
            <td class="label">Main Isolation</td>
            <td>${data.isolation || ""}</td>
          </tr>
          <tr>
            <td class="label">Voltage Tested</td>
            <td>${data.voltageTest || ""}</td>
          </tr>
          <tr>
            <td class="label">2 Persons Present</td>
            <td>${data.lockout || ""}</td>
          </tr>
          <tr>
            <td class="label">Supervisor Informed</td>
            <td>${data.supervisor || ""}</td>
          </tr>
          <tr>
            <td class="label">Checklist Score</td>
            <td class="${scoreClass}">
              ${data.checklistScore || 0} / 5
            </td>
          </tr>
        </table>

        <div class="section-title">Safety Photo</div>

        ${data.safetyPhoto
          ? `<img src="${data.safetyPhoto}">`
          : `<p>No Photo Uploaded</p>`
        }
      `;
    });
}

</script>

</body>
</html>
