<!DOCTYPE html>
<html>
<head>
  <title>LUX Monitoring Report</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="data.js"></script>

  <style>
    body {
      font-family: "Times New Roman", serif;
      margin: 0;
      background: #f4f4f4;
    }

    .topbar {
      background: #0c0c0c;
      padding: 18px 0 22px 0;
      text-align: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.4);
    }
    .topbar img {
      width: 120px;
    }
    .title {
      margin-top: 10px;
      font-size: 26px;
      font-weight: bold;
      background: linear-gradient(90deg,#ffd65a,#ffb300);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .card {
      background: #fff;
      padding: 20px;
      max-width: 800px;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .btn {
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      width: 100%;
      cursor: pointer;
      margin-top: 12px;
      color: #fff;
    }
    .btn-red { background:#c40000; }

    label {
      display:block;
      margin-top:10px;
      font-weight:bold;
    }

    input, textarea, select {
      width:100%;
      border:none;
      border-bottom:1px solid #000;
      font-size:14px;
      font-family:inherit;
      background:transparent;
    }

    .progressBox {
      display:none;
      margin-top:15px;
      font-weight:bold;
      text-align:center;
    }

    img.preview {
      width:90px;
      height:90px;
      border:1px solid #000;
      margin-top:5px;
      display:none;
      object-fit:contain;
    }
  </style>
</head>

<body>

<div class="topbar">
  <img src="logo.png">
  <div class="title">LUX Monitoring Report</div>
</div>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h2>Electrician Login</h2>
  <input type="password" id="loginKey" placeholder="Enter Electrician Password">
  <button class="btn btn-red" onclick="login()">Login</button>
  <div id="loginError" style="color:red;margin-top:10px;"></div>
</div>

<!-- FORM -->
<div class="card" id="formCard" style="display:none;">
  <h2>LUX Monitoring Form</h2>

  <!-- FIXED INSTRUMENT -->
  <label>Instrument</label>
  <input type="text" value="Lux Meter" disabled>

  <!-- ADMIN AUTO DATA -->
  <label>Lux Meter Model</label>
  <input type="text" id="luxModel" disabled>

  <label>Calibration Certificate No</label>
  <input type="text" id="luxCert" disabled>

  <label>Calibration Date</label>
  <input type="date" id="luxCalDate" disabled>

  <label>Department / Location</label>
  <input type="text" id="lx_location">

  <label>Date</label>
  <input type="date" id="lx_date">

  <label>Electrician Name</label>
  <input type="text" id="lx_name">

  <label>Lux Value</label>
  <input type="number" id="lx_value">

  <label>Photo</label>
  <input type="file" accept="image/*" onchange="compressImage(event)">
  <img id="preview1" class="preview">

  <button class="btn btn-red" onclick="submitLux()">Submit</button>

  <div class="progressBox" id="progressBox">Uploading: <span id="progressVal">0</span>%</div>
</div>

<script>
/* LOGIN */
const KEY = "9999";

function login(){
  if(document.getElementById("loginKey").value === KEY){
    document.getElementById("loginCard").style.display="none";
    document.getElementById("formCard").style.display="block";
    loadLuxConfig(loadAdminLux);
  } else {
    document.getElementById("loginError").innerText="Incorrect password";
  }
}

/* LOAD ADMIN CONFIG */
function loadAdminLux(cfg){
  if(!cfg) return;
  document.getElementById("luxModel").value = cfg.model || "";
  document.getElementById("luxCert").value = cfg.certificate || "";
  document.getElementById("luxCalDate").value = cfg.calibrationDate || "";
}

/* IMAGE COMPRESSION */
let compressedImage=null;

function compressImage(e){
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=x=>{
    const i=new Image();
    i.src=x.target.result;
    i.onload=()=>{
      const c=document.createElement("canvas");
      const max=800;
      const s=max/i.width;
      c.width=max;
      c.height=i.height*s;
      c.getContext("2d").drawImage(i,0,0,c.width,c.height);
      compressedImage=c.toDataURL("image/jpeg",0.7);
      document.getElementById("preview1").src=compressedImage;
      document.getElementById("preview1").style.display="block";
    }
  };
  r.readAsDataURL(f);
}

/* SUBMIT WITH PROGRESS */
function submitLux(){
  const box=document.getElementById("progressBox");
  const val=document.getElementById("progressVal");
  box.style.display="block";
  let p=0;
  const timer=setInterval(()=>{
    p+=10; val.innerText=p;
    if(p>=90) clearInterval(timer);
  },200);

  const data={
    instrument:"Lux Meter",
    model:luxModel.value,
    certificate:luxCert.value,
    calibrationDate:luxCalDate.value,
    location:lx_location.value,
    date:lx_date.value,
    electrician:lx_name.value,
    luxValue:lx_value.value,
    photo:compressedImage,
    timestamp:new Date().toISOString()
  };

  saveLuxReport(data,()=>{
    val.innerText=100;
    setTimeout(()=>alert("LUX Report Submitted"),300);
  });
}
</script>

</body>
</html>
