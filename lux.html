<!DOCTYPE html>
<html>
<head>
  <title>LUX Monitoring Report</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="data.js"></script>

  <style>
    body {
      font-family: "Times New Roman", serif;
      margin: 0;
      background: #f4f4f4;
    }

    .topbar {
      background: #0c0c0c;
      padding: 18px 0 22px 0;
      text-align: center;
      box-shadow: 0 3px 8px rgba(0,0,0,0.4);
    }
    .topbar img {
      width: 120px;
    }
    .title {
      margin-top: 10px;
      font-size: 26px;
      font-weight: bold;
      background: linear-gradient(90deg,#ffd65a,#ffb300);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .card {
      background: #fff;
      padding: 20px;
      max-width: 800px;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .btn {
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      width: 100%;
      cursor: pointer;
      margin-top: 12px;
      color: #fff;
    }
    .btn-red { background:#c40000; }

    #formArea { display:none; }

    .page {
      width: 210mm;
      min-height: 297mm;
      padding: 20mm;
      margin: 20px auto;
      border: 1px solid #000;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    td, th {
      border: 1px solid #000;
      padding: 4px;
    }
    .no-border td { border:none; }

    input, textarea {
      width: 100%;
      border: none;
      border-bottom: 1px solid #000;
      background: transparent;
    }

    .picture-preview {
      width: 90px;
      height: 90px;
      border: 1px solid #000;
      object-fit: contain;
    }

    .actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    #submitStatus {
      margin-top:10px;
      font-weight:bold;
      display:none;
    }

    @media print {
      .no-print { display:none; }
      .page { border:none; margin:0; }
    }
  </style>
</head>

<body>

<div class="topbar">
  <img src="logo.png">
  <div class="title">LUX Monitoring Report – Electrician</div>
</div>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h2>LUX Monitoring – Login</h2>
  <input type="password" id="loginKey" placeholder="Enter Electrician Password">
  <button class="btn btn-red" onclick="doLogin()">Login</button>
  <div id="loginError" style="color:red;"></div>
</div>

<!-- FORM -->
<div id="formArea">
  <div class="page">
    <form id="luxForm">

      <h2 style="text-align:center;">LUX MONITORING REPORT</h2>

      <table>
        <tr>
          <th>S.N</th>
          <th>Measurement Point</th>
          <th>Limit Lux</th>
          <th>Measured Lux</th>
          <th>Remarks</th>
          <th>Picture</th>
        </tr>

        <tr>
          <td>1</td>
          <td><input id="point1"></td>
          <td><input id="limit1"></td>
          <td><input id="measured1"></td>
          <td><input id="remarks1"></td>
          <td>
            <img id="preview1" class="picture-preview">
            <input type="file" id="file1" accept="image/*" class="no-print">
          </td>
        </tr>

        <tr>
          <td>2</td>
          <td><input id="point2"></td>
          <td><input id="limit2"></td>
          <td><input id="measured2"></td>
          <td><input id="remarks2"></td>
          <td>
            <img id="preview2" class="picture-preview">
            <input type="file" id="file2" accept="image/*" class="no-print">
          </td>
        </tr>

        <tr>
          <td>3</td>
          <td><input id="point3"></td>
          <td><input id="limit3"></td>
          <td><input id="measured3"></td>
          <td><input id="remarks3"></td>
          <td>
            <img id="preview3" class="picture-preview">
            <input type="file" id="file3" accept="image/*" class="no-print">
          </td>
        </tr>

        <tr>
          <td>4</td>
          <td><input id="point4"></td>
          <td><input id="limit4"></td>
          <td><input id="measured4"></td>
          <td><input id="remarks4"></td>
          <td>
            <img id="preview4" class="picture-preview">
            <input type="file" id="file4" accept="image/*" class="no-print">
          </td>
        </tr>
      </table>

      <div class="actions no-print">
        <button type="submit">Submit LUX Report</button>
        <button type="button" onclick="location.reload()">Clear</button>
      </div>

      <div id="submitStatus">⏳ Submitting… <span id="submitProgress">0%</span></div>

    </form>
  </div>
</div>

<script>
const ELECTRICIAN_KEY = "9999";

if (sessionStorage.getItem("electricianLogged") === "true") showForm();

function doLogin() {
  if (loginKey.value === ELECTRICIAN_KEY) {
    sessionStorage.setItem("electricianLogged","true");
    showForm();
  } else loginError.innerText = "Incorrect password";
}

function showForm() {
  loginCard.style.display="none";
  formArea.style.display="block";
}

/* Preview */
["1","2","3","4"].forEach(i=>{
  document.getElementById("file"+i).addEventListener("change",e=>{
    const r=new FileReader();
    r.onload=ev=>preview(i).src=ev.target.result;
    r.readAsDataURL(e.target.files[0]);
  });
});

/* Compression */
function fileToCompressedBase64(id){
  return new Promise(res=>{
    const f=document.getElementById(id).files[0];
    if(!f){res(null);return;}
    const img=new Image(), r=new FileReader();
    r.onload=e=>{
      img.onload=()=>{
        const c=document.createElement("canvas");
        const s=Math.min(1,800/img.width);
        c.width=img.width*s;
        c.height=img.height*s;
        c.getContext("2d").drawImage(img,0,0,c.width,c.height);
        res(c.toDataURL("image/jpeg",0.6));
      };
      img.src=e.target.result;
    };
    r.readAsDataURL(f);
  });
}

/* Submit */
luxForm.addEventListener("submit",async e=>{
  e.preventDefault();
  submitStatus.style.display="block";
  submitProgress.innerText="10%";

  const measurements=[];
  for(let i=1;i<=4;i++){
    const img=await fileToCompressedBase64("file"+i);
    submitProgress.innerText=Math.round((i/4)*70)+"%";
    if(point(i).value||img){
      measurements.push({
        sn:i,
        point:point(i).value,
        limitLux:limit(i).value,
        measuredLux:measured(i).value,
        remarks:remarks(i).value,
        image:img
      });
    }
  }

  saveLuxReport({timestamp:new Date().toISOString(),measurements},()=>{
    submitProgress.innerText="100%";
    submitStatus.innerText="✅ Submitted Successfully";
    setTimeout(()=>location.reload(),800);
  });
});

function point(i){return document.getElementById("point"+i);}
function limit(i){return document.getElementById("limit"+i);}
function measured(i){return document.getElementById("measured"+i);}
function remarks(i){return document.getElementById("remarks"+i);}
function preview(i){return document.getElementById("preview"+i);}
</script>

</body>
</html>
