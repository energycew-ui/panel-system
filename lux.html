<!DOCTYPE html>
<html>
<head>
  <title>LUX Monitoring Report</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="data.js"></script>

  <style>
    body { font-family: "Times New Roman"; background:#f4f4f4; margin:0; }
    .topbar { background:#0c0c0c; padding:18px; text-align:center; }
    .title { color:#ffc107; font-size:26px; font-weight:bold; }
    .card { background:#fff; max-width:800px; margin:20px auto; padding:20px; border-radius:10px; }
    .btn { background:#c40000; color:#fff; padding:12px; border:none; width:100%; font-size:16px; cursor:pointer; }
    #formArea { display:none; }
    .page { width:210mm; padding:20mm; background:#fff; margin:auto; border:1px solid #000; }
    table { width:100%; border-collapse:collapse; }
    td, th { border:1px solid #000; padding:5px; }
    input, textarea { width:100%; border:none; border-bottom:1px solid #000; }
    .picture-preview { width:80px; height:80px; border:1px solid #000; display:block; margin:auto; }
    .actions { margin-top:10px; }
    #progressBox { display:none; margin-top:10px; font-weight:bold; }
  </style>
</head>

<body>

<div class="topbar">
  <div class="title">LUX Monitoring Report – Electrician</div>
</div>

<div class="card" id="loginCard">
  <h3>Electrician Login</h3>
  <input type="password" id="loginKey" placeholder="Password">
  <button class="btn" onclick="doLogin()">Login</button>
</div>

<div id="formArea">
  <div class="page">
    <form id="luxForm">

      <h2 style="text-align:center;">LUX MONITORING REPORT</h2>

      <table>
        <tr><td>Sampling Location</td><td><input id="samplingLocation"></td></tr>
        <tr><td>Collected By</td><td><input id="collectedBy"></td></tr>
      </table>

      <br>

      <table>
        <tr>
          <th>SN</th><th>Point</th><th>Limit</th><th>Measured</th><th>Remarks</th><th>Image</th>
        </tr>

        <script>
          for(let i=1;i<=4;i++){
            document.write(`
            <tr>
              <td>${i}</td>
              <td><input id="point${i}"></td>
              <td><input id="limit${i}"></td>
              <td><input id="measured${i}"></td>
              <td><input id="remarks${i}"></td>
              <td>
                <img id="preview${i}" class="picture-preview">
                <input type="file" id="file${i}">
              </td>
            </tr>`);
          }
        </script>
      </table>

      <div id="progressBox">Submitting… <span id="progressText">0%</span></div>

      <div class="actions">
        <button type="submit" class="btn">Submit LUX Report</button>
      </div>

    </form>
  </div>
</div>

<script>
const ELECTRICIAN_KEY = "9999";

function doLogin(){
  if(document.getElementById("loginKey").value === ELECTRICIAN_KEY){
    sessionStorage.setItem("electricianLogged","true");
    showForm();
  } else alert("Wrong Password");
}

if(sessionStorage.getItem("electricianLogged")==="true") showForm();
function showForm(){
  loginCard.style.display="none";
  formArea.style.display="block";
}

/* IMAGE COMPRESSION */
function compressImage(file){
  return new Promise(res=>{
    const img=new Image(), r=new FileReader();
    r.onload=e=>{
      img.onload=()=>{
        const c=document.createElement("canvas");
        const s=Math.min(800/img.width,1);
        c.width=img.width*s; c.height=img.height*s;
        c.getContext("2d").drawImage(img,0,0,c.width,c.height);
        res(c.toDataURL("image/jpeg",0.6));
      };
      img.src=e.target.result;
    };
    r.readAsDataURL(file);
  });
}

/* SUBMIT */
luxForm.onsubmit = async e => {
  e.preventDefault();
  const btn = luxForm.querySelector("button");
  btn.disabled=true;
  const progress=document.getElementById("progressText");
  progressBox.style.display="block";

  let data=[], done=0;
  for(let i=1;i<=4;i++){
    let img=null;
    if(file${i}.files.length) img=await compressImage(file${i}.files[0]);
    data.push({
      point:point${i}.value,
      limit:limit${i}.value,
      measured:measured${i}.value,
      remarks:remarks${i}.value,
      image:img
    });
    done++; progress.innerText=Math.round(done/4*100)+"%";
  }

  saveLuxReport({
    timestamp:new Date().toISOString(),
    samplingLocation:samplingLocation.value,
    collectedBy:collectedBy.value,
    measurements:data
  },()=>{ alert("Submitted"); location.reload(); });
};
</script>

</body>
</html>
