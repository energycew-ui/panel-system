<!DOCTYPE html>
<html>
<head>
  <title>DB Inspection Report</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="data.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; }
    .topbar { background:#0c0c0c; padding:18px 0 22px; text-align:center; box-shadow:0 3px 8px rgba(0,0,0,0.4); }
    .topbar img { width:120px; }
    .title { margin-top:10px; font-size:26px; font-weight:bold;
      background:linear-gradient(90deg,#ffd65a,#ffb300);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .card { background:#fff; padding:20px; max-width:800px; margin:20px auto;
      border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.15); }
    label { display:block; margin-top:10px; font-weight:bold; }
    input,select,textarea { width:100%; padding:10px; margin-top:4px;
      border:1px solid #ccc; border-radius:6px; box-sizing:border-box; }
    textarea { height:80px; }
    .btn { padding:12px; border-radius:8px; margin-top:12px;
      cursor:pointer; width:100%; border:none; color:#fff; font-size:17px; font-weight:bold; }
    .btn-red{background:#c40000;} .btn-blue{background:#007bff;}
    #formArea{display:none;}
    .section-title{margin-top:18px; font-weight:bold; border-left:4px solid #ffb300; padding-left:8px;}
    img{width:100%; display:none; margin-top:10px; border-radius:10px; border:2px solid #444;}
  </style>
</head>

<body>

<div class="topbar">
  <img src="logo.png">
  <div class="title">DB Inspection â€“ Electrician</div>
</div>

<div class="card" id="loginCard">
  <h2>Electrician Login</h2>
  <input type="password" id="loginKey" placeholder="Enter Electrician Password">
  <button class="btn btn-red" onclick="doLogin()">Login</button>
  <div id="loginError" style="color:red;margin-top:10px;"></div>
</div>

<div class="card" id="formArea">

  <h2>Inspection Form</h2>

  <label>Date & Time</label>
  <input type="datetime-local" id="insp_datetime">

  <label>Electrician Name</label>
  <input type="text" id="insp_name">

  <div class="section-title">Panel Condition</div>

  <label>Main Breaker Condition</label>
  <select id="insp_breaker">
    <option>OK</option><option>Loose</option>
    <option>Heating</option><option>Damaged</option>
    <option>Needs Repair</option>
  </select>

  <label>Cleanliness</label>
  <select id="insp_clean">
    <option>Clean</option><option>Dusty</option>
    <option>Needs Cleaning</option><option>Not Accessible</option>
  </select>

  <label>Door & Locking</label>
  <select id="insp_lock">
    <option>Locked</option><option>Unlocked</option>
    <option>Broken</option><option>Not Lockable</option>
  </select>

  <label>Cable & Wiring Condition</label>
  <select id="insp_wiring">
    <option>Good</option><option>Loose Wires</option>
    <option>Damaged</option><option>Burn Marks</option>
  </select>

  <label>Earthing Status</label>
  <select id="insp_earth">
    <option>OK</option><option>Weak</option>
    <option>Broken</option><option>Not Connected</option>
  </select>

  <label>Signs of Overheating</label>
  <select id="insp_heat">
    <option>No</option><option>Yes (Action Required)</option>
  </select>

  <label>Unusual Noise / Vibration</label>
  <select id="insp_noise">
    <option>No</option><option>Yes</option>
  </select>

  <label>Burning Smell</label>
  <select id="insp_smell">
    <option>No</option><option>Yes</option>
  </select>

  <div class="section-title">Photos</div>

  <label>Photo 1</label>
  <input type="file" accept="image/*" onchange="showPhoto(event,1)">
  <img id="preview1">

  <label>Photo 2</label>
  <input type="file" accept="image/*" onchange="showPhoto(event,2)">
  <img id="preview2">

  <label>Photo 3</label>
  <input type="file" accept="image/*" onchange="showPhoto(event,3)">
  <img id="preview3">

  <label>Comments</label>
  <textarea id="insp_comments"></textarea>

  <button class="btn btn-blue" onclick="submitInspection()">Submit Report</button>

</div>

<script>

const ELECTRICIAN_KEY="9999";
const url=new URLSearchParams(window.location.search);
const dbId=url.get("id");

if(sessionStorage.getItem("electricianLogged")==="true"){showForm();}

function doLogin(){
  const key=document.getElementById("loginKey").value.trim();
  if(key===ELECTRICIAN_KEY){
    sessionStorage.setItem("electricianLogged","true");
    showForm();
  }else{
    document.getElementById("loginError").innerText="Incorrect password!";
  }
}

function showForm(){
  document.getElementById("loginCard").style.display="none";
  document.getElementById("formArea").style.display="block";
  const now=new Date();
  document.getElementById("insp_datetime").value=now.toISOString().slice(0,16);
}

let photo1=null,photo2=null,photo3=null;

function showPhoto(e,num){
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=x=>{
    if(num===1){photo1=x.target.result;preview1.src=photo1;preview1.style.display="block";}
    if(num===2){photo2=x.target.result;preview2.src=photo2;preview2.style.display="block";}
    if(num===3){photo3=x.target.result;preview3.src=photo3;preview3.style.display="block";}
  };
  reader.readAsDataURL(file);
}

function submitInspection(){

  const name=document.getElementById("insp_name").value.trim();
  if(!name){alert("Enter electrician name.");return;}

  const data={
    timestamp:new Date().toISOString(),
    datetimeLocal:document.getElementById("insp_datetime").value,
    electricianName:name,
    breakerStatus:insp_breaker.value,
    cleanStatus:insp_clean.value,
    lockedStatus:insp_lock.value,
    wiringStatus:insp_wiring.value,
    earthStatus:insp_earth.value,
    heatIssue:insp_heat.value,
    noiseIssue:insp_noise.value,
    smellIssue:insp_smell.value,
    photo1,photo2,photo3,
    comments:insp_comments.value
  };

  saveInspection(dbId,data,()=>{

    // -------- UPDATE NEXT INSPECTION DATE --------

    const today=new Date();
    const nextDue=new Date();
    nextDue.setDate(today.getDate()+15);

    firebase.database()
      .ref("panels/"+dbId)
      .update({
        lastInspection:today.toISOString(),
        nextInspectionDue:nextDue.toISOString()
      })
      .then(()=>{

        alert("Inspection submitted successfully.");
        window.location.href="panel.html?id="+encodeURIComponent(dbId);

      });

  });

}

</script>

</body>
</html>
