<!DOCTYPE html>
<html>
<head>
<title>Electrician Panel</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Firebase helper -->
<script src="data.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f2f4f7;
    margin: 0;
}
.header {
    background: #111;
    color: #ffc800;
    padding: 20px;
    text-align: center;
    font-size: 24px;
    font-weight: bold;
}
.card {
    background: white;
    margin: 20px auto;
    padding: 20px;
    max-width: 800px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
.section-title {
    font-size: 18px;
    margin-top: 10px;
    margin-bottom: 5px;
    font-weight: bold;
}
.summary-item {
    margin: 4px 0;
}
label {
    display: block;
    margin-top: 12px;
    font-weight: bold;
}
input[type="text"], select, textarea {
    width: 100%;
    padding: 8px;
    font-size: 16px;
    margin-top: 5px;
    box-sizing: border-box;
}
textarea {
    height: 80px;
    resize: vertical;
}
.photo-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.photo-box {
    flex: 1 1 30%;
    min-width: 150px;
}
.photo-box input {
    width: 100%;
}
.photo-preview {
    margin-top: 5px;
    width: 100%;
    max-height: 150px;
    object-fit: cover;
    border-radius: 6px;
    display: none;
    border: 1px solid #ccc;
}
button {
    padding: 10px 18px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 15px;
    border-radius: 6px;
    border: none;
}
.save-btn {
    background: #007bff;
    color: white;
}
.fault-btn {
    background: #c40000;
    color: white;
    margin-left: 10px;
}
.spec-save-btn {
    background: #28a745;
    color: white;
}

/* Circuits edit */
.spec-circuit-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}
.spec-circuit-row input {
    width: 100%;
}
.spec-circuit-remove-btn {
    padding: 0 8px;
    font-size: 14px;
    background: #c40000;
    color: white;
    border-radius: 4px;
}
</style>
</head>

<body>

<div class="header">
    Electrician Mode – DB: <span id="dbIdHeader"></span>
</div>

<div class="card">

    <!-- PANEL SUMMARY (READ ONLY) -->
    <div class="section-title">Panel Summary</div>
    <div class="summary-item"><b>DB Number:</b> <span id="dbNum"></span></div>
    <div class="summary-item"><b>Voltage:</b> <span id="volt"></span></div>
    <div class="summary-item"><b>Main Breaker:</b> <span id="breaker"></span></div>
    <div class="summary-item"><b>Cable Size:</b> <span id="cable"></span></div>
    <div class="summary-item"><b>Earth Status:</b> <span id="earth"></span></div>
    <div class="summary-item"><b>Location:</b> <span id="location"></span></div>
    <div class="summary-item"><b>Purpose:</b> <span id="purpose"></span></div>

    <hr>

    <!-- DB SPECIFICATION EDIT -->
    <div class="section-title">DB Specification (Editable – updates main DB)</div>

    <label>Voltage Rating</label>
    <input type="text" id="specVoltage">

    <label>Main Breaker Capacity</label>
    <input type="text" id="specBreaker">

    <label>Main Cable Size</label>
    <input type="text" id="specCable">

    <label>Earth Status</label>
    <input type="text" id="specEarth">

    <label>Location</label>
    <input type="text" id="specLocation">

    <label>Purpose</label>
    <input type="text" id="specPurpose">

    <div class="section-title">Circuits (Edit / Add / Remove)</div>
    <div id="specCircuitsContainer"></div>
    <button type="button" onclick="addSpecCircuitRow()">Add Circuit</button>

    <button class="spec-save-btn" onclick="saveDbSpec()">Save DB Specification</button>

    <hr>

    <!-- ELECTRICIAN INSPECTION -->
    <div class="section-title">Electrician Inspection</div>

    <label>Electrician Name</label>
    <input type="text" id="elecName" placeholder="Enter your name">

    <label>Breaker Condition</label>
    <select id="breakerStatus">
        <option value="">Select...</option>
        <option value="OK">OK</option>
        <option value="Needs repair">Needs repair</option>
        <option value="Not accessible">Not accessible</option>
    </select>

    <label>Panel Cleanliness</label>
    <select id="cleanStatus">
        <option value="">Select...</option>
        <option value="Clean">Clean</option>
        <option value="Needs cleaning">Needs cleaning</option>
        <option value="Not accessible">Not accessible</option>
    </select>

    <label>Panel Locked</label>
    <select id="lockedStatus">
        <option value="">Select...</option>
        <option value="Locked">Locked</option>
        <option value="Unlocked">Unlocked</option>
        <option value="Not lockable">Not lockable</option>
    </select>

    <label>Panel Covered</label>
    <select id="coveredStatus">
        <option value="">Select...</option>
        <option value="Covered">Covered</option>
        <option value="Not covered">Not covered</option>
        <option value="Not required">Not required</option>
    </select>

    <label>Comments / Notes</label>
    <textarea id="comments" placeholder="Any observations, issues, notes..."></textarea>

    <div class="section-title">Extra Inspection Questions</div>
    <div id="inspExtraQuestions"></div>

    <div class="section-title">Inspection Photos (optional, up to 3)</div>

    <div class="photo-row">
        <div class="photo-box">
            <small>Photo 1</small>
            <input type="file" accept="image/*" onchange="handlePhoto(this, 'preview1', 1)">
            <img id="preview1" class="photo-preview">
        </div>
        <div class="photo-box">
            <small>Photo 2</small>
            <input type="file" accept="image/*" onchange="handlePhoto(this, 'preview2', 2)">
            <img id="preview2" class="photo-preview">
        </div>
        <div class="photo-box">
            <small>Photo 3</small>
            <input type="file" accept="image/*" onchange="handlePhoto(this, 'preview3', 3)">
            <img id="preview3" class="photo-preview">
        </div>
    </div>

    <button class="save-btn" onclick="saveInspection()">Save Inspection</button>
    <button class="fault-btn" onclick="goToFault()">Report Fault</button>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const dbId = params.get("id");
document.getElementById("dbIdHeader").innerText = dbId || "";

let photo1Data = null;
let photo2Data = null;
let photo3Data = null;

let panelObj = null;
let inspQuestions = {};

// Load panel data
if (dbId) {
    loadPanelFromFirebase(dbId, function(p) {
        if (!p) {
            document.body.innerHTML = "<h2 style='text-align:center;color:red;margin-top:40px;'>No data found for this panel.</h2>";
            return;
        }
        panelObj = p;

        document.getElementById("dbNum").innerText = p.dbNumber || dbId;
        document.getElementById("volt").innerText = p.voltage || "";
        document.getElementById("breaker").innerText = p.mainBreaker || "";
        document.getElementById("cable").innerText = p.cableSize || "";
        document.getElementById("earth").innerText = p.earthStatus || "";
        document.getElementById("location").innerText = p.location || "";
        document.getElementById("purpose").innerText = p.purpose || "";

        document.getElementById("specVoltage").value = p.voltage || "";
        document.getElementById("specBreaker").value = p.mainBreaker || "";
        document.getElementById("specCable").value = p.cableSize || "";
        document.getElementById("specEarth").value = p.earthStatus || "";
        document.getElementById("specLocation").value = p.location || "";
        document.getElementById("specPurpose").value = p.purpose || "";

        renderSpecCircuits(p.circuits || null);
        loadInspectionQuestions();
    });
} else {
    document.body.innerHTML = "<h2 style='text-align:center;color:red;margin-top:40px;'>No panel ID provided.</h2>";
}

/*********** CIRCUITS EDITING ***********/
function renderSpecCircuits(circuits) {
    const container = document.getElementById("specCircuitsContainer");
    container.innerHTML = "";

    if (circuits) {
        const list = Array.isArray(circuits) ? circuits : Object.values(circuits);
        list.forEach(c => {
            addSpecCircuitRow(c.name || "", c.breaker || "", c.load || "");
        });
    } else {
        addSpecCircuitRow();
    }
}

function addSpecCircuitRow(name = "", breaker = "", load = "") {
    const container = document.getElementById("specCircuitsContainer");
    const row = document.createElement("div");
    row.className = "spec-circuit-row";
    row.innerHTML = `
        <input type="text" class="spec-c-name" placeholder="Circuit name" value="${name}">
        <input type="text" class="spec-c-breaker" placeholder="Breaker (e.g. 10A)" value="${breaker}">
        <input type="text" class="spec-c-load" placeholder="Load / Description" value="${load}">
        <button type="button" class="spec-circuit-remove-btn" onclick="removeSpecCircuitRow(this)">X</button>
    `;
    container.appendChild(row);
}

function removeSpecCircuitRow(btn) {
    const row = btn.parentElement;
    row.parentElement.removeChild(row);
}

function collectSpecCircuits() {
    const rows = document.querySelectorAll(".spec-circuit-row");
    const circuits = [];
    rows.forEach(row => {
        const name = row.querySelector(".spec-c-name").value.trim();
        const br = row.querySelector(".spec-c-breaker").value.trim();
        const ld = row.querySelector(".spec-c-load").value.trim();
        if (name || br || ld) {
            circuits.push({ name, breaker: br, load: ld });
        }
    });
    return circuits.length ? circuits : null;
}

/*********** SAVE DB SPEC ***********/
function saveDbSpec() {
    if (!dbId || !panelObj) {
        alert("Panel data not loaded yet.");
        return;
    }

    panelObj.voltage = document.getElementById("specVoltage").value;
    panelObj.mainBreaker = document.getElementById("specBreaker").value;
    panelObj.cableSize = document.getElementById("specCable").value;
    panelObj.earthStatus = document.getElementById("specEarth").value;
    panelObj.location = document.getElementById("specLocation").value;
    panelObj.purpose = document.getElementById("specPurpose").value;
    panelObj.circuits = collectSpecCircuits();

    savePanelToFirebase(dbId, panelObj, function() {
        alert("DB specification updated.");
    });
}

/*********** INSPECTION PHOTOS ***********/
function handlePhoto(inputElem, previewId, index) {
    const file = inputElem.files[0];
    if (!file) {
        if (index === 1) photo1Data = null;
        if (index === 2) photo2Data = null;
        if (index === 3) photo3Data = null;
        document.getElementById(previewId).style.display = "none";
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = document.getElementById(previewId);
        img.src = e.target.result;
        img.style.display = "block";

        if (index === 1) photo1Data = e.target.result;
        if (index === 2) photo2Data = e.target.result;
        if (index === 3) photo3Data = e.target.result;
    };
    reader.readAsDataURL(file);
}

/*********** DYNAMIC INSPECTION QUESTIONS ***********/
function loadInspectionQuestions() {
  firebase.database().ref("questions").once("value", snap => {
    inspQuestions = snap.val() || {};
    renderInspectionQuestions();
  });
}

function renderInspectionQuestions() {
  const container = document.getElementById("inspExtraQuestions");
  if (!container) return;

  const entries = Object.entries(inspQuestions)
    .filter(([id, q]) => q.applyInspection && q.active !== false);

  if (!entries.length) {
    container.innerHTML = "<p style='font-size:13px;color:#666;'>No extra inspection questions defined.</p>";
    return;
  }

  let html = "";
  entries.forEach(([id, q]) => {
    html += renderInspectionQuestionField(id, q);
  });
  container.innerHTML = html;
}

function renderInspectionQuestionField(id, q) {
  const baseId = `q_insp_${id}`;
  let fieldHtml = "";

  if (q.type === "text") {
    fieldHtml = `<input type="text" id="${baseId}" style="width:100%;">`;
  } else if (q.type === "number") {
    fieldHtml = `<input type="number" id="${baseId}" style="width:150px;">`;
  } else if (q.type === "yesno") {
    fieldHtml = `
      <select id="${baseId}">
        <option value=""></option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    `;
  } else if (q.type === "dropdown") {
    const opts = (q.options || []);
    const optionsHtml = ['<option value=""></option>']
      .concat(opts.map(o => `<option value="${o}">${o}</option>`))
      .join("");
    fieldHtml = `<select id="${baseId}">${optionsHtml}</select>`;
  } else {
    fieldHtml = `<input type="text" id="${baseId}" style="width:100%;">`;
  }

  return `
    <div style="margin-top:10px;">
      <label style="font-weight:bold;">${q.text}</label><br>
      ${fieldHtml}
    </div>
  `;
}

function collectInspectionExtras() {
  const result = {};
  Object.entries(inspQuestions).forEach(([id, q]) => {
    if (!q.applyInspection || q.active === false) return;
    const input = document.getElementById(`q_insp_${id}`);
    if (!input) return;
    const val = (input.value || "").toString().trim();
    if (val) result[id] = val;
  });
  return Object.keys(result).length ? result : null;
}

/*********** SAVE INSPECTION ***********/
function saveInspection() {
    if (!dbId) {
        alert("No panel ID in URL.");
        return;
    }

    const name = document.getElementById("elecName").value.trim();
    if (!name) {
        alert("Please enter electrician name.");
        return;
    }

    const data = {
        dbId: dbId,
        electricianName: name,
        breakerStatus: document.getElementById("breakerStatus").value,
        cleanStatus: document.getElementById("cleanStatus").value,
        lockedStatus: document.getElementById("lockedStatus").value,
        coveredStatus: document.getElementById("coveredStatus").value,
        comments: document.getElementById("comments").value,
        photo1: photo1Data || null,
        photo2: photo2Data || null,
        photo3: photo3Data || null,
        extraAnswers: collectInspectionExtras(),
        timestamp: new Date().toISOString()
    };

    firebase.database().ref("inspections/" + dbId).push(data, function(err) {
        if (err) {
            alert("Error saving inspection: " + err);
        } else {
            alert("Inspection saved successfully.");
        }
    });
}

/*********** FAULT PAGE ***********/
function goToFault() {
    if (!dbId) {
        alert("No panel ID in URL.");
        return;
    }
    location.href = "fault.html?id=" + encodeURIComponent(dbId);
}
</script>

</body>
</html>
