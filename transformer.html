<!DOCTYPE html>
<html>
<head>
  <title>Transformer Inspection</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="data.js"></script>

  <style>
    body { font-family: Arial; margin:0; background:#f4f4f4; }

    .topbar {
      background:#0c0c0c;
      padding:20px 0;
      text-align:center;
      box-shadow:0 3px 8px rgba(0,0,0,.45);
    }

    .title {
      margin-top:10px;
      font-size:26px;
      font-weight:bold;
      background:linear-gradient(90deg,#ffd65a,#ffb300);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }

    .card {
      background:#fff;
      padding:20px;
      max-width:800px;
      margin:20px auto;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    label { display:block; margin-top:12px; font-weight:bold; }

    input, select, textarea {
      width:100%;
      padding:10px;
      margin-top:3px;
      border:1px solid #ccc;
      border-radius:7px;
    }

    textarea { height:80px; }

    .btn {
      width:100%;
      padding:12px;
      margin-top:15px;
      border:none;
      border-radius:8px;
      font-weight:bold;
      cursor:pointer;
      color:white;
    }

    .btn-blue { background:#007bff; }
    .btn-red { background:#c40000; }

    #formCard { display:none; }

    img.preview {
      width:100%;
      display:none;
      margin-top:10px;
      border-radius:10px;
    }
  </style>
</head>

<body>

<div class="topbar">
  <div class="title">Transformer Inspection</div>
</div>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h2>Electrician Login</h2>
  <input type="password" id="loginKey" placeholder="Enter Password">
  <button class="btn btn-red" onclick="login()">Login</button>
  <div id="loginError" style="color:red;margin-top:10px;"></div>
</div>

<!-- FORM -->
<div class="card" id="formCard">
  <h2>Inspection Form</h2>

  <label>Date & Time</label>
  <input type="datetime-local" id="tr_datetime">

  <label>Electrician Name</label>
  <input type="text" id="tr_name">

  <label>Oil Level</label>
  <select id="oil_level">
    <option>Normal</option>
    <option>Low</option>
    <option>Very Low</option>
  </select>

  <label>Oil Condition</label>
  <select id="oil_condition">
    <option>Clear</option>
    <option>Discolored</option>
    <option>Contaminated</option>
  </select>

  <label>Oil Leakage</label>
  <select id="oil_leakage">
    <option>No Leakage</option>
    <option>Minor Leakage</option>
    <option>Major Leakage</option>
  </select>

  <label>Winding Temperature</label>
  <input type="number" id="temp_winding">

  <label>Oil Temperature</label>
  <input type="number" id="temp_oil">

  <label>Cooling Fan</label>
  <select id="fan_status">
    <option>Working</option>
    <option>Not Working</option>
  </select>

  <label>Noise</label>
  <select id="noise">
    <option>Normal</option>
    <option>High Noise</option>
  </select>

  <label>Bushing</label>
  <select id="bushing">
    <option>Good</option>
    <option>Cracked</option>
  </select>

  <label>Earth</label>
  <select id="earth">
    <option>OK</option>
    <option>Weak</option>
  </select>

  <label>Tap Changer</label>
  <select id="tap_changer">
    <option>OK</option>
    <option>Needs Maintenance</option>
  </select>

  <label>Load Current</label>
  <input type="number" id="load_current">

  <label>Remarks</label>
  <textarea id="tr_comments"></textarea>

  <button class="btn btn-blue" onclick="submitTransformer()">
    Submit Inspection
  </button>
</div>

<script>

/* ---------------- LOGIN ---------------- */

const ELECTRICIAN_KEY = "9999";

window.onload = function() {
  if (sessionStorage.getItem("electricianLogged") === "true") {
    showForm();
  }
};

function login() {
  const key = document.getElementById("loginKey").value.trim();

  if (key === ELECTRICIAN_KEY) {
    sessionStorage.setItem("electricianLogged", "true");
    showForm();
  } else {
    document.getElementById("loginError").innerText = "Wrong password!";
  }
}

function showForm() {
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("formCard").style.display = "block";

  const now = new Date();
  document.getElementById("tr_datetime").value =
    now.toISOString().slice(0,16);
}

/* ------------- GET TRANSFORMER ID ------------- */

const params = new URLSearchParams(window.location.search);
const trId = params.get("id") || "TR-001";

/* ------------- SUBMIT ------------- */

function submitTransformer() {

  const name = document.getElementById("tr_name").value.trim();
  if (!name) return alert("Enter electrician name.");

  const data = {
    timestamp: new Date().toISOString(),
    datetimeLocal: document.getElementById("tr_datetime").value,
    electricianName: name,
    oilLevel: document.getElementById("oil_level").value,
    oilCondition: document.getElementById("oil_condition").value,
    oilLeakage: document.getElementById("oil_leakage").value,
    tempWinding: document.getElementById("temp_winding").value,
    tempOil: document.getElementById("temp_oil").value,
    fanStatus: document.getElementById("fan_status").value,
    noise: document.getElementById("noise").value,
    bushing: document.getElementById("bushing").value,
    earth: document.getElementById("earth").value,
    tapChanger: document.getElementById("tap_changer").value,
    loadCurrent: document.getElementById("load_current").value,
    comments: document.getElementById("tr_comments").value
  };

  // IMPORTANT: Use central function from data.js
  saveTransformerInspection(trId, data, function() {
    alert("Inspection Saved Successfully!");
    window.location.href = "transformers.html";
  });
}

</script>

</body>
</html>
