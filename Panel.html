<!DOCTYPE html>
<html>
<head>
  <title>Chenab Electrical Panel System</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Your Firebase helper (firebaseConfig + loadPanelFromFirebase etc.) -->
  <script src="data.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f2f4f7;
    }

    /* BASIC TOPBAR (same as admin) */
    .topbar {
      background: #111;
      color: #ffc800;
      padding: 12px 24px 16px 24px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .topbar-title {
      font-size: 22px;
      font-weight: bold;
    }

    /* CARD STYLE (same as admin) */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      margin-bottom: 20px;
    }

    h1, h2, h3 {
      margin-top: 0;
      color: #111;
    }

    /* MAIN WRAPPER similar to tab-wrapper */
    .panel-wrapper {
      padding: 20px;
      max-width: 900px;
      margin: 0 auto 40px auto;
    }

    /* FORM ELEMENTS / BUTTONS (reuse admin styles) */
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="password"] {
      padding: 8px;
      font-size: 16px;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
    }
    .primary-btn {
      background:#007bff;
      color:#fff;
    }
    .danger-btn {
      background:#c40000;
      color:#fff;
    }
    .secondary-btn {
      background:#555;
      color:#fff;
    }

    /* DANGER BANNER (same feel as admin) */
    .dangerBanner {
      background: #c40000;
      color: #fff;
      padding: 10px 12px;
      font-weight: bold;
      border-radius: 8px;
      max-width: 600px;
      margin: 0 auto 15px auto;
      font-size: 16px;
      text-align: center;
    }

    /* PANEL IMAGE */
    .panel-image-box img {
      width: 100%;
      max-height: 320px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #444;
    }

    .labelBox {
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #e5e7eb;
    }

    /* VISITOR / ELECTRICIAN CHOICES */
    .choice-box {
      text-align: center;
      margin-top: 10px;
    }
    .choice-box h3 {
      margin-bottom: 10px;
    }
    .choice-box button {
      min-width: 180px;
      margin: 6px 8px;
      font-size: 15px;
    }

    .passwordBox {
      text-align: center;
      margin-top: 10px;
    }
    .passwordBox p {
      margin: 6px 0 0 0;
    }
    #passError {
      color: #c40000;
      font-weight: bold;
      margin-top: 6px;
      font-size: 13px;
    }

    .electricianOptions h3 {
      margin-bottom: 10px;
    }
    .electricianOptions button {
      display: block;
      width: 100%;
      max-width: 300px;
      margin: 8px auto;
      font-size: 16px;
      font-weight: bold;
    }

    /* CIRCUIT BOXES (same style as master-circuit-box) */
    .master-circuit-box {
      background:#fafafa;
      border:1px solid #ddd;
      border-radius:6px;
      padding:8px;
      margin-bottom:6px;
      font-size:13px;
    }

    /* PREMIUM HEADER DESIGN (copied from admin) */
    .premium-header {
      position: relative;
      padding: 20px 0 28px 0;
      background: #0c0c0c;
    }

    .logo-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .topbar-logo {
      width: 110px;
      height: auto;
      margin-bottom: 10px;
      filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.45));
      opacity: 1;
      animation: fadeInDown 0.7s ease-out;
    }

    /* Gold Gradient Title */
    .premium-title {
      background: linear-gradient(90deg, #ffd65a, #ffb300);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-align: center;
      animation: fadeInUp 0.7s ease-out;
    }

    /* Thin gold separator line */
    .header-separator {
      width: 80%;
      height: 2px;
      margin: 12px auto 0 auto;
      background: linear-gradient(90deg, #ffefc1, #ffb300, #ffefc1);
      border-radius: 2px;
      animation: fadeIn 1.2s ease-out;
    }

    /* Animations */
    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    /* SMALL TEXT */
    .small-note {
      font-size: 13px;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>

<body>

<!-- PREMIUM HEADER (same as admin, but panel title) -->
<div class="topbar premium-header">
  <div class="logo-wrapper">
    <img src="logo.png" class="topbar-logo" alt="Chenab Engineering Logo">
  </div>
  <div class="topbar-title premium-title">
    Chenab Electrical Panel System
  </div>
  <div class="header-separator"></div>
</div>

<div class="panel-wrapper">

  <!-- TOP CARD: Danger + Who Are You -->
  <div class="card">
    <div class="dangerBanner">
      ⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️
    </div>

    <h2 id="dbTitle">Loading panel...</h2>
    <p class="small-note">
      Scan-only information for visitors. Electricians can log in to submit inspection or fault reports.
    </p>

    <!-- Step 1: user choice -->
    <div id="userChoiceBox" class="choice-box">
      <h3>Who are you?</h3>
      <button class="secondary-btn" onclick="showVisitorView()">View Panel Information</button>
      <button class="primary-btn" onclick="showElectricianLogin()">Electrician Login</button>
    </div>

    <!-- Step 2: electrician password -->
    <div id="passwordBox" class="passwordBox" style="display:none;">
      <h3>Electrician Login</h3>
      <input type="password" id="electricianPass" placeholder="Enter Electrician Code">
      <br>
      <button class="primary-btn" onclick="checkElectricianPassword()">Login</button>
      <p id="passError"></p>
      <p class="small-note">For authorized Chenab electricians only.</p>
    </div>

    <!-- Step 3: electrician options -->
    <div id="electricianOptions" class="electricianOptions" style="display:none;">
      <h3>Select Action</h3>
      <button class="primary-btn" onclick="goInspection()">Fill Inspection Report</button>
      <button class="primary-btn" onclick="goFault()">Fill Fault Report</button>
    </div>
  </div>

  <!-- Panel Information (visitor view) -->
  <div id="panelInfoCard" class="card" style="display:none;">

    <div class="panel-image-box" id="panelImageBox" style="display:none;">
      <img id="panelImage" src="">
    </div>

    <div class="labelBox">
      <h3>Panel Details</h3>
      <p><b>DB Number:</b> <span id="db_number"></span></p>
      <p><b>Voltage Rating:</b> <span id="db_voltage"></span></p>
      <p><b>Main Breaker:</b> <span id="db_breaker"></span></p>
      <p><b>Main Cable Size:</b> <span id="db_cable"></span></p>
      <p><b>Earth Status:</b> <span id="db_earth"></span></p>
      <p><b>Location:</b> <span id="db_location"></span></p>
      <p><b>Purpose:</b> <span id="db_purpose"></span></p>
    </div>

    <div class="labelBox">
      <h3>Circuits</h3>
      <div id="circuitsList"></div>
    </div>

    <div class="labelBox" id="extraBox" style="display:none;">
      <h3>Extra Information</h3>
      <ul id="extraList" style="padding-left:18px;"></ul>
    </div>

    <p class="small-note">
      For maintenance or faults, please contact authorized Chenab electricians only.
    </p>
  </div>

</div>

<script>
/* --------------------------
   GLOBALS
--------------------------- */

const ELECTRICIAN_PASSWORD = "ELEC123";  // as requested
let dbID = "";
let questionsMap = {}; // to show proper labels for extraAnswers

/* --------------------------
   VISITOR / ELECTRICIAN FLOW
--------------------------- */

function showVisitorView() {
  document.getElementById("userChoiceBox").style.display = "none";
  document.getElementById("passwordBox").style.display = "none";
  document.getElementById("electricianOptions").style.display = "none";
  document.getElementById("panelInfoCard").style.display = "block";
}

function showElectricianLogin() {
  document.getElementById("userChoiceBox").style.display = "none";
  document.getElementById("panelInfoCard").style.display = "none";
  document.getElementById("electricianOptions").style.display = "none";
  document.getElementById("passwordBox").style.display = "block";
  document.getElementById("passError").innerText = "";
  document.getElementById("electricianPass").value = "";
}

function checkElectricianPassword() {
  const pass = document.getElementById("electricianPass").value.trim();
  const err = document.getElementById("passError");
  if (pass === ELECTRICIAN_PASSWORD) {
    err.innerText = "";
    document.getElementById("passwordBox").style.display = "none";
    document.getElementById("electricianOptions").style.display = "block";
  } else {
    err.innerText = "Incorrect password!";
  }
}

/* redirections */
function goInspection() {
  if (!dbID) return;
  window.location.href = "electrician.html?id=" + encodeURIComponent(dbID);
}

function goFault() {
  if (!dbID) return;
  window.location.href = "fault.html?id=" + encodeURIComponent(dbID);
}

/* --------------------------
   LOAD PANEL DATA
--------------------------- */

function loadQuestionsForLabels() {
  // Only to show nice labels for extraAnswers (same questions node as admin)
  firebase.database().ref("questions").once("value", snap => {
    const data = snap.val() || {};
    questionsMap = data;
    // After questions loaded we might re-render extra box if already have data
  });
}

window.onload = function() {
  const urlParams = new URLSearchParams(window.location.search);
  dbID = urlParams.get("id");

  if (!dbID) {
    document.getElementById("dbTitle").innerText = "DB Not Found!";
    document.getElementById("userChoiceBox").style.display = "none";
    return;
  }

  document.getElementById("dbTitle").innerText = "DB – " + dbID;

  // Load questions for labels
  loadQuestionsForLabels();

  // Load panel data from Firebase
  loadPanelFromFirebase(dbID, panel => {
    if (!panel) {
      document.getElementById("dbTitle").innerText = "DB Not Found in Database!";
      document.getElementById("userChoiceBox").style.display = "none";
      return;
    }

    document.getElementById("db_number").innerText   = panel.dbNumber || dbID;
    document.getElementById("db_voltage").innerText  = panel.voltage || "";
    document.getElementById("db_breaker").innerText  = panel.mainBreaker || "";
    document.getElementById("db_cable").innerText    = panel.cableSize || "";
    document.getElementById("db_earth").innerText    = panel.earthStatus || "";
    document.getElementById("db_location").innerText = panel.location || "";
    document.getElementById("db_purpose").innerText  = panel.purpose || "";

    // Image
    if (panel.image) {
      document.getElementById("panelImage").src = panel.image;
      document.getElementById("panelImageBox").style.display = "block";
    } else {
      document.getElementById("panelImageBox").style.display = "none";
    }

    // Circuits
    const circuitsContainer = document.getElementById("circuitsList");
    circuitsContainer.innerHTML = "";
    if (panel.circuits && Array.isArray(panel.circuits) && panel.circuits.length) {
      panel.circuits.forEach(c => {
        const div = document.createElement("div");
        div.className = "master-circuit-box";
        div.innerHTML = `
          <b>${c.name || ""}</b><br>
          Breaker: ${c.breaker || ""}<br>
          Load: ${c.load || ""}
        `;
        circuitsContainer.appendChild(div);
      });
    } else {
      circuitsContainer.innerHTML = "<p style='font-size:13px;color:#555;'>No circuits recorded.</p>";
    }

    // Extra Answers (dynamic questions)
    const extraBox = document.getElementById("extraBox");
    const extraList = document.getElementById("extraList");
    extraList.innerHTML = "";
    if (panel.extraAnswers) {
      extraBox.style.display = "block";
      Object.entries(panel.extraAnswers).forEach(([qid,val]) => {
        const q = questionsMap[qid];
        const label = q && q.text ? q.text : qid;
        const li = document.createElement("li");
        li.innerHTML = `<b>${label}:</b> ${val}`;
        extraList.appendChild(li);
      });
    } else {
      extraBox.style.display = "none";
    }
  });
};
</script>

</body>
</html>
