<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>LUX Monitoring Report â€“ Print View</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="data.js"></script>

<style>
body { font-family: Arial; background:#f4f4f4; margin:0; }

.topbar {
  background:#0c0c0c;
  padding:20px 0;
  text-align:center;
  box-shadow:0 3px 8px rgba(0,0,0,.4);
}

.title {
  margin-top:10px;
  font-size:24px;
  font-weight:bold;
  background:linear-gradient(90deg,#ffd65a,#ffb300);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.page {
  max-width:900px;
  margin:20px auto;
  background:#fff;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.2);
  padding:25px 30px 35px;
}

.section-title {
  margin-top:22px;
  font-weight:bold;
  font-size:15px;
  border-left:4px solid #ffb300;
  padding-left:8px;
}

table { width:100%; border-collapse:collapse; margin-top:10px; }

td, th {
  border:1px solid #ccc;
  padding:8px;
  font-size:13px;
}

th { background:#fdf6da; }

.status-box {
  padding:6px 12px;
  border-radius:20px;
  font-weight:bold;
  display:inline-block;
}

.green { background:#d4edda; color:#155724; }
.orange { background:#fff3cd; color:#856404; }
.red { background:#f8d7da; color:#721c24; }

.no-print { text-align:center; margin:15px; }

.no-print button {
  padding:10px 20px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#c40000;
  color:#fff;
  font-weight:bold;
}

@media print {
  .no-print { display:none; }
  body { background:#fff; }
  .page { box-shadow:none; margin:0; border-radius:0; }
}
</style>
</head>

<body>

<div class="topbar">
  <div class="title">LUX Monitoring Report</div>
</div>

<div class="no-print">
  <button onclick="window.print()">Print / Save PDF</button>
</div>

<div class="page" id="reportPage">
  <h2 style="text-align:center;">LUX MONITORING REPORT</h2>

  <div class="section-title">Inspection Status</div>
  <p>
    Status:
    <span id="statusBox"></span>
  </p>
  <p>
    Next Due Date:
    <strong id="nextDue"></strong>
  </p>

  <div class="section-title">General Information</div>
  <table>
    <tr><td>Sampling Location</td><td id="p_location"></td></tr>
    <tr><td>Date</td><td id="p_date"></td></tr>
    <tr><td>Time</td><td id="p_time"></td></tr>
    <tr><td>Collected By</td><td id="p_collectedBy"></td></tr>
    <tr><td>Designation</td><td id="p_designation"></td></tr>
  </table>

  <div class="section-title">Measurements</div>
  <table>
    <thead>
      <tr>
        <th>S/N</th>
        <th>Point</th>
        <th>Limit</th>
        <th>Measured</th>
        <th>Remarks</th>
        <th>Photo</th>
      </tr>
    </thead>
    <tbody id="measureBody"></tbody>
  </table>

</div>

<script>

const params = new URLSearchParams(window.location.search);
const areaId = params.get("area");
const reportKey = params.get("report");

if (!areaId || !reportKey) {
  document.getElementById("reportPage").innerHTML = "<p>Invalid Report Link</p>";
}

/* LOAD REPORT */
firebase.database()
.ref("luxReports/" + areaId + "/" + reportKey)
.once("value")
.then(snap => {

  const r = snap.val();
  if (!r) {
    document.getElementById("reportPage").innerHTML = "<p>Report Not Found</p>";
    return;
  }

  document.getElementById("p_location").textContent = r.samplingLocation || "";
  document.getElementById("p_date").textContent = r.sampleDate || "";
  document.getElementById("p_time").textContent =
    (r.timeFrom || "") + (r.timeTo ? " - " + r.timeTo : "");
  document.getElementById("p_collectedBy").textContent = r.collectedBy || "";
  document.getElementById("p_designation").textContent = r.designation || "";

  const tbody = document.getElementById("measureBody");

  if (r.measurements && Array.isArray(r.measurements)) {
    r.measurements.forEach(m => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.sn || ""}</td>
        <td>${m.point || ""}</td>
        <td>${m.limitLux || ""}</td>
        <td>${m.measuredLux || ""}</td>
        <td>${m.remarks || ""}</td>
        <td>${m.image ? `<img src="${m.image}" width="100">` : ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

});

/* LOAD STATUS FROM luxAreas */
firebase.database()
.ref("luxAreas/" + areaId)
.once("value")
.then(snap => {

  const area = snap.val();
  if (!area) return;

  const statusBox = document.getElementById("statusBox");
  const nextDueEl = document.getElementById("nextDue");

  if (!area.lastInspection || !area.nextInspectionDue) {
    statusBox.innerHTML = `<span class="status-box red">FIRST CHECK REQUIRED</span>`;
    nextDueEl.textContent = "-";
    return;
  }

  const now = new Date();
  const due = new Date(area.nextInspectionDue);
  const diff = Math.ceil((due - now)/(1000*60*60*24));

  nextDueEl.textContent = due.toLocaleDateString();

  if (diff < 0) {
    statusBox.innerHTML = `<span class="status-box red">OVERDUE</span>`;
  } else if (diff <= 5) {
    statusBox.innerHTML = `<span class="status-box orange">DUE SOON</span>`;
  } else {
    statusBox.innerHTML = `<span class="status-box green">OK</span>`;
  }

});

</script>

</body>
</html>
