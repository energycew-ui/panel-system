<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>

<!-- Firebase SDK v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Firebase helper -->
<script src="data.js"></script>

<style>
body {
    font-family: Arial;
    margin: 30px;
}

/* LOGIN OVERLAY */
#loginOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

#loginBox {
    background: #fff;
    padding: 25px 30px;
    border-radius: 10px;
    max-width: 320px;
    width: 90%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    text-align: center;
}

#loginBox input {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
}

#loginBox button {
    width: 100%;
    padding: 10px;
    margin-top: 15px;
}

#loginError {
    color: red;
}

/* FORM STYLES */
label {
    display: block;
    margin-top: 12px;
    font-weight: bold;
}

input {
    width: 300px;
    padding: 8px;
    font-size: 16px;
}

button {
    padding: 10px 18px;
    margin-top: 15px;
    font-size: 16px;
    cursor: pointer;
}

#previewImage {
    width: 200px;
    margin-top: 10px;
    display: none;
    border: 2px solid #333;
    border-radius: 6px;
}

/* Danger Banner */
.dangerBanner {
    background: #c40000;
    color: white;
    font-weight: bold;
    padding: 12px;
    text-align: center;
    margin-top: 20px;
    border-radius: 8px;
    font-size: 20px;
}

/* Circuits section */
.circuit-row {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.circuit-row input {
    width: 100%;
}

.circuit-remove-btn {
    padding: 0 8px;
    background: #c40000;
    color: white;
    border-radius: 4px;
}

/* QR container */
#qrFinalWrapper {
    margin-top: 20px;
    text-align: center;
}
</style>
</head>

<body>

<!-- LOGIN PAGE -->
<div id="loginOverlay">
    <div id="loginBox">
        <h2>Admin Login</h2>
        <input type="password" id="adminPassword" placeholder="Enter Password">
        <button onclick="checkLogin()">Login</button>
        <div id="loginError"></div>
    </div>
</div>


<!-- MAIN ADMIN PAGE -->
<div id="adminContent" style="display:none;">

<h2>Admin – Panel Data (Firebase)</h2>

<label>DB Number</label>
<input id="db">

<label>Voltage Rating</label>
<input id="volt">

<label>Main Breaker Capacity</label>
<input id="breaker">

<label>Main Cable Size</label>
<input id="cable">

<label>Earth Status</label>
<input id="earth">

<label>Location</label>
<input id="location">

<label>Purpose</label>
<input id="purpose">

<label>Upload Panel Picture</label>
<input type="file" id="imageInput" accept="image/*" onchange="previewAndCompress(event)">
<img id="previewImage">

<h3>Circuits (Name / Breaker / Load)</h3>

<div id="circuitsContainer"></div>
<button onclick="addCircuitRow()">Add Circuit</button>

<br><br>
<button onclick="savePanel()">Save Panel Data</button>

<!-- Danger Banner ABOVE QR -->
<div class="dangerBanner">
⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️
</div>

<h3>QR Code</h3>
<button onclick="generateQR()">Generate QR Code</button>

<div id="qrFinalWrapper">
    <canvas id="qrCanvas"></canvas><br>
    <div id="qrLabel" style="font-size:22px; font-weight:bold; margin-top:10px;"></div>
</div>

<button id="downloadQR" style="display:none;" onclick="downloadFinalQR()">Download QR + Banner</button>

<hr>

<h2>All Panels</h2>
<button onclick="showPanels()">Show All Panels</button>
<div id="panelList"></div>

</div> <!-- END ADMIN PAGE -->


<!-- QR Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
/* ---------------- LOGIN ---------------- */
const ADMIN_PASSWORD = "1234";

function checkLogin() {
    if (document.getElementById("adminPassword").value === ADMIN_PASSWORD) {
        sessionStorage.setItem("adminLogin", "1");
        document.getElementById("loginOverlay").style.display = "none";
        document.getElementById("adminContent").style.display = "block";
        renderCircuits(null);
    } else {
        document.getElementById("loginError").innerText = "Wrong Password!";
    }
}

if (sessionStorage.getItem("adminLogin") === "1") {
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("adminContent").style.display = "block";
    renderCircuits(null);
}

/* ---------------- CIRCUITS ---------------- */
function addCircuitRow(name = "", breaker = "", load = "") {
    const container = document.getElementById("circuitsContainer");
    const row = document.createElement("div");
    row.className = "circuit-row";

    row.innerHTML = `
        <input class="c-name" placeholder="Name" value="${name}">
        <input class="c-breaker" placeholder="Breaker" value="${breaker}">
        <input class="c-load" placeholder="Load" value="${load}">
        <button class="circuit-remove-btn" onclick="this.parentElement.remove()">X</button>
    `;
    container.appendChild(row);
}

function renderCircuits(circuits) {
    const container = document.getElementById("circuitsContainer");
    container.innerHTML = "";
    if (circuits) {
        Object.values(circuits).forEach(c => addCircuitRow(c.name, c.breaker, c.load));
    } else {
        addCircuitRow();
    }
}

function collectCircuits() {
    const rows = document.querySelectorAll(".circuit-row");
    const circuits = [];
    rows.forEach(r => {
        const name = r.querySelector(".c-name").value;
        const br = r.querySelector(".c-breaker").value;
        const ld = r.querySelector(".c-load").value;
        if (name || br || ld) circuits.push({ name, breaker: br, load: ld });
    });
    return circuits.length ? circuits : null;
}

/* ---------------- IMAGE COMPRESS ---------------- */
let uploadedImage = null;

function previewAndCompress(event) {
    let file = event.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = e => {
        let img = new Image();
        img.src = e.target.result;

        img.onload = () => {
            let canvas = document.createElement("canvas");
            let ctx = canvas.getContext("2d");

            let maxWidth = 800;
            let scale = maxWidth / img.width;
            canvas.width = maxWidth;
            canvas.height = img.height * scale;

            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            uploadedImage = canvas.toDataURL("image/jpeg", 0.7);

            document.getElementById("previewImage").src = uploadedImage;
            document.getElementById("previewImage").style.display = "block";
        };
    };
    reader.readAsDataURL(file);
}

/* ---------------- SAVE PANEL ---------------- */
function savePanel() {
    let id = document.getElementById("db").value.trim();
    if (!id) return alert("Enter DB Number");

    let data = {
        dbNumber: id,
        voltage: volt.value,
        mainBreaker: breaker.value,
        cableSize: cable.value,
        earthStatus: earth.value,
        location: location.value,
        purpose: purpose.value,
        image: uploadedImage,
        circuits: collectCircuits()
    };

    savePanelToFirebase(id, data, () => alert("Saved Successfully"));
}

/* ---------------- LIST PANELS ---------------- */
function showPanels() {
    loadAllPanels(all => {
        let html = "<table><tr><th>DB</th><th>Location</th><th>Purpose</th><th>Action</th></tr>";

        for (let id in all) {
            html += `
                <tr>
                    <td>${id}</td>
                    <td>${all[id].location}</td>
                    <td>${all[id].purpose}</td>
                    <td><button onclick="editPanel('${id}')">Edit</button></td>
                </tr>`;
        }

        html += "</table>";
        document.getElementById("panelList").innerHTML = html;
    });
}

/* ---------------- EDIT PANEL ---------------- */
function editPanel(id) {
    loadPanelFromFirebase(id, p => {
        db.value = p.dbNumber;
        volt.value = p.voltage;
        breaker.value = p.mainBreaker;
        cable.value = p.cableSize;
        earth.value = p.earthStatus;
        location.value = p.location;
        purpose.value = p.purpose;

        uploadedImage = p.image;
        if (uploadedImage) {
            previewImage.src = uploadedImage;
            previewImage.style.display = "block";
        } else {
            previewImage.style.display = "none";
        }

        renderCircuits(p.circuits);
        window.scrollTo(0, 0);
    });
}

/* ---------------- QR GENERATION ---------------- */
let qr;

function generateQR() {
    let id = document.getElementById("db").value.trim();
    if (!id) return alert("Enter DB Number");

    let url =
`https://energycew-ui.github.io/panel-system/index.html?id=${encodeURIComponent(id)}`;

    qr = new QRious({
        element: document.getElementById("qrCanvas"),
        value: url,
        size: 250
    });

    document.getElementById("qrLabel").innerText = id;
    document.getElementById("downloadQR").style.display = "inline-block";
}

/* ---------------- FINAL QR DOWNLOAD (banner + qr + dbName) ---------------- */
function downloadFinalQR() {
    let id = document.getElementById("db").value.trim();
    if (!id) return;

    let qrCanvas = document.getElementById("qrCanvas");
    let w = 500, h = 650;

    let finalCanvas = document.createElement("canvas");
    finalCanvas.width = w;
    finalCanvas.height = h;

    let ctx = finalCanvas.getContext("2d");

    // Background
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, w, h);

    // Banner
    ctx.fillStyle = "#c40000";
    ctx.fillRect(0, 0, w, 80);

    ctx.fillStyle = "white";
    ctx.font = "bold 26px Arial";
    ctx.textAlign = "center";
    ctx.fillText("⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️", w/2, 50);

    // QR Image
    ctx.drawImage(qrCanvas, (w-250)/2, 100, 250, 250);

    // DB Label
    ctx.fillStyle = "black";
    ctx.font = "bold 36px Arial";
    ctx.fillText(id, w/2, 410);

    // Download
    let link = document.createElement("a");
    link.download = `${id}_QR.png`;
    link.href = finalCanvas.toDataURL();
    link.click();
}

</script>

</body>
</html>
