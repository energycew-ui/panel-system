<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>

<!-- Firebase SDK v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Firebase helper -->
<script src="data.js"></script>

<style>
body {
    font-family: Arial;
    margin: 30px;
}

/* LOGIN OVERLAY */
#loginOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

#loginBox {
    background: #fff;
    padding: 25px 30px;
    border-radius: 10px;
    max-width: 320px;
    width: 90%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    text-align: center;
}

#loginError { color:red; }

/* HEADER */
.headerBar {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#companyLogo {
    width: 120px;
    height: auto;
}

/* FORM */
label {
    display:block;
    margin-top:12px;
    font-weight:bold;
}

input {
    width:300px;
    padding:8px;
}

/* CIRCUITS */
.circuit-row {
    display:flex;
    gap:10px;
    margin-top:8px;
}
.circuit-remove-btn {
    background:#c40000;
    color:white;
    padding:5px 10px;
    border-radius:4px;
    cursor:pointer;
}

/* QR BANNER */
.dangerBanner {
    background:#c40000;
    color:white;
    padding:12px;
    text-align:center;
    margin-top:20px;
    border-radius:6px;
    font-size:20px;
    font-weight:bold;
}

/* QR WRAPPER */
#qrFinalWrapper {
    text-align:center;
    margin-top:20px;
}
#qrCanvas {
    border:1px solid #ccc;
    margin-top:10px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
    <div id="loginBox">
        <h2>Admin Login</h2>
        <input type="password" id="adminPassword" placeholder="Enter Password">
        <button onclick="checkLogin()">Login</button>
        <div id="loginError"></div>
    </div>
</div>


<div id="adminContent" style="display:none;">

<div class="headerBar">
    <h2>Admin – Panel Data</h2>

    <!-- LOGO AREA (YOU CAN PLACE YOUR LOGO HERE) -->
    <img id="companyLogo" src="YOUR_LOGO.png" alt="Company Logo">
</div>

<label>DB Number</label>
<input id="db">

<label>Voltage Rating</label>
<input id="volt">

<label>Main Breaker Capacity</label>
<input id="breaker">

<label>Main Cable Size</label>
<input id="cable">

<label>Earth Status</label>
<input id="earth">

<label>Location</label>
<input id="location">

<label>Purpose</label>
<input id="purpose">

<label>Upload Panel Picture</label>
<input type="file" id="imageInput" accept="image/*" onchange="previewAndCompress(event)">
<img id="previewImage" style="width:200px;margin-top:10px;display:none;border:1px solid #444;border-radius:5px;">

<h3>Circuits</h3>
<div id="circuitsContainer"></div>
<button onclick="addCircuitRow()">Add Circuit</button>

<br><br>
<button onclick="savePanel()">Save Panel Data</button>

<!-- BANNER ABOVE QR -->
<div class="dangerBanner">
⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️
</div>

<h3>QR Code</h3>
<button onclick="generateQR()">Generate QR</button>

<div id="qrFinalWrapper">
    <canvas id="qrCanvas"></canvas>
    <div id="qrLabel" style="font-size:22px;margin-top:10px;font-weight:bold;"></div>
</div>

<button id="downloadQR" style="display:none;" onclick="downloadFinalQR()">Download QR Sheet</button>

<hr>

<h2>All Panels</h2>
<button onclick="showPanels()">Show All Panels</button>
<div id="panelList"></div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
/* LOGIN */
const ADMIN_PASSWORD = "1234";

function checkLogin() {
    if (adminPassword.value === ADMIN_PASSWORD) {
        sessionStorage.setItem("adminLogin",1);
        loginOverlay.style.display="none";
        adminContent.style.display="block";
        renderCircuits(null);
    } else {
        loginError.innerText="Wrong Password!";
    }
}

if (sessionStorage.getItem("adminLogin")==1){
    loginOverlay.style.display="none";
    adminContent.style.display="block";
}

/* CIRCUITS */
function addCircuitRow(n="",b="",l=""){
    circuitsContainer.innerHTML += `
        <div class="circuit-row">
            <input class="c-name" placeholder="Name" value="${n}">
            <input class="c-breaker" placeholder="Breaker" value="${b}">
            <input class="c-load" placeholder="Load" value="${l}">
            <button class="circuit-remove-btn" onclick="this.parentElement.remove()">X</button>
        </div>`;
}

function renderCircuits(c){
    circuitsContainer.innerHTML="";
    if(!c){ addCircuitRow(); return; }
    Object.values(c).forEach(x=> addCircuitRow(x.name,x.breaker,x.load));
}

function collectCircuits(){
    let arr=[];
    document.querySelectorAll(".circuit-row").forEach(r=>{
        let n=r.querySelector(".c-name").value;
        let b=r.querySelector(".c-breaker").value;
        let l=r.querySelector(".c-load").value;
        if(n||b||l) arr.push({name:n,breaker:b,load:l});
    });
    return arr.length?arr:null;
}

/* IMAGE */
let uploadedImage=null;
function previewAndCompress(event){
    let file=event.target.files[0];
    if(!file) return;
    let reader=new FileReader();
    reader.onload=e=>{
        let img=new Image();
        img.src=e.target.result;
        img.onload=()=>{
            let canvas=document.createElement("canvas");
            let ctx=canvas.getContext("2d");
            let maxW=800;
            let scale=maxW/img.width;
            canvas.width=maxW;
            canvas.height=img.height*scale;
            ctx.drawImage(img,0,0,canvas.width,canvas.height);
            uploadedImage=canvas.toDataURL("image/jpeg",0.7);
            previewImage.src=uploadedImage;
            previewImage.style.display="block";
        }
    }
    reader.readAsDataURL(file);
}

/* SAVE FIXED */
function savePanel(){
    let id=db.value.trim();
    if(!id) return alert("Enter DB Number");

    let data={
        dbNumber:id,
        voltage:volt.value,
        mainBreaker:breaker.value,
        cableSize:cable.value,
        earthStatus:earth.value,
        location:location.value,
        purpose:purpose.value,
        image:uploadedImage,
        circuits:collectCircuits()
    };

    savePanelToFirebase(id,data, ()=> alert("Saved Successfully"));
}

/* LIST */
function showPanels(){
    loadAllPanels(all=>{
        let html="<table><tr><th>DB</th><th>Location</th><th>Purpose</th><th>Action</th></tr>";
        for(let id in all){
            html+=`
            <tr>
              <td>${id}</td>
              <td>${all[id].location}</td>
              <td>${all[id].purpose}</td>
              <td><button onclick="editPanel('${id}')">Edit</button></td>
            </tr>`;
        }
        html+="</table>";
        panelList.innerHTML=html;
    })
}

/* EDIT */
function editPanel(id){
    loadPanelFromFirebase(id,p=>{
        db.value=p.dbNumber;
        volt.value=p.voltage;
        breaker.value=p.mainBreaker;
        cable.value=p.cableSize;
        earth.value=p.earthStatus;
        location.value=p.location;
        purpose.value=p.purpose;

        uploadedImage=p.image;
        if(uploadedImage){
            previewImage.src=uploadedImage;
            previewImage.style.display="block";
        }

        renderCircuits(p.circuits);
        window.scrollTo(0,0);
    })
}

/* QR GENERATION */
let qr;

function generateQR(){
    let id=db.value.trim();
    if(!id) return alert("Enter DB Number");

    let url=`https://energycew-ui.github.io/panel-system/index.html?id=${encodeURIComponent(id)}`;

    qr=new QRious({
        element:qrCanvas,
        value:url,
        size:250
    });

    qrLabel.innerText=id;
    downloadQR.style.display="inline-block";
}

/* QR DOWNLOAD WITH BANNER */
function downloadFinalQR(){
    let id=db.value.trim();
    if(!id) return;
    
    let qrCanvas=document.getElementById("qrCanvas");
    let W=500,H=650;
    let finalCanvas=document.createElement("canvas");
    finalCanvas.width=W;
    finalCanvas.height=H;
    let ctx=finalCanvas.getContext("2d");

    ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);

    ctx.fillStyle="#c40000";
    ctx.fillRect(0,0,W,80);

    ctx.fillStyle="white";
    ctx.font="bold 24px Arial";
    ctx.textAlign="center";
    ctx.fillText("⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️",W/2,50);

    ctx.drawImage(qrCanvas,(W-250)/2,110,250,250);

    ctx.fillStyle="black";
    ctx.font="bold 38px Arial";
    ctx.fillText(id,W/2,420);

    let link=document.createElement("a");
    link.download=id+"_QR.png";
    link.href=finalCanvas.toDataURL();
    link.click();
}
</script>
</body>
</html>
