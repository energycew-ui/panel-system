<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Firebase helper -->
  <script src="data.js"></script>

  <style>
    body { font-family: Arial; margin: 30px; }

    /* LOGIN OVERLAY */
    #loginOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    #loginBox {
      background: #fff; padding: 25px 30px; border-radius: 10px;
      max-width: 320px; width: 90%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4); text-align: center;
    }
    #loginBox input { width: 100%; padding: 10px; font-size: 16px; margin-top: 10px; }
    #loginBox button { width: 100%; padding: 10px; margin-top: 15px; cursor: pointer; }
    #loginError { color: red; font-size: 14px; }

    /* FORM FIELDS */
    label { display: block; margin-top: 12px; font-weight: bold; }
    input[type="text"], input[type="file"] { width: 300px; padding: 8px; font-size: 16px; }
    button { padding: 10px 20px; margin-top: 15px; cursor: pointer; }

    #previewImage {
      width: 200px; margin-top: 10px; display: none;
      border: 2px solid #444; border-radius: 6px;
    }

    /* Danger Banner */
    .dangerBanner {
      background: #c40000; color: white;
      padding: 12px; font-size: 18px; font-weight: bold;
      border-radius: 8px; margin-top: 20px;
    }

    /* Circuits */
    .circuit-row {
      display: flex; gap: 8px; margin-top: 8px;
    }
    .circuit-remove-btn {
      padding: 0 8px; background: #c40000;
      color: white; border-radius: 4px;
    }

    /* Table */
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; }
    th { background: #eee; }

    /* QR */
    #qrCanvas { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
    #qrDBname {
      font-size: 22px; font-weight: bold;
      margin-top: 12px; color: #111; text-align: center;
    }
  </style>
</head>

<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Password">
    <button onclick="checkLogin()">Login</button>
    <div id="loginError"></div>
  </div>
</div>

<!-- ADMIN PAGE -->
<div id="adminContent" style="display:none;">

  <h2>Admin – Panel Data</h2>

  <label>DB Number</label>
  <input id="db" type="text">

  <label>Voltage Rating</label>
  <input id="volt" type="text">

  <label>Main Breaker Capacity</label>
  <input id="breaker" type="text">

  <label>Main Cable Size</label>
  <input id="cable" type="text">

  <label>Earth Status</label>
  <input id="earth" type="text">

  <label>Location</label>
  <input id="location" type="text">

  <label>Purpose</label>
  <input id="purpose" type="text">

  <label>Upload Panel Picture</label>
  <input type="file" id="imageInput" accept="image/*" onchange="previewAndCompress(event)">
  <img id="previewImage">
  <button onclick="removeImage()">Remove Picture</button>

  <h3>Circuits</h3>
  <div id="circuitsContainer"></div>
  <button onclick="addCircuitRow()">Add Circuit</button>

  <br><br>
  <button onclick="savePanel()">Save Data</button>

  <h3>Generate QR Code</h3>
  <button onclick="generateQR()">Generate QR Code</button>

  <!-- ⭐ CENTERED QR BLOCK INCLUDING BANNER -->
  <div style="text-align:center; margin-top:20px;">

      <!-- ⭐ Danger banner ABOVE the QR -->
      <div class="dangerBanner" style="width: 350px; margin: 0 auto;">
          ⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️
      </div>

      <!-- QR Code -->
      <canvas id="qrCanvas" style="margin-top:20px;"></canvas>

      <!-- DB Name -->
      <div id="qrDBname"></div>

  </div>

  <button id="downloadQR" style="display:none;" onclick="downloadQR()">Download QR Code</button>

  <hr>

  <h2>All Panels</h2>
  <button onclick="showPanels()">Show All Panels</button>
  <div id="panelList"></div>

</div>

<!-- QR Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
/******** LOGIN ********/
const ADMIN_PASSWORD = "1234";

function checkLogin() {
  const pwd = document.getElementById("adminPassword").value.trim();
  if (pwd === ADMIN_PASSWORD) {
    sessionStorage.setItem("adminLoggedIn", "true");
    loginOverlay.style.display = "none";
    adminContent.style.display = "block";
    renderCircuits(null);
  } else {
    loginError.textContent = "Incorrect password.";
  }
}

window.onload = () => {
  if (sessionStorage.getItem("adminLoggedIn") === "true") {
    loginOverlay.style.display = "none";
    adminContent.style.display = "block";
    renderCircuits(null);
  }
};

/******** IMAGE ********/
let uploadedImage = null;

function previewAndCompress(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const maxWidth = 800;
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = img.height * scale;

      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      uploadedImage = canvas.toDataURL("image/jpeg", 0.7);

      previewImage.src = uploadedImage;
      previewImage.style.display = "block";
    };
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  uploadedImage = null;
  previewImage.style.display = "none";
}

/******** CIRCUITS ********/
function addCircuitRow(name="", breaker="", load="") {
  const container = document.getElementById("circuitsContainer");
  const row = document.createElement("div");
  row.className = "circuit-row";

  row.innerHTML = `
    <input class="c-name" placeholder="Circuit name" value="${name}">
    <input class="c-breaker" placeholder="Breaker" value="${breaker}">
    <input class="c-load" placeholder="Load" value="${load}">
    <button class="circuit-remove-btn" onclick="this.parentElement.remove()">X</button>
  `;

  container.appendChild(row);
}

function renderCircuits(circuits) {
  circuitsContainer.innerHTML = "";
  if (circuits) {
    Object.values(circuits).forEach(c =>
      addCircuitRow(c.name, c.breaker, c.load)
    );
  } else addCircuitRow();
}

function collectCircuitsFromForm() {
  const rows = document.querySelectorAll(".circuit-row");
  const circuits = [];
  rows.forEach(r => {
    const name = r.querySelector(".c-name").value.trim();
    const br   = r.querySelector(".c-breaker").value.trim();
    const ld   = r.querySelector(".c-load").value.trim();
    if (name || br || ld) circuits.push({ name, breaker: br, load: ld });
  });
  return circuits.length ? circuits : null;
}

/******** SAVE PANEL ********/
function savePanel() {

  const id = document.getElementById("db").value.trim();
  if (!id) return alert("Enter DB Number!");

  const data = {
    dbNumber: id,
    voltage: document.getElementById("volt").value,
    mainBreaker: document.getElementById("breaker").value,
    cableSize: document.getElementById("cable").value,
    earthStatus: document.getElementById("earth").value,
    location: document.getElementById("location").value,
    purpose: document.getElementById("purpose").value,
    image: uploadedImage,
    circuits: collectCircuitsFromForm()
  };

  savePanelToFirebase(id, data, () =>
    alert("Panel saved successfully!")
  );
}

/******** SHOW + EDIT PANELS ********/
function editPanel(id) {
  loadPanelFromFirebase(id, p => {

    document.getElementById("db").value = p.dbNumber;
    document.getElementById("volt").value = p.voltage;
    document.getElementById("breaker").value = p.mainBreaker;
    document.getElementById("cable").value = p.cableSize;
    document.getElementById("earth").value = p.earthStatus;
    document.getElementById("location").value = p.location;
    document.getElementById("purpose").value = p.purpose;

    uploadedImage = p.image;
    if (uploadedImage) {
      previewImage.src = uploadedImage;
      previewImage.style.display = "block";
    } else previewImage.style.display = "none";

    renderCircuits(p.circuits);
    window.scrollTo(0,0);
  });
}

function showPanels() {
  loadAllPanels(all => {
    if (!all) {
      panelList.innerHTML = "<p>No panels found.</p>";
      return;
    }

    let html =
      "<table><tr><th>DB</th><th>Location</th><th>Purpose</th><th>Action</th></tr>";

    Object.keys(all).forEach(id => {
      const p = all[id];
      html += `
        <tr>
          <td>${id}</td>
          <td>${p.location || ""}</td>
          <td>${p.purpose || ""}</td>
          <td><button onclick="editPanel('${id}')">Edit</button></td>
        </tr>`;
    });

    html += "</table>";
    panelList.innerHTML = html;
  });
}

/******** GENERATE QR ********/
let qr;

function generateQR() {

  const id = document.getElementById("db").value.trim();
  if (!id) return alert("Enter DB Number first!");

  const url =
    "https://energycew-ui.github.io/panel-system/index.html?id=" +
    encodeURIComponent(id);

  qr = new QRious({
    element: document.getElementById("qrCanvas"),
    value: url,
    size: 250
  });

  document.getElementById("qrDBname").innerText = id;
  document.getElementById("downloadQR").style.display = "inline-block";
}

/******** DOWNLOAD QR ********/
function downloadQR() {

  const id = document.getElementById("db").value.trim();
  if (!id) return;

  const qrCanvas = document.getElementById("qrCanvas");

  const W = 500, H = 650;
  const finalCanvas = document.createElement("canvas");
  finalCanvas.width = W;
  finalCanvas.height = H;

  const ctx = finalCanvas.getContext("2d");

  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,W,H);

  ctx.fillStyle = "#c40000";
  ctx.fillRect(0,0,W,80);

  ctx.fillStyle = "#fff";
  ctx.font = "bold 24px Arial";
  ctx.textAlign = "center";
  ctx.fillText("⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️", W/2, 50);

  ctx.drawImage(qrCanvas, (W-250)/2, 120, 250, 250);

  ctx.fillStyle="#000";
  ctx.font="bold 36px Arial";
  ctx.fillText(id, W/2, 420);

  const link = document.createElement("a");
  link.download = id + "_QR.png";
  link.href = finalCanvas.toDataURL();
  link.click();
}
</script>

</body>
</html>
