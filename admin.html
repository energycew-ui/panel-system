<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>

  <!-- Firebase SDK v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Your Firebase helper -->
  <script src="data.js"></script>

  <style>
    body { font-family: Arial; margin: 30px; }

    /* LOGIN SCREEN */
    #loginOverlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999;
    }
    #loginBox {
      background: #fff; padding: 25px 30px; border-radius: 10px;
      max-width: 320px; width: 90%; text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    }
    #loginBox input { width: 100%; padding: 10px; margin-top: 10px; }
    #loginBox button { width: 100%; padding: 10px; margin-top: 15px; }
    #loginError { color: red; }

    label { display: block; margin-top: 12px; font-weight: bold; }
    input { width: 300px; padding: 8px; font-size: 16px; }

    #previewImage {
      width: 200px; margin-top: 10px;
      border: 2px solid #444; border-radius: 6px;
      display: none;
    }

    .dangerBanner {
      background: #c40000;
      color: white;
      padding: 12px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 8px;
      text-align: center;
    }

    .circuit-row {
      display: flex; gap: 8px; margin-top: 8px;
    }
    .circuit-remove-btn {
      background: #c40000; color: white;
      padding: 0 8px; border-radius: 4px;
    }

    #qrCanvas {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 20px;
    }
    #qrDBname {
      font-size: 22px; font-weight: bold; margin-top: 15px;
      text-align: center;
    }

    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px 10px; }
    th { background: #eee; }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Password">
    <button onclick="checkLogin()">Login</button>
    <div id="loginError"></div>
  </div>
</div>

<!-- ADMIN CONTENT -->
<div id="adminContent" style="display:none;">

  <h2>Admin – Panel Data</h2>

  <label>DB Number</label>
  <input id="db">

  <label>Voltage Rating</label>
  <input id="volt">

  <label>Main Breaker Capacity</label>
  <input id="breaker">

  <label>Main Cable Size</label>
  <input id="cable">

  <label>Earth Status</label>
  <input id="earth">

  <label>Location</label>
  <input id="location">

  <label>Purpose</label>
  <input id="purpose">

  <label>Upload Panel Picture</label>
  <input type="file" id="imageInput" accept="image/*" onchange="previewAndCompress(event)">
  <img id="previewImage">
  <button onclick="removeImage()">Remove Picture</button>

  <h3>Circuits</h3>
  <div id="circuitsContainer"></div>
  <button onclick="addCircuitRow()">Add Circuit</button>

  <br><br>
  <button onclick="savePanel()">Save Data</button>

  <h3>Generate QR Code</h3>
  <button onclick="generateQR()">Generate QR Code</button>

  <!-- ⭐ FIX: QR + banner + DB IN ONE BLOCK -->
  <div id="qrBlock" style="text-align:center; margin-top:20px; width:100%;">

      <!-- BANNER -->
      <div class="dangerBanner" style="width: 350px; margin: 0 auto 20px auto;">
          ⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️
      </div>

      <!-- QR CANVAS -->
      <canvas id="qrCanvas" style="margin: 0 auto; display:block;"></canvas>

      <!-- DB NAME -->
      <div id="qrDBname"></div>

  </div>

  <button id="downloadQR" style="display:none;" onclick="downloadQR()">Download QR Code</button>

  <hr>

  <h2>All Panels</h2>
  <button onclick="showPanels()">Show All Panels</button>
  <div id="panelList"></div>

</div>

<!-- QR Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
/******** LOGIN ********/
const ADMIN_PASSWORD = "1234";

function checkLogin() {
  const pwd = adminPassword.value.trim();
  if (pwd === ADMIN_PASSWORD) {
    sessionStorage.setItem("adminLoggedIn", "true");
    loginOverlay.style.display = "none";
    adminContent.style.display = "block";
    renderCircuits(null);
  } else loginError.textContent = "Incorrect password.";
}

window.onload = () => {
  if (sessionStorage.getItem("adminLoggedIn") === "true") {
    loginOverlay.style.display = "none";
    adminContent.style.display = "block";
    renderCircuits(null);
  }
};

/******** IMAGE ********/
let uploadedImage = null;

function previewAndCompress(e) {
  const file = e.target.files[0];
  if (!file) return;

  const r = new FileReader();
  r.onload = ev => {
    const img = new Image();
    img.src = ev.target.result;
    img.onload = () => {
      const c = document.createElement("canvas");
      const ctx = c.getContext("2d");
      const W = 800;
      const scale = W / img.width;
      c.width = W; c.height = img.height * scale;
      ctx.drawImage(img, 0, 0, c.width, c.height);
      uploadedImage = c.toDataURL("image/jpeg", 0.7);
      previewImage.src = uploadedImage;
      previewImage.style.display = "block";
    };
  };
  r.readAsDataURL(file);
}

function removeImage() {
  uploadedImage = null;
  previewImage.style.display = "none";
}

/******** CIRCUITS ********/
function addCircuitRow(name="", breaker="", load="") {
  const row = document.createElement("div");
  row.className = "circuit-row";
  row.innerHTML = `
    <input class="c-name" placeholder="Circuit name" value="${name}">
    <input class="c-breaker" placeholder="Breaker" value="${breaker}">
    <input class="c-load" placeholder="Load" value="${load}">
    <button class="circuit-remove-btn" onclick="this.parentElement.remove()">X</button>
  `;
  circuitsContainer.appendChild(row);
}

function renderCircuits(list) {
  circuitsContainer.innerHTML = "";
  if (list) Object.values(list).forEach(c => addCircuitRow(c.name, c.breaker, c.load));
  else addCircuitRow();
}

function collectCircuits() {
  const rows = document.querySelectorAll(".circuit-row");
  const arr = [];
  rows.forEach(r => {
    const n = r.querySelector(".c-name").value.trim();
    const b = r.querySelector(".c-breaker").value.trim();
    const l = r.querySelector(".c-load").value.trim();
    if (n || b || l) arr.push({ name: n, breaker: b, load: l });
  });
  return arr.length ? arr : null;
}

/******** SAVE PANEL ********/
function savePanel() {
  const id = db.value.trim();
  if (!id) return alert("Enter DB Number!");

  const data = {
    dbNumber: id,
    voltage: volt.value,
    mainBreaker: breaker.value,
    cableSize: cable.value,
    earthStatus: earth.value,
    location: location.value,
    purpose: purpose.value,
    image: uploadedImage,
    circuits: collectCircuits()
  };

  savePanelToFirebase(id, data, () =>
    alert("Panel saved successfully!")
  );
}

/******** LOAD PANEL ********/
function editPanel(id) {
  loadPanelFromFirebase(id, p => {
    db.value = p.dbNumber;
    volt.value = p.voltage;
    breaker.value = p.mainBreaker;
    cable.value = p.cableSize;
    earth.value = p.earthStatus;
    location.value = p.location;
    purpose.value = p.purpose;
    uploadedImage = p.image;

    if (uploadedImage) {
      previewImage.src = uploadedImage;
      previewImage.style.display = "block";
    } else previewImage.style.display = "none";

    renderCircuits(p.circuits);
    window.scrollTo(0,0);
  });
}

/******** SHOW PANELS ********/
function showPanels() {
  loadAllPanels(all => {
    if (!all) return panelList.innerHTML = "<p>No panels.</p>";
    let html = `<table><tr><th>DB</th><th>Location</th><th>Purpose</th><th></th></tr>`;
    Object.keys(all).forEach(id => {
      html += `
        <tr>
          <td>${id}</td>
          <td>${all[id].location || ""}</td>
          <td>${all[id].purpose || ""}</td>
          <td><button onclick="editPanel('${id}')">Edit</button></td>
        </tr>`;
    });
    html += "</table>";
    panelList.innerHTML = html;
  });
}

/******** GENERATE QR ********/
let qr;

function generateQR() {
  const id = db.value.trim();
  if (!id) return alert("Enter DB Number first!");

  const url =
    "https://energycew-ui.github.io/panel-system/index.html?id=" +
    encodeURIComponent(id);

  qr = new QRious({
    element: qrCanvas,
    value: url,
    size: 250
  });

  qrDBname.innerText = id;
  downloadQR.style.display = "inline-block";
}

/******** DOWNLOAD QR ********/
function downloadQR() {
  const id = db.value.trim();
  if (!id) return;

  const qrCanvasEl = qrCanvas;

  const W = 500, H = 650;
  const final = document.createElement("canvas");
  final.width = W; final.height = H;
  const ctx = final.getContext("2d");

  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,W,H);

  ctx.fillStyle = "#c40000";
  ctx.fillRect(0,0,W,80);

  ctx.fillStyle="#fff";
  ctx.font="bold 24px Arial";
  ctx.textAlign="center";
  ctx.fillText("⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️", W/2, 50);

  ctx.drawImage(qrCanvasEl, (W-250)/2, 120, 250, 250);

  ctx.fillStyle="#000";
  ctx.font="bold 36px Arial";
  ctx.fillText(id, W/2, 420);

  const link = document.createElement("a");
  link.download = id + "_QR.png";
  link.href = final.toDataURL();
  link.click();
}
</script>

</body>
</html>
