<!DOCTYPE html> 
<html>
<head>
  <title>Admin Dashboard</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Your Firebase helper (firebaseConfig + savePanelToFirebase + loadPanelFromFirebase + loadAllPanels etc.) -->
  <script src="data.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }

    .topbar {
      background: #0c0c0c;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .topbar img {
      height: 48px;
    }
    .topbar-title {
      font-size: 20px;
      font-weight: bold;
      color: #ffd54f;
    }
    .topbar-subtitle {
      font-size: 12px;
      color: #ddd;
    }
    .topbar-right {
      font-size: 13px;
      text-align: right;
    }

    .adminWrapper {
      display: flex;
      height: calc(100vh - 70px);
    }

    .sidebar {
      width: 260px;
      background: #111;
      color: #eee;
      overflow-y: auto;
      box-shadow: 3px 0 8px rgba(0,0,0,0.3);
    }
    .sidebar h2 {
      margin: 15px;
      font-size: 16px;
      color: #ffca28;
      border-bottom: 1px solid #333;
      padding-bottom: 8px;
    }
    .tab-button {
      display: block;
      width: 100%;
      padding: 10px 15px;
      text-align: left;
      border: none;
      background: none;
      color: #ddd;
      cursor: pointer;
      font-size: 14px;
      border-left: 3px solid transparent;
    }
    .tab-button:hover {
      background: #222;
    }
    .tab-button.active {
      background: #263238;
      border-left-color: #ffca28;
      color: #fff;
      font-weight: bold;
    }

    .mainContent {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
    }

    .card {
      background: #fff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .form-group {
      flex: 1 1 220px;
      min-width: 180px;
    }
    .form-group label {
      font-size: 13px;
      display: block;
      margin-bottom: 3px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .primary-btn {
      background: #1976d2;
      color: #fff;
      border-radius: 6px;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
      font-weight: bold;
    }
    .primary-btn:hover {
      background: #125a9d;
    }

    .secondary-btn {
      background: #455a64;
      color: #fff;
      border-radius: 6px;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
    }
    .secondary-btn:hover {
      background: #263238;
    }

    .danger-btn {
      background: #c62828;
      color: #fff;
      border-radius: 6px;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
    }
    .danger-btn:hover {
      background: #8e0000;
    }

    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .summary-card {
      flex: 1 1 200px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 10px;
      box-sizing: border-box;
    }
    .summary-title {
      font-size: 12px;
      color: #666;
    }
    .summary-value {
      font-size: 18px;
      font-weight: bold;
      margin-top: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
    }
    th {
      background: #f5f5f5;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }

    .filterBox {
      margin: 10px 0;
      font-size: 13px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    .filterBox input,
    .filterBox select {
      padding: 4px 6px;
      font-size: 12px;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      font-size: 11px;
      border-radius: 10px;
      background: #e3f2fd;
      color: #1976d2;
      margin-right: 3px;
      margin-top: 3px;
    }

    .status-ok {
      color: #2e7d32;
      font-weight: bold;
    }
    .status-bad {
      color: #c62828;
      font-weight: bold;
    }

    .imageThumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .overlay img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 0 15px #000;
    }

    .loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .loginBox {
      background: #ffffff;
      padding: 25px;
      border-radius: 12px;
      width: 320px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .loginBox h2 {
      margin-top: 0;
    }
    .loginBox input {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .loginBox button {
      width: 100%;
      margin-top: 15px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      border-radius: 6px;
      border: none;
      font-weight: bold;
    }
    .loginBox #loginError {
      margin-top: 8px;
      color: red;
      font-size: 13px;
    }

    @media (max-width: 900px) {
      .adminWrapper {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        display: flex;
        overflow-x: auto;
      }
      .sidebar h2 {
        display: none;
      }
      .tab-button {
        flex: 1 1 auto;
        white-space: nowrap;
        font-size: 12px;
        padding: 8px;
      }
      .mainContent {
        height: auto;
      }
    }

    .photo-btn {
      background: #00796b;
      color: #fff;
      border-radius: 5px;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
      margin-right: 4px;
    }
    .photo-btn:hover {
      background: #004d40;
    }
  </style>
</head>
<body>

<div class="loginOverlay" id="loginOverlay">
  <div class="loginBox">
    <h2>Admin Login</h2>
    <input type="password" id="adminPin" placeholder="Enter Admin PIN">
    <button onclick="checkAdminPIN()">Login</button>
    <div id="loginError"></div>
  </div>
</div>

<div class="topbar">
  <div class="topbar-left">
    <img src="logo.png" alt="Logo">
    <div>
      <div class="topbar-title">Electrical Safety Admin Panel</div>
      <div class="topbar-subtitle">Panels • Transformers • LUX • Faults • Technician Reports</div>
    </div>
  </div>
  <div class="topbar-right">
    <div id="adminUserLabel">Admin</div>
    <div id="dateTimeLabel"></div>
  </div>
</div>

<div class="adminWrapper">
  <div class="sidebar">
    <h2>Entries</h2>
    <button class="tab-button active" onclick="showTab('tab-db-entry', this)">DB Entry</button>
    <button class="tab-button" onclick="showTab('tab-transformer-entry', this)">Transformer Entry</button>
    <button class="tab-button" onclick="showTab('tab-compressor-entry', this)">Compressor Entry</button>
    <button class="tab-button" onclick="showTab('tab-generator-entry', this)">Generator Entry</button>

    <h2>Reports</h2>
    <button class="tab-button" onclick="showTab('tab-db-inspections', this)">DB Inspection Reports</button>
    <button class="tab-button" onclick="showTab('tab-fault-reports', this)">Fault Reports</button>
    <button class="tab-button" onclick="showTab('tab-transformer-reports', this)">Transformer Reports</button>
    <button class="tab-button" onclick="showTab('tab-lux-reports', this)">LUX Reports</button>
    <button class="tab-button" onclick="showTab('tab-compressor-inspections', this)">Compressor Inspection Reports</button>
    <button class="tab-button" onclick="showTab('tab-compressor-maint', this)">Compressor Maintenance Reports</button>
    <button class="tab-button" onclick="showTab('tab-generator-inspections', this)">Generator Inspection Reports</button>
    <button class="tab-button" onclick="showTab('tab-generator-maint', this)">Generator Maintenance Reports</button>

    <h2>Tools</h2>
    <button class="tab-button" onclick="showTab('tab-master-db', this)">Master DB Report</button>
    <button class="tab-button" onclick="showTab('tab-questions', this)">Form Questions</button>
  </div>

  <div class="mainContent">

    <!-- TAB 1: DB ENTRY -->
    <div class="tab-content" id="tab-db-entry" style="display:block;">
      <div class="card">
        <h2>DB Entry</h2>
        <div class="form-row">
          <div class="form-group">
            <label>DB ID</label>
            <input type="text" id="db_id">
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" id="db_location">
          </div>
          <div class="form-group">
            <label>Feeder</label>
            <input type="text" id="db_feeder">
          </div>
          <div class="form-group">
            <label>Rating</label>
            <input type="text" id="db_rating">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Panel Type</label>
            <input type="text" id="db_panelType">
          </div>
          <div class="form-group">
            <label>Panel Make</label>
            <input type="text" id="db_panelMake">
          </div>
          <div class="form-group">
            <label>Risk Category</label>
            <select id="db_risk">
              <option value="">Select</option>
              <option value="L">Low</option>
              <option value="M">Medium</option>
              <option value="H">High</option>
            </select>
          </div>
          <div class="form-group">
            <label>Remarks</label>
            <input type="text" id="db_remarks">
          </div>
        </div>

        <button class="primary-btn" onclick="saveDBEntry()">Save DB Entry</button>
      </div>

      <div class="card">
        <h3>Existing DBs</h3>
        <div id="dbEntryTable"></div>
      </div>
    </div>

    <!-- TAB 2: TRANSFORMER ENTRY -->
    <div class="tab-content" id="tab-transformer-entry" style="display:none;">
      <div class="card">
        <h2>Transformer Entry</h2>
        <div class="form-row">
          <div class="form-group">
            <label>Transformer ID</label>
            <input type="text" id="tr_id">
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" id="tr_location">
          </div>
          <div class="form-group">
            <label>Capacity (kVA)</label>
            <input type="number" id="tr_capacity">
          </div>
          <div class="form-group">
            <label>Make</label>
            <input type="text" id="tr_make">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Voltage Level</label>
            <input type="text" id="tr_voltage">
          </div>
          <div class="form-group">
            <label>Oil Type</label>
            <input type="text" id="tr_oilType">
          </div>
          <div class="form-group">
            <label>Risk Category</label>
            <select id="tr_risk">
              <option value="">Select</option>
              <option value="L">Low</option>
              <option value="M">Medium</option>
              <option value="H">High</option>
            </select>
          </div>
          <div class="form-group">
            <label>Remarks</label>
            <input type="text" id="tr_remarks">
          </div>
        </div>

        <button class="primary-btn" onclick="saveTransformerEntry()">Save Transformer Entry</button>
      </div>

      <div class="card">
        <h3>Existing Transformers</h3>
        <div id="transformerEntryTable"></div>
      </div>
    </div>
    <!-- TAB 3: COMPRESSOR ENTRY -->
    <div class="tab-content" id="tab-compressor-entry" style="display:none;">
      <div class="card">
        <h2>Compressor Entry</h2>

        <div class="form-row">
          <div class="form-group">
            <label>Compressor ID</label>
            <input type="text" id="comp_id">
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" id="comp_location">
          </div>
          <div class="form-group">
            <label>Model</label>
            <input type="text" id="comp_model">
          </div>
          <div class="form-group">
            <label>Capacity</label>
            <input type="text" id="comp_capacity">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Pressure Rating</label>
            <input type="text" id="comp_pressure">
          </div>
          <div class="form-group">
            <label>Compressor Type</label>
            <input type="text" id="comp_type">
          </div>
          <div class="form-group">
            <label>Upload Image</label>
            <input type="file" id="comp_img" accept="image/*">
          </div>
        </div>

        <button class="primary-btn" onclick="saveCompressorEntry()">Save Compressor Entry</button>
      </div>

      <div class="card">
        <h3>Existing Compressors</h3>
        <div id="compressorEntryTable"></div>
      </div>
    </div>

    <!-- TAB 4: GENERATOR ENTRY -->
    <div class="tab-content" id="tab-generator-entry" style="display:none;">
      <div class="card">
        <h2>Generator Entry</h2>

        <div class="form-row">
          <div class="form-group">
            <label>Generator ID</label>
            <input type="text" id="gen_id">
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" id="gen_location">
          </div>
          <div class="form-group">
            <label>Model</label>
            <input type="text" id="gen_model">
          </div>
          <div class="form-group">
            <label>Capacity (kVA)</label>
            <input type="number" id="gen_capacity">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Fuel Type</label>
            <input type="text" id="gen_fuel">
          </div>
          <div class="form-group">
            <label>Upload Image</label>
            <input type="file" id="gen_img" accept="image/*">
          </div>
        </div>

        <button class="primary-btn" onclick="saveGeneratorEntry()">Save Generator Entry</button>
      </div>

      <div class="card">
        <h3>Existing Generators</h3>
        <div id="generatorEntryTable"></div>
      </div>
    </div>

    <!-- TAB 5: DB INSPECTION REPORTS -->
    <div class="tab-content" id="tab-db-inspections" style="display:none;">
      <div class="card">
        <h2>DB Inspection Reports</h2>

        <div class="filterBox">
          <input type="text" id="dbIns_filterId" placeholder="Filter by DB ID">
          <input type="text" id="dbIns_filterElec" placeholder="Filter by Electrician">
          <input type="date" id="dbIns_filterDate">
          <button class="secondary-btn" onclick="applyDBInspectionFilters()">Apply</button>
        </div>

        <div class="summary-row" id="dbInspectionSummary"></div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
            <h3 style="margin:0;">All DB Inspections</h3>
            <button class="secondary-btn" onclick="exportDBInspectionsCSV()">Export CSV</button>
          </div>
          <div id="dbInspectionTable"></div>
        </div>
      </div>
    </div>

    <!-- TAB 6: FAULT REPORTS -->
    <div class="tab-content" id="tab-fault-reports" style="display:none;">
      <div class="card">
        <h2>Fault Reports</h2>

        <div class="filterBox">
          <input type="text" id="fault_filterId" placeholder="Filter by DB ID">
          <input type="text" id="fault_filterElec" placeholder="Filter by Electrician">
          <input type="date" id="fault_filterDate">
          <button class="secondary-btn" onclick="applyFaultFilters()">Apply</button>
        </div>

        <div class="summary-row" id="faultSummary"></div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
            <h3 style="margin:0;">All Fault Reports</h3>
            <button class="secondary-btn" onclick="exportFaultsCSV()">Export CSV</button>
          </div>
          <div id="faultTable"></div>
        </div>
      </div>
    </div>

    <!-- TAB 7: TRANSFORMER REPORTS -->
    <div class="tab-content" id="tab-transformer-reports" style="display:none;">
      <div class="card">
        <h2>Transformer Inspection Reports</h2>

        <div class="filterBox">
          <input type="text" id="trRpt_filterId" placeholder="Filter by Transformer ID">
          <input type="text" id="trRpt_filterTech" placeholder="Filter by Technician">
          <input type="date" id="trRpt_filterDate">
          <button class="secondary-btn" onclick="applyTransformerFilters()">Apply</button>
        </div>

        <div class="summary-row" id="transformerSummary"></div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
            <h3 style="margin:0;">Transformer Reports</h3>
            <button class="secondary-btn" onclick="exportTransformerCSV()">Export CSV</button>
          </div>
          <div id="transformerTable"></div>
        </div>
      </div>
    </div>
    <!-- TAB 8: LUX REPORTS -->
    <div class="tab-content" id="tab-lux-reports" style="display:none;">

      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <h2 style="margin:0;">LUX Monitoring Reports</h2>
          <div style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="secondary-btn" onclick="exportLuxCSV()">Export CSV</button>
            <button class="secondary-btn" onclick="exportLuxPDF()">Export PDF</button>
            <button class="secondary-btn" onclick="setLuxSort('maxDesc')">Sort Lux ⬇</button>
            <button class="secondary-btn" onclick="setLuxSort('maxAsc')">Sort Lux ⬆</button>
            <button class="secondary-btn" onclick="setLuxSort('none')">Clear Sort</button>
          </div>
        </div>
      </div>

      <div class="summary-row" id="luxSummary"></div>

      <div class="card">
        <h3>LUX Records Table</h3>
        <div id="luxTable"></div>
      </div>

    </div>

    <!-- TAB 9: COMPRESSOR INSPECTION REPORTS -->
    <div class="tab-content" id="tab-compressor-inspections" style="display:none;">
      <div class="card">
        <h2>Compressor Inspection Reports</h2>

        <div class="filterBox">
          <input type="text" id="compIns_filterId" placeholder="Filter by Compressor ID">
          <input type="text" id="compIns_filterTech" placeholder="Filter by Technician">
          <input type="date" id="compIns_filterDate">
          <button class="secondary-btn" onclick="applyCompressorInspectionFilters()">Apply</button>
        </div>

        <div class="summary-row" id="compInspectionSummary"></div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">All Compressor Inspections</h3>
            <button class="secondary-btn" onclick="exportCompInspectionsCSV()">Export CSV</button>
          </div>
          <div id="compInspectionTable"></div>
        </div>
      </div>
    </div>

    <!-- TAB 10: COMPRESSOR MAINTENANCE REPORTS -->
    <div class="tab-content" id="tab-compressor-maint" style="display:none;">
      <div class="card">
        <h2>Compressor Maintenance Reports</h2>

        <div class="filterBox">
          <input type="text" id="compMaint_filterId" placeholder="Filter by Compressor ID">
          <input type="text" id="compMaint_filterTech" placeholder="Filter by Technician">
          <input type="date" id="compMaint_filterDate">
          <button class="secondary-btn" onclick="applyCompressorMaintenanceFilters()">Apply</button>
        </div>

        <div class="summary-row" id="compMaintenanceSummary"></div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">All Compressor Maintenance Records</h3>
            <button class="secondary-btn" onclick="exportCompMaintenanceCSV()">Export CSV</button>
          </div>
          <div id="compMaintenanceTable"></div>
        </div>
      </div>
    </div>

    <!-- TAB 11: GENERATOR INSPECTION REPORTS -->
    <div class="tab-content" id="tab-generator-inspections" style="display:none;">
      <div class="card">
        <h2>Generator Inspection Reports</h2>

        <div class="filterBox">
          <input type="text" id="genIns_filterId" placeholder="Filter by Generator ID">
          <input type="text" id="genIns_filterTech" placeholder="Filter by Technician">
          <input type="date" id="genIns_filterDate">
          <button class="secondary-btn" onclick="applyGeneratorInspectionFilters()">Apply</button>
        </div>

        <div class="summary-row" id="genInspectionSummary"></div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">All Generator Inspections</h3>
            <button class="secondary-btn" onclick="exportGenInspectionsCSV()">Export CSV</button>
          </div>
          <div id="genInspectionTable"></div>
        </div>
      </div>
    </div>

    <!-- TAB 12: GENERATOR MAINTENANCE REPORTS -->
    <div class="tab-content" id="tab-generator-maint" style="display:none;">
      <div class="card">
        <h2>Generator Maintenance Reports</h2>

        <div class="filterBox">
          <input type="text" id="genMaint_filterId" placeholder="Filter by Generator ID">
          <input type="text" id="genMaint_filterTech" placeholder="Filter by Technician">
          <input type="date" id="genMaint_filterDate">
          <button class="secondary-btn" onclick="applyGeneratorMaintenanceFilters()">Apply</button>
        </div>

        <div class="summary-row" id="genMaintenanceSummary"></div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0;">All Generator Maintenance</h3>
            <button class="secondary-btn" onclick="exportGenMaintenanceCSV()">Export CSV</button>
          </div>
          <div id="genMaintenanceTable"></div>
        </div>
      </div>
    </div>

    <!-- TAB 13: MASTER DB -->
    <div class="tab-content" id="tab-master-db" style="display:none;">
      <div class="card">
        <h2>Master DB Report</h2>
        <button class="secondary-btn" onclick="exportMasterDB()">Export CSV</button>
        <div id="masterDBTable"></div>
      </div>
    </div>

    <!-- TAB 14: FORM QUESTIONS -->
    <div class="tab-content" id="tab-questions" style="display:none;">
      <div class="card">
        <h2>Form Questions Manager</h2>

        <div class="form-row">
          <div class="form-group">
            <label>Question Text</label>
            <input type="text" id="q_text">
          </div>
          <div class="form-group">
            <label>Type</label>
            <select id="q_type">
              <option value="text">Text</option>
              <option value="number">Number</option>
              <option value="yesno">Yes/No</option>
              <option value="dropdown">Dropdown</option>
            </select>
          </div>
          <div class="form-group">
            <label>Dropdown Options (comma separated)</label>
            <input type="text" id="q_options" placeholder="Only for dropdown">
          </div>
        </div>

        <h3>Apply Question To:</h3>
        <div class="form-row">
          <label><input type="checkbox" id="apply_db_entry"> DB Entry</label>
          <label><input type="checkbox" id="apply_db_inspection"> DB Inspection</label>
          <label><input type="checkbox" id="apply_fault"> Fault Report</label>
          <label><input type="checkbox" id="apply_transformer"> Transformer Report</label>
          <label><input type="checkbox" id="apply_lux"> LUX Report</label>
          <label><input type="checkbox" id="apply_comp_ins"> Compressor Inspection</label>
          <label><input type="checkbox" id="apply_comp_maint"> Compressor Maintenance</label>
          <label><input type="checkbox" id="apply_gen_ins"> Generator Inspection</label>
          <label><input type="checkbox" id="apply_gen_maint"> Generator Maintenance</label>
        </div>

        <button class="primary-btn" onclick="addNewQuestion()">Add Question</button>

        <h3>Existing Questions</h3>
        <div id="questionsTable"></div>
      </div>
    </div>
  </div> <!-- END mainContent -->
</div> <!-- END adminWrapper -->

<!-- FULL-SCREEN PHOTO VIEWER -->
<div class="overlay" id="photoOverlay" onclick="closePhotoOverlay()">
  <img id="overlayImage" src="">
</div>

<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ---------------------------------------------------
    LOGIN SYSTEM
--------------------------------------------------- */
const ADMIN_PIN = "1234";

function checkAdminPIN() {
  const entered = document.getElementById("adminPin").value.trim();
  if (entered === ADMIN_PIN) {
    sessionStorage.setItem("adminLogged", "1");
    document.getElementById("loginOverlay").style.display = "none";
  } else {
    document.getElementById("loginError").innerText = "Incorrect PIN";
  }
}

if (sessionStorage.getItem("adminLogged") === "1") {
  document.getElementById("loginOverlay").style.display = "none";
}

/* ---------------------------------------------------
    DATE & TIME CLOCK
--------------------------------------------------- */
function updateClock() {
  const now = new Date();
  document.getElementById("dateTimeLabel").textContent = now.toLocaleString();
}

setInterval(updateClock, 1000);
updateClock();

/* ---------------------------------------------------
    TAB SWITCHING FUNCTION
--------------------------------------------------- */
function showTab(id, btn) {
  document.querySelectorAll(".tab-content").forEach(t => t.style.display = "none");
  const el = document.getElementById(id);
  if (el) el.style.display = "block";

  document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
}

/* ---------------------------------------------------
    IMAGE VIEWER
--------------------------------------------------- */
function openPhoto(src) {
  const overlay = document.getElementById("photoOverlay");
  const img = document.getElementById("overlayImage");
  img.src = src;
  overlay.style.display = "flex";
}
function closePhotoOverlay() {
  document.getElementById("photoOverlay").style.display = "none";
}

/* ---------------------------------------------------
    GLOBAL ARRAYS FOR ALL REPORTS
--------------------------------------------------- */
let dbInspectionsGlobal = [];
let faultsGlobal = [];
let transformerReportsGlobal = [];
let luxReportsGlobal = [];

let compressorInspectionsGlobal = [];
let compressorMaintenanceGlobal = [];
let generatorInspectionsGlobal = [];
let generatorMaintenanceGlobal = [];

let masterPanelsGlobal = null;
let questionsGlobal = {};

/* ---------------------------------------------------
      LOAD DB ENTRY (Firebase)
--------------------------------------------------- */
function loadDBEntries() {
  firebase.database().ref("panels").on("value", snap => {
    const data = snap.val() || {};
    masterPanelsGlobal = data;

    let html = `
      <table>
        <tr>
          <th>DB ID</th>
          <th>Location</th>
          <th>Feeder</th>
          <th>Rating</th>
          <th>Panel Type</th>
          <th>Panel Make</th>
          <th>Risk</th>
          <th>Remarks</th>
        </tr>
    `;

    Object.values(data).forEach(p => {
      html += `
        <tr>
          <td>${p.dbId || ""}</td>
          <td>${p.location || ""}</td>
          <td>${p.feeder || ""}</td>
          <td>${p.rating || ""}</td>
          <td>${p.panelType || ""}</td>
          <td>${p.panelMake || ""}</td>
          <td>${p.risk || ""}</td>
          <td>${p.remarks || ""}</td>
        </tr>
      `;
    });

    html += "</table>";
    document.getElementById("dbEntryTable").innerHTML = html;
  });
}

/* SAVE DB ENTRY */
function saveDBEntry() {
  const id = document.getElementById("db_id").value.trim();
  if (!id) return alert("Enter DB ID");

  const obj = {
    dbId: id,
    location: document.getElementById("db_location").value,
    feeder: document.getElementById("db_feeder").value,
    rating: document.getElementById("db_rating").value,
    panelType: document.getElementById("db_panelType").value,
    panelMake: document.getElementById("db_panelMake").value,
    risk: document.getElementById("db_risk").value,
    remarks: document.getElementById("db_remarks").value,
  };

  firebase.database().ref("panels/" + id).set(obj, err => {
    if (err) alert("Error saving DB");
    else alert("DB Saved");
  });
}

/* ---------------------------------------------------
      TRANSFORMER ENTRY
--------------------------------------------------- */
function loadTransformerEntries() {
  firebase.database().ref("transformers").on("value", snap => {
    const data = snap.val() || {};

    let html = `
      <table>
        <tr>
          <th>ID</th>
          <th>Location</th>
          <th>Capacity</th>
          <th>Make</th>
          <th>Voltage</th>
          <th>Oil Type</th>
          <th>Risk</th>
          <th>Remarks</th>
        </tr>
    `;

    Object.values(data).forEach(t => {
      html += `
        <tr>
          <td>${t.transformerId || ""}</td>
          <td>${t.location || ""}</td>
          <td>${t.capacity || ""}</td>
          <td>${t.make || ""}</td>
          <td>${t.voltage || ""}</td>
          <td>${t.oilType || ""}</td>
          <td>${t.risk || ""}</td>
          <td>${t.remarks || ""}</td>
        </tr>
      `;
    });

    html += "</table>";
    document.getElementById("transformerEntryTable").innerHTML = html;
  });
}

function saveTransformerEntry() {
  const id = document.getElementById("tr_id").value.trim();
  if (!id) return alert("Enter Transformer ID");

  const obj = {
    transformerId: id,
    location: document.getElementById("tr_location").value,
    capacity: document.getElementById("tr_capacity").value,
    make: document.getElementById("tr_make").value,
    voltage: document.getElementById("tr_voltage").value,
    oilType: document.getElementById("tr_oilType").value,
    risk: document.getElementById("tr_risk").value,
    remarks: document.getElementById("tr_remarks").value
  };

  firebase.database().ref("transformers/" + id).set(obj, err => {
    if (err) alert("Error saving transformer");
    else alert("Transformer Saved");
  });
}

/* ---------------------------------------------------
      COMPRESSOR ENTRY
--------------------------------------------------- */
function loadCompressorEntries() {
  firebase.database().ref("compressors").on("value", snap => {
    const data = snap.val() || {};

    let html = `
      <table>
        <tr>
          <th>ID</th>
          <th>Location</th>
          <th>Model</th>
          <th>Capacity</th>
          <th>Pressure</th>
          <th>Type</th>
        </tr>
    `;

    Object.values(data).forEach(c => {
      html += `
        <tr>
          <td>${c.compressorId || ""}</td>
          <td>${c.location || ""}</td>
          <td>${c.model || ""}</td>
          <td>${c.capacity || ""}</td>
          <td>${c.pressure || ""}</td>
          <td>${c.compressorType || ""}</td>
        </tr>
      `;
    });

    html += "</table>";
    document.getElementById("compressorEntryTable").innerHTML = html;
  });
}

function saveCompressorEntry() {
  const id = document.getElementById("comp_id").value.trim();
  if (!id) return alert("Enter Compressor ID");

  const file = document.getElementById("comp_img").files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    const obj = {
      compressorId: id,
      location: document.getElementById("comp_location").value,
      model: document.getElementById("comp_model").value,
      capacity: document.getElementById("comp_capacity").value,
      pressure: document.getElementById("comp_pressure").value,
      compressorType: document.getElementById("comp_type").value,
      image: e.target.result
    };

    firebase.database().ref("compressors/" + id).set(obj, err => {
      if (err) alert("Error saving compressor");
      else alert("Compressor Saved");
    });
  };

  if (file) reader.readAsDataURL(file);
  else reader.onload({ target: { result: null } });
}

/* ---------------------------------------------------
      GENERATOR ENTRY
--------------------------------------------------- */
function loadGeneratorEntries() {
  firebase.database().ref("generators").on("value", snap => {
    const data = snap.val() || {};

    let html = `
      <table>
        <tr>
          <th>ID</th>
          <th>Location</th>
          <th>Model</th>
          <th>Capacity</th>
          <th>Fuel Type</th>
        </tr>
    `;

    Object.values(data).forEach(g => {
      html += `
        <tr>
          <td>${g.generatorId || ""}</td>
          <td>${g.location || ""}</td>
          <td>${g.model || ""}</td>
          <td>${g.capacity || ""}</td>
          <td>${g.fuelType || ""}</td>
        </tr>
      `;
    });

    html += "</table>";
    document.getElementById("generatorEntryTable").innerHTML = html;
  });
}

function saveGeneratorEntry() {
  const id = document.getElementById("gen_id").value.trim();
  if (!id) return alert("Enter Generator ID");

  const file = document.getElementById("gen_img").files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    const obj = {
      generatorId: id,
      location: document.getElementById("gen_location").value,
      model: document.getElementById("gen_model").value,
      capacity: document.getElementById("gen_capacity").value,
      fuelType: document.getElementById("gen_fuel").value,
      image: e.target.result
    };

    firebase.database().ref("generators/" + id).set(obj, err => {
      if (err) alert("Error saving generator");
      else alert("Generator Saved");
    });
  };

  if (file) reader.readAsDataURL(file);
  else reader.onload({ target: { result: null } });
}
</script>
<script>
/* ---------------------------------------------------
    DB INSPECTION REPORTS
--------------------------------------------------- */
function loadDBInspections() {
  firebase.database().ref("inspections").on("value", snap => {
    const data = snap.val() || {};

    let list = [];
    Object.keys(data).forEach(dbId => {
      Object.values(data[dbId]).forEach(v => {
        list.push({ dbId, ...v });
      });
    });

    dbInspectionsGlobal = list;
    renderDBInspectionSummary(list);
    renderDBInspectionTable(list);
  });
}

function applyDBInspectionFilters() {
  const fId = document.getElementById("dbIns_filterId").value.toLowerCase();
  const fName = document.getElementById("dbIns_filterElec").value.toLowerCase();
  const fDate = document.getElementById("dbIns_filterDate").value;

  let filtered = dbInspectionsGlobal.filter(r =>
    (fId === "" || r.dbId.toLowerCase().includes(fId)) &&
    (fName === "" || (r.electricianName || "").toLowerCase().includes(fName)) &&
    (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );
  renderDBInspectionSummary(filtered);
  renderDBInspectionTable(filtered);
}

function renderDBInspectionSummary(list) {
  const div = document.getElementById("dbInspectionSummary");
  if (!div) return;

  const total = list.length;
  let ok = 0, no = 0;
  list.forEach(r => {
    if ((r.cleanStatus || "").toLowerCase() === "clean") ok++;
    else no++;
  });

  div.innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Reports</div>
      <div class="summary-value">${total}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Clean Panels</div>
      <div class="summary-value">${ok}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Not Clean</div>
      <div class="summary-value">${no}</div>
    </div>
  `;
}

function renderDBInspectionTable(list) {
  if (!document.getElementById("dbInspectionTable")) return;

  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>DB</th>
        <th>Electrician</th>
        <th>Breaker</th>
        <th>Clean?</th>
        <th>Locked?</th>
        <th>Covered?</th>
        <th>Comments</th>
        <th>Photos</th>
      </tr>
  `;

  list.forEach(r => {
    html += `
      <tr>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
        <td>${r.dbId}</td>
        <td>${r.electricianName || ""}</td>
        <td>${r.breakerStatus || ""}</td>
        <td>${r.cleanStatus || ""}</td>
        <td>${r.lockedStatus || ""}</td>
        <td>${r.coveredStatus || ""}</td>
        <td>${r.comments || ""}</td>
        <td>
          ${r.photo1 ? `<button class="photo-btn" onclick="openPhoto('${r.photo1}')">1</button>` : ""}
          ${r.photo2 ? `<button class="photo-btn" onclick="openPhoto('${r.photo2}')">2</button>` : ""}
          ${r.photo3 ? `<button class="photo-btn" onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("dbInspectionTable").innerHTML = html;
}

function exportDBInspectionsCSV() {
  let csv = "Date,DB,Electrician,Breaker,Clean,Locked,Covered,Comments\n";
  dbInspectionsGlobal.forEach(r => {
    csv += `"${new Date(r.timestamp).toLocaleString()}","${r.dbId}","${r.electricianName}",`;
    csv += `"${r.breakerStatus}","${r.cleanStatus}","${r.lockedStatus}","${r.coveredStatus}","${r.comments}"\n`;
  });
  downloadCSV(csv, "DB_Inspections.csv");
}

/* ---------------------------------------------------
    FAULT REPORTS
--------------------------------------------------- */
function loadFaults() {
  firebase.database().ref("faults").on("value", snap => {
    const data = snap.val() || {};

    let list = [];
    Object.keys(data).forEach(dbId => {
      Object.values(data[dbId]).forEach(v => {
        list.push({ dbId, ...v });
      });
    });

    faultsGlobal = list;
    renderFaultSummary(list);
    renderFaultTable(list);
  });
}

function applyFaultFilters() {
  const fId = document.getElementById("fault_filterId").value.toLowerCase();
  const fName = document.getElementById("fault_filterElec").value.toLowerCase();
  const fDate = document.getElementById("fault_filterDate").value;

  let filtered = faultsGlobal.filter(r =>
    (fId === "" || r.dbId.toLowerCase().includes(fId)) &&
    (fName === "" || (r.electricianName || "").toLowerCase().includes(fName)) &&
    (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );
  renderFaultSummary(filtered);
  renderFaultTable(filtered);
}

function renderFaultSummary(list) {
  const total = list.length;
  const today = new Date().toISOString().slice(0,10);
  const tCount = list.filter(r => (r.timestamp || "").startsWith(today)).length;

  document.getElementById("faultSummary").innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Faults</div>
      <div class="summary-value">${total}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Today</div>
      <div class="summary-value">${tCount}</div>
    </div>
  `;
}

function renderFaultTable(list) {
  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>DB</th>
        <th>Electrician</th>
        <th>Type</th>
        <th>Description</th>
        <th>Start</th>
        <th>End</th>
        <th>Downtime (min)</th>
        <th>Prod Loss</th>
        <th>Photos</th>
      </tr>
  `;

  list.forEach(r => {
    html += `
      <tr>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
        <td>${r.dbId}</td>
        <td>${r.electricianName || ""}</td>
        <td>${r.faultType || ""}</td>
        <td>${r.description || ""}</td>
        <td>${r.startTime || ""}</td>
        <td>${r.endTime || ""}</td>
        <td>${r.downtimeMinutes || ""}</td>
        <td>${r.productionLoss || ""}<br>${r.productionLossDesc || ""}</td>
        <td>
          ${r.photo1 ? `<button class="photo-btn" onclick="openPhoto('${r.photo1}')">1</button>` : ""}
          ${r.photo2 ? `<button class="photo-btn" onclick="openPhoto('${r.photo2}')">2</button>` : ""}
          ${r.photo3 ? `<button class="photo-btn" onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("faultTable").innerHTML = html;
}

function exportFaultsCSV() {
  let csv = "Date,DB,Electrician,FaultType,Description,Start,End,Downtime,Loss,LossDesc\n";
  faultsGlobal.forEach(r => {
    csv += `"${new Date(r.timestamp).toLocaleString()}","${r.dbId}","${r.electricianName}",`;
    csv += `"${r.faultType}","${r.description}","${r.startTime}","${r.endTime}",`;
    csv += `"${r.downtimeMinutes}","${r.productionLoss}","${r.productionLossDesc}"\n`;
  });
  downloadCSV(csv, "FaultReports.csv");
}

/* ---------------------------------------------------
    TRANSFORMER REPORTS
--------------------------------------------------- */
function loadTransformerReports() {
  firebase.database().ref("transformerReports").on("value", snap => {
    const data = snap.val() || {};

    let list = [];
    Object.keys(data).forEach(trId => {
      Object.values(data[trId]).forEach(v => {
        list.push({ trId, ...v });
      });
    });

    transformerReportsGlobal = list;
    renderTransformerSummary(list);
    renderTransformerTable(list);
  });
}

function applyTransformerFilters() {
  const fId = document.getElementById("trRpt_filterId").value.toLowerCase();
  const fTech = document.getElementById("trRpt_filterTech").value.toLowerCase();
  const fDate = document.getElementById("trRpt_filterDate").value;

  let filtered = transformerReportsGlobal.filter(r =>
    (fId === "" || r.trId.toLowerCase().includes(fId)) &&
    (fTech === "" || (r.technicianName || "").toLowerCase().includes(fTech)) &&
    (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );
  renderTransformerSummary(filtered);
  renderTransformerTable(filtered);
}

function renderTransformerSummary(list) {
  const div = document.getElementById("transformerSummary");
  if (!div) return;
  div.innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Reports</div>
      <div class="summary-value">${list.length}</div>
    </div>
  `;
}

function renderTransformerTable(list) {
  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>Transformer</th>
        <th>Technician</th>
        <th>Oil Level</th>
        <th>Temp</th>
        <th>Noise</th>
        <th>Leak</th>
        <th>Remarks</th>
        <th>Photos</th>
      </tr>
  `;

  list.forEach(r => {
    html += `
      <tr>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
        <td>${r.trId}</td>
        <td>${r.technicianName || ""}</td>
        <td>${r.oilLevel || ""}</td>
        <td>${r.temperature || ""}</td>
        <td>${r.noise || ""}</td>
        <td>${r.leakCheck || ""}</td>
        <td>${r.remarks || ""}</td>
        <td>
          ${r.photo1 ? `<button class="photo-btn" onclick="openPhoto('${r.photo1}')">1</button>` : ""}
          ${r.photo2 ? `<button class="photo-btn" onclick="openPhoto('${r.photo2}')">2</button>` : ""}
          ${r.photo3 ? `<button class="photo-btn" onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("transformerTable").innerHTML = html;
}

function exportTransformerCSV() {
  let csv = "Date,Transformer,Technician,Oil,Temp,Noise,Leak,Remarks\n";
  transformerReportsGlobal.forEach(r => {
    csv += `"${new Date(r.timestamp).toLocaleString()}","${r.trId}",`;
    csv += `"${r.technicianName}","${r.oilLevel}","${r.temperature}","${r.noise}",`;
    csv += `"${r.leakCheck}","${r.remarks}"\n`;
  });
  downloadCSV(csv, "TransformerReports.csv");
}

/* ---------------------------------------------------
    COMPRESSOR INSPECTION REPORTS
--------------------------------------------------- */
function loadCompressorInspections() {
  firebase.database().ref("compressorInspections").on("value", snap => {
    const data = snap.val() || {};

    let list = [];
    Object.keys(data).forEach(id => {
      Object.values(data[id]).forEach(v => list.push({ compId: id, ...v }));
    });

    compressorInspectionsGlobal = list;
    renderCompInspectionSummary(list);
    renderCompInspectionTable(list);
  });
}

function applyCompressorInspectionFilters() {
  const fId = document.getElementById("compIns_filterId").value.toLowerCase();
  const fTech = document.getElementById("compIns_filterTech").value.toLowerCase();
  const fDate = document.getElementById("compIns_filterDate").value;

  const filtered = compressorInspectionsGlobal.filter(r =>
    (fId === "" || r.compId.toLowerCase().includes(fId)) &&
    (fTech === "" || (r.technicianName || "").toLowerCase().includes(fTech)) &&
    (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );

  renderCompInspectionSummary(filtered);
  renderCompInspectionTable(filtered);
}

function renderCompInspectionSummary(list) {
  document.getElementById("compInspectionSummary").innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Inspections</div>
      <div class="summary-value">${list.length}</div>
    </div>
  `;
}

function renderCompInspectionTable(list) {
  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>Compressor</th>
        <th>Technician</th>
        <th>Oil</th>
        <th>Filter</th>
        <th>Leak</th>
        <th>Hours</th>
        <th>Abnormality</th>
        <th>Dynamic Q</th>
        <th>Photos</th>
      </tr>
  `;

  list.forEach(r => {
    let extra = "";
    if (r.extraAnswers) {
      extra = Object.entries(r.extraAnswers)
        .map(([k, v]) => `${k}: ${v}`)
        .join("<br>");
    }

    html += `
      <tr>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
        <td>${r.compId}</td>
        <td>${r.technicianName || ""}</td>
        <td>${r.oilLevel || ""}</td>
        <td>${r.filterCond || ""}</td>
        <td>${r.leakCheck || ""}</td>
        <td>${r.hourReading || ""}</td>
        <td>${r.abnormality || ""}</td>
        <td>${extra}</td>
        <td>
          ${r.photo1 ? `<button class="photo-btn" onclick="openPhoto('${r.photo1}')">1</button>` : ""}
          ${r.photo2 ? `<button class="photo-btn" onclick="openPhoto('${r.photo2}')">2</button>` : ""}
          ${r.photo3 ? `<button class="photo-btn" onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("compInspectionTable").innerHTML = html;
}

function exportCompInspectionsCSV() {
  let csv = "Date,Compressor,Tech,Oil,Filter,Leak,Hours,Abnormality\n";
  compressorInspectionsGlobal.forEach(r => {
    csv += `"${new Date(r.timestamp).toLocaleString()}","${r.compId}","`;
    csv += `${r.technicianName}","${r.oilLevel}","${r.filterCond}",`;
    csv += `"${r.leakCheck}","${r.hourReading}","${r.abnormality}"\n`;
  });
  downloadCSV(csv, "Compressor_Inspections.csv");
}

/* ---------------------------------------------------
    COMPRESSOR MAINTENANCE REPORTS
--------------------------------------------------- */
function loadCompressorMaintenance() {
  firebase.database().ref("compressorMaintenance").on("value", snap => {
    const data = snap.val() || {};

    let list = [];
    Object.keys(data).forEach(id => {
      Object.values(data[id]).forEach(v => list.push({ compId: id, ...v }));
    });

    compressorMaintenanceGlobal = list;
    renderCompMaintenanceSummary(list);
    renderCompMaintenanceTable(list);
  });
}

function applyCompressorMaintenanceFilters() {
  const fId = document.getElementById("compMaint_filterId").value.toLowerCase();
  const fTech = document.getElementById("compMaint_filterTech").value.toLowerCase();
  const fDate = document.getElementById("compMaint_filterDate").value;

  const filtered = compressorMaintenanceGlobal.filter(r =>
    (fId === "" || r.compId.toLowerCase().includes(fId)) &&
    (fTech === "" || (r.technicianName || "").toLowerCase().includes(fTech)) &&
    (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );

  renderCompMaintenanceSummary(filtered);
  renderCompMaintenanceTable(filtered);
}

function renderCompMaintenanceSummary(list) {
  document.getElementById("compMaintenanceSummary").innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Maintenance</div>
      <div class="summary-value">${list.length}</div>
    </div>
  `;
}

function renderCompMaintenanceTable(list) {
  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>Compressor</th>
        <th>Technician</th>
        <th>Work Done</th>
        <th>Parts</th>
        <th>Dynamic Q</th>
        <th>Photos</th>
      </tr>
  `;

  list.forEach(r => {
    let extra = "";
    if (r.extraAnswers) {
      extra = Object.entries(r.extraAnswers)
        .map(([k, v]) => `${k}: ${v}`)
        .join("<br>");
    }

    html += `
      <tr>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
        <td>${r.compId}</td>
        <td>${r.technicianName || ""}</td>
        <td>${r.workDone || ""}</td>
        <td>${r.partsReplaced || ""}</td>
        <td>${extra}</td>
        <td>
          ${r.photo1 ? `<button class="photo-btn" onclick="openPhoto('${r.photo1}')">1</button>` : ""}
          ${r.photo2 ? `<button class="photo-btn" onclick="openPhoto('${r.photo2}')">2</button>` : ""}
          ${r.photo3 ? `<button class="photo-btn" onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("compMaintenanceTable").innerHTML = html;
}

function exportCompMaintenanceCSV() {
  let csv = "Date,Compressor,Tech,WorkDone,Parts\n";
  compressorMaintenanceGlobal.forEach(r => {
    csv += `"${new Date(r.timestamp).toLocaleString()}","${r.compId}","${r.technicianName}",`;
    csv += `"${r.workDone}","${r.partsReplaced}"\n`;
  });
  downloadCSV(csv, "Compressor_Maintenance.csv");
}

/* ---------------------------------------------------
    GENERATOR INSPECTION REPORTS
--------------------------------------------------- */
function loadGeneratorInspections() {
  firebase.database().ref("generatorInspections").on("value", snap => {
    const data = snap.val() || {};

    let list = [];
    Object.keys(data).forEach(id => {
      Object.values(data[id]).forEach(v => list.push({ genId: id, ...v }));
    });

    generatorInspectionsGlobal = list;
    renderGenInspectionSummary(list);
    renderGenInspectionTable(list);
  });
}

function applyGeneratorInspectionFilters() {
  const fId = document.getElementById("genIns_filterId").value.toLowerCase();
  const fTech = document.getElementById("genIns_filterTech").value.toLowerCase();
  const fDate = document.getElementById("genIns_filterDate").value;

  const filtered = generatorInspectionsGlobal.filter(r =>
    (fId === "" || r.genId.toLowerCase().includes(fId)) &&
    (fTech === "" || (r.technicianName || "").toLowerCase().includes(fTech)) &&
    (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );

  renderGenInspectionSummary(filtered);
  renderGenInspectionTable(filtered);
}

function renderGenInspectionSummary(list) {
  document.getElementById("genInspectionSummary").innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Inspections</div>
      <div class="summary-value">${list.length}</div>
    </div>
  `;
}

function renderGenInspectionTable(list) {
  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>Generator</th>
        <th>Technician</th>
        <th>Fuel %</th>
        <th>Oil</th>
        <th>Battery</th>
        <th>Water</th>
        <th>Voltage</th>
        <th>Freq</th>
        <th>Temp</th>
        <th>Hours</th>
        <th>Warning</th>
        <th>Dynamic Q</th>
        <th>Photos</th>
      </tr>
  `;

  list.forEach(r => {
    let extra = "";
    if (r.extraAnswers) {
      extra = Object.entries(r.extraAnswers)
        .map(([k, v]) => `${k}: ${v}`)
        .join("<br>");
    }

    html += `
      <tr>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
        <td>${r.genId}</td>
        <td>${r.technicianName || ""}</td>
        <td>${r.fuelLevel || ""}</td>
        <td>${r.oilLevel || ""}</td>
        <td>${r.batteryCond || ""}</td>
        <td>${r.waterLevel || ""}</td>
        <td>${r.voltageOutput || ""}</td>
        <td>${r.frequencyHz || ""}</td>
        <td>${r.temperatureC || ""}</td>
        <td>${r.runningHours || ""}</td>
        <td>${r.warningIndicate || ""}</td>
        <td>${extra}</td>
        <td>
          ${r.photo1 ? `<button class="photo-btn" onclick="openPhoto('${r.photo1}')">1</button>` : ""}
          ${r.photo2 ? `<button class="photo-btn" onclick="openPhoto('${r.photo2}')">2</button>` : ""}
          ${r.photo3 ? `<button class="photo-btn" onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("genInspectionTable").innerHTML = html;
}

function exportGenInspectionsCSV() {
  let csv = "Date,Gen,Tech,Fuel,Oil,Battery,Water,Voltage,Freq,Temp,Hours,Warning\n";
  generatorInspectionsGlobal.forEach(r => {
    csv += `"${new Date(r.timestamp).toLocaleString()}","${r.genId}","${r.technicianName}",`;
    csv += `"${r.fuelLevel}","${r.oilLevel}","${r.batteryCond}","${r.waterLevel}",`;
    csv += `"${r.voltageOutput}","${r.frequencyHz}","${r.temperatureC}",`;
    csv += `"${r.runningHours}","${r.warningIndicate}"\n`;
  });
  downloadCSV(csv, "Generator_Inspections.csv");
}

/* ---------------------------------------------------
    GENERATOR MAINTENANCE REPORTS
--------------------------------------------------- */
function loadGeneratorMaintenance() {
  firebase.database().ref("generatorMaintenance").on("value", snap => {
    const data = snap.val() || {};

    let list = [];
    Object.keys(data).forEach(id => {
      Object.values(data[id]).forEach(v => list.push({ genId: id, ...v }));
    });

    generatorMaintenanceGlobal = list;
    renderGenMaintenanceSummary(list);
    renderGenMaintenanceTable(list);
  });
}

function applyGeneratorMaintenanceFilters() {
  const fId = document.getElementById("genMaint_filterId").value.toLowerCase();
  const fTech = document.getElementById("genMaint_filterTech").value.toLowerCase();
  const fDate = document.getElementById("genMaint_filterDate").value;

  const filtered = generatorMaintenanceGlobal.filter(r =>
    (fId === "" || r.genId.toLowerCase().includes(fId)) &&
    (fTech === "" || (r.technician
function applyGeneratorMaintenanceFilters() {
  const fId = document.getElementById("genMaint_filterId").value.toLowerCase();
  const fTech = document.getElementById("genMaint_filterTech").value.toLowerCase();
  const fDate = document.getElementById("genMaint_filterDate").value;

  const filtered = generatorMaintenanceGlobal.filter(r =>
    (fId === "" || r.genId.toLowerCase().includes(fId)) &&
    (fTech === "" || (r.technicianName || "").toLowerCase().includes(fTech)) &&
    (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );

  renderGenMaintenanceSummary(filtered);
  renderGenMaintenanceTable(filtered);
}

function renderGenMaintenanceSummary(list) {
  document.getElementById("genMaintenanceSummary").innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Maintenance</div>
      <div class="summary-value">${list.length}</div>
    </div>
  `;
}

function renderGenMaintenanceTable(list) {
  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>Generator</th>
        <th>Technician</th>
        <th>Work Done</th>
        <th>Parts</th>
        <th>Dynamic Q</th>
        <th>Photos</th>
      </tr>
  `;

  list.forEach(r => {
    let extra = "";
    if (r.extraAnswers) {
      extra = Object.entries(r.extraAnswers)
        .map(([k, v]) => `${k}: ${v}`)
        .join("<br>");
    }

    html += `
      <tr>
        <td>${new Date(r.timestamp).toLocaleString()}</td>
        <td>${r.genId}</td>
        <td>${r.technicianName || ""}</td>
        <td>${r.workDone || ""}</td>
        <td>${r.partsReplaced || ""}</td>
        <td>${extra}</td>
        <td>
          ${r.photo1 ? `<button class="photo-btn" onclick="openPhoto('${r.photo1}')">1</button>` : ""}
          ${r.photo2 ? `<button class="photo-btn" onclick="openPhoto('${r.photo2}')">2</button>` : ""}
          ${r.photo3 ? `<button class="photo-btn" onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("genMaintenanceTable").innerHTML = html;
}

function exportGenMaintenanceCSV() {
  let csv = "Date,Gen,Tech,WorkDone,Parts\n";
  generatorMaintenanceGlobal.forEach(r => {
    csv += `"${new Date(r.timestamp).toLocaleString()}","${r.genId}","${r.technicianName}",`;
    csv += `"${r.workDone}","${r.partsReplaced}"\n`;
  });
  downloadCSV(csv, "Generator_Maintenance.csv");
}

/* ---------------------------------------------------
    MASTER DB EXPORT
--------------------------------------------------- */
function exportMasterDB() {
  if (!masterPanelsGlobal) return alert("No DB entry data loaded.");

  let csv = "DB ID,Location,Feeder,Rating,PanelType,PanelMake,Risk,Remarks\n";
  Object.values(masterPanelsGlobal).forEach(p => {
    csv += `"${p.dbId}","${p.location}","${p.feeder}","${p.rating}",`;
    csv += `"${p.panelType}","${p.panelMake}","${p.risk}","${p.remarks}"\n`;
  });

  downloadCSV(csv, "Master_DB.csv");
}
/* ---------------------------------------------------
    LUX REPORTS (LOAD + RENDER + SORT + PDF + COMPARE)
--------------------------------------------------- */

let luxSortMode = "none";            // "none" | "maxDesc" | "maxAsc"
let luxCompareSelection = [];        // up to 2 photos

function loadLuxReports() {
  firebase.database().ref("luxReports").on("value", snap => {
    const data = snap.val() || {};
    const list = [];

    Object.keys(data).forEach(key => {
      const r = data[key];
      list.push({
        key,
        department: r.department || "",
        monitorType: r.monitorType || "",
        electricianName: r.electricianName || "",
        meterModel: r.meterModel || "",
        calibrationNo: r.calibrationNo || "",
        calibrationDate: r.calibrationDate || "",
        date: r.date || "",
        time: r.time || "",
        meterPhoto: r.meterPhoto || "",
        measurements: r.measurements || []
      });
    });

    luxReportsGlobal = list;
    updateLuxSummary(list);
    renderLuxTable(list);
  });
}

function updateLuxSummary(list) {
  const container = document.getElementById("luxSummary");
  if (!container) return;
  if (!list || !list.length) {
    container.innerHTML = "<p>No LUX reports.</p>";
    return;
  }

  const total = list.length;
  const depts = new Set(list.map(r => r.department)).size;

  // Total measurements
  let totalMeas = 0;
  list.forEach(r => {
    totalMeas += (r.measurements && r.measurements.length) ? r.measurements.length : 0;
  });

  // Today count (by date only)
  const today = new Date().toISOString().slice(0,10);
  const todayCount = list.filter(r => (r.date || "").slice(0,10) === today).length;

  container.innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total LUX Reports</div>
      <div class="summary-value">${total}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Departments</div>
      <div class="summary-value">${depts}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Total Measurements</div>
      <div class="summary-value">${totalMeas}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Reports Today</div>
      <div class="summary-value">${todayCount}</div>
    </div>
  `;
}

function setLuxSort(mode) {
  luxSortMode = mode;          // "none", "maxDesc", "maxAsc"
  renderLuxTable(luxReportsGlobal);
}

function renderLuxTable(list) {
  const container = document.getElementById("luxTable");
  if (!container) return;
  if (!list || !list.length) {
    container.innerHTML = "<p>No LUX reports.</p>";
    return;
  }

  // Apply sorting by max measured Lux
  let data = [...list];
  if (luxSortMode === "maxDesc" || luxSortMode === "maxAsc") {
    data.sort((a, b) => {
      const maxA = (a.measurements || []).reduce((mx, m) => {
        const v = Number(m.measuredLux) || 0;
        return v > mx ? v : mx;
      }, 0);
      const maxB = (b.measurements || []).reduce((mx, m) => {
        const v = Number(m.measuredLux) || 0;
        return v > mx ? v : mx;
      }, 0);
      return luxSortMode === "maxDesc" ? maxB - maxA : maxA - maxB;
    });
  }

  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>Dept</th>
        <th>Type</th>
        <th>Electrician</th>
        <th>Meter / Calib</th>
        <th>Measurements</th>
        <th>Photos / Action</th>
      </tr>
  `;

  data.forEach(r => {
    const measCount = (r.measurements && r.measurements.length) ? r.measurements.length : 0;
    let measText = "";
    if (measCount) {
      measText = r.measurements.map((m, i) => {
        return `${i+1}. ${m.point || ""}: ${m.measuredLux || ""} lx (Limit: ${m.limitLux || ""})`;
      }).join("<br>");
    }

    html += `
      <tr>
        <td>${r.date || ""} ${r.time || ""}</td>
        <td>${r.department || ""}</td>
        <td>${r.monitorType || ""}</td>
        <td>${r.electricianName || ""}</td>
        <td>
          ${r.meterModel || ""}<br>
          Cert: ${r.calibrationNo || ""} (${r.calibrationDate || ""})
        </td>
        <td>${measText}</td>
        <td>
          ${r.meterPhoto ? `<button class='photo-btn' onclick="openPhoto('${r.meterPhoto}')">Meter</button>` : ""}
          ${r.meterPhoto ? `<button class='photo-btn' onclick="addLuxCompare('${r.meterPhoto}')">Compare</button>` : ""}
          <button class="danger-btn" onclick="deleteLuxReport('${r.key}')">Delete</button>
        </td>
      </tr>
    `;
  });

  html += "</table>";
  container.innerHTML = html;
}

// Photo compare: select 2 meter photos and open side-by-side
function addLuxCompare(photoUrl) {
  if (!photoUrl) return;

  if (!luxCompareSelection.includes(photoUrl)) {
    luxCompareSelection.push(photoUrl);
  }

  if (luxCompareSelection.length < 2) {
    alert("First photo selected. Click 'Compare' on another LUX report to open comparison.");
    return;
  }

  const [p1, p2] = luxCompareSelection.slice(0, 2);
  const win = window.open("", "_blank");
  win.document.write(`
    <html>
    <head>
      <title>LUX Photo Comparison</title>
      <style>
        body { margin:0; padding:10px; font-family:Arial,sans-serif; background:#111; color:#fff; }
        .wrap { display:flex; gap:10px; justify-content:space-around; align-items:flex-start; flex-wrap:wrap; }
        img { max-width:48%; border:3px solid #fff; border-radius:8px; }
        h2 { text-align:center; }
      </style>
    </head>
    <body>
      <h2>LUX Meter Photo Comparison</h2>
      <div class="wrap">
        <img src="${p1}" alt="Photo 1">
        <img src="${p2}" alt="Photo 2">
      </div>
    </body>
    </html>
  `);

  luxCompareSelection = [];
}

function deleteLuxReport(key) {
  if (!confirm("Delete this LUX report?")) return;
  firebase.database().ref("luxReports/" + key).remove(err => {
    if (err) alert("Error deleting LUX report");
  });
}

function exportLuxCSV() {
  if (!luxReportsGlobal.length) {
    alert("No LUX data to export.");
    return;
  }
  let csv = "Date,Department,Type,Electrician,Meter,CalibrationNo,CalibrationDate,Point,MeasuredLux,LimitLux\n";
  luxReportsGlobal.forEach(r => {
    (r.measurements || []).forEach(m => {
      csv += `"${r.date} ${r.time}","${r.department}","${r.monitorType}","${r.electricianName}",`;
      csv += `"${r.meterModel}","${r.calibrationNo}","${r.calibrationDate}",`;
      csv += `"${m.point}","${m.measuredLux}","${m.limitLux}"\n`;
    });
    if (!r.measurements || !r.measurements.length) {
      csv += `"${r.date} ${r.time}","${r.department}","${r.monitorType}","${r.electricianName}",`;
      csv += `"${r.meterModel}","${r.calibrationNo}","${r.calibrationDate}","","",""\n`;
    }
  });
  downloadCSV(csv, "LUX_Reports.csv");
}

function exportLuxPDF() {
  if (!luxReportsGlobal.length) {
    alert("No LUX data to export.");
    return;
  }
  if (!window.jspdf) {
    alert("PDF library (jsPDF) not loaded.");
    return;
  }
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: "pt", format: "a4" });

  let y = 60;

  const logo = new Image();
  logo.src = "logo.png";

  logo.onload = () => {
    try {
      pdf.addImage(logo, "PNG", 40, 20, 100, 40);
    } catch(e) {}

    pdf.setFont("helvetica", "bold");
    pdf.setFontSize(18);
    pdf.text("LUX Monitoring Report", 200, 40);

    pdf.setFontSize(10);
    pdf.text("Generated: " + new Date().toLocaleString(), 200, 55);

    y = 90;

    luxReportsGlobal.forEach((r, idx) => {
      if (y > 730) {
        pdf.addPage();
        y = 60;
      }

      pdf.setFontSize(12);
      pdf.setFont("helvetica", "bold");
      pdf.text(`Report ${idx+1}`, 40, y); 
      y += 15;

      pdf.setFont("helvetica", "normal");
      pdf.text(`Date: ${r.date || ""} ${r.time || ""}`, 40, y); y += 14;
      pdf.text(`Department: ${r.department || ""}`, 40, y); y += 14;
      pdf.text(`Type: ${r.monitorType || ""}`, 40, y); y += 14;
      pdf.text(`Electrician: ${r.electricianName || ""}`, 40, y); y += 14;
      pdf.text(`Meter: ${r.meterModel || ""}`, 40, y); y += 14;
      pdf.text(`Calibration: ${r.calibrationNo || ""} (${r.calibrationDate || ""})`, 40, y); y += 18;

      pdf.setFont("helvetica", "bold");
      pdf.text("Measurements:", 40, y); 
      y += 14;
      pdf.setFont("helvetica", "normal");

      (r.measurements || []).forEach((m, i) => {
        const line = `${i+1}. ${m.point || ""}: ${m.measuredLux || ""} lx (Limit: ${m.limitLux || ""})`;
        if (y > 730) {
          pdf.addPage();
          y = 60;
        }
        pdf.text(line, 60, y);
        y += 12;
      });

      if (r.meterPhoto) {
        if (y > 650) {
          pdf.addPage();
          y = 60;
        }
        try {
          const img = new Image();
          img.src = r.meterPhoto;
          pdf.text("Meter Photo:", 40, y); 
          y += 12;
          pdf.addImage(img, "JPEG", 40, y, 200, 140);
          y += 150;
        } catch(e) {}
      }

      pdf.setDrawColor(180);
      pdf.line(30, y, 560, y);
      y += 15;
    });

    pdf.save("LUX_Reports.pdf");
  };

  logo.onerror = () => {
    alert("Logo (logo.png) not found. PDF will still generate but without logo.");
};

/* ---------------------------------------------------
    FORM QUESTIONS SYSTEM
--------------------------------------------------- */

function loadQuestions() {
  firebase.database().ref("questions").on("value", snap => {
    questionsGlobal = snap.val() || {};
    renderQuestionsTable();
  });
}

function addNewQuestion() {
  const text = document.getElementById("q_text").value.trim();
  if (!text) return alert("Enter question text.");

  const type = document.getElementById("q_type").value;
  const optsRaw = document.getElementById("q_options").value.trim();
  const options = optsRaw ? optsRaw.split(",").map(s => s.trim()).filter(Boolean) : [];

  const q = {
    text,
    type,
    options,
    applyDbEntry: document.getElementById("apply_db_entry").checked || false,
    applyDbInspection: document.getElementById("apply_db_inspection").checked || false,
    applyFault: document.getElementById("apply_fault").checked || false,
    applyTransformer: document.getElementById("apply_transformer").checked || false,
    applyLux: document.getElementById("apply_lux").checked || false,
    applyCompressorInspection: document.getElementById("apply_comp_ins").checked || false,
    applyCompressorMaintenance: document.getElementById("apply_comp_maint").checked || false,
    applyGeneratorInspection: document.getElementById("apply_gen_ins").checked || false,
    applyGeneratorMaintenance: document.getElementById("apply_gen_maint").checked || false,
    active: true
  };

  firebase.database().ref("questions").push(q, err => {
    if (err) alert("Error adding question");
    else {
      alert("Question added.");
      document.getElementById("q_text").value = "";
      document.getElementById("q_options").value = "";
      document.querySelectorAll("#tab-questions input[type=checkbox]").forEach(c => c.checked = false);
    }
  });
}

function renderQuestionsTable() {
  const div = document.getElementById("questionsTable");
  if (!div) return;

  const entries = Object.entries(questionsGlobal);
  if (!entries.length) {
    div.innerHTML = "<p>No questions defined.</p>";
    return;
  }

  let html = `
    <table>
      <tr>
        <th>Text</th>
        <th>Type</th>
        <th>Applies To</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
  `;

  entries.forEach(([id, q]) => {
    const tags = [];
    if (q.applyDbEntry) tags.push("DB Entry");
    if (q.applyDbInspection) tags.push("DB Inspection");
    if (q.applyFault) tags.push("Fault");
    if (q.applyTransformer) tags.push("Transformer");
    if (q.applyLux) tags.push("LUX");
    if (q.applyCompressorInspection) tags.push("Comp Insp");
    if (q.applyCompressorMaintenance) tags.push("Comp Maint");
    if (q.applyGeneratorInspection) tags.push("Gen Insp");
    if (q.applyGeneratorMaintenance) tags.push("Gen Maint");

    const status = q.active === false ? "Disabled" : "Active";

    html += `
      <tr>
        <td>${q.text || ""}</td>
        <td>${q.type || ""}</td>
        <td>${tags.join(", ")}</td>
        <td>${status}</td>
        <td>
          <button class="secondary-btn" onclick="toggleQuestionActive('${id}', ${q.active === false ? "false" : "true"})">
            ${q.active === false ? "Enable" : "Disable"}
          </button>
          <button class="danger-btn" onclick="deleteQuestion('${id}')">Delete</button>
        </td>
      </tr>
    `;
  });

  html += "</table>";
  div.innerHTML = html;
}

function toggleQuestionActive(id, isActive) {
  const newVal = !isActive;
  firebase.database().ref("questions/" + id + "/active").set(newVal, err => {
    if (err) alert("Error updating question.");
  });
}

function deleteQuestion(id) {
  if (!confirm("Delete this question?")) return;
  firebase.database().ref("questions/" + id).remove(err => {
    if (err) alert("Error deleting question.");
  });
}

/* ---------------------------------------------------
    CSV DOWNLOAD HELPER
--------------------------------------------------- */
function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  const url = URL.createObjectURL(blob);
  link.setAttribute("href", url);
  link.setAttribute("download", filename);
  link.style.visibility = "hidden";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* ---------------------------------------------------
    INITIAL LOAD
--------------------------------------------------- */
window.addEventListener("load", () => {
  loadDBEntries();
  loadTransformerEntries();
  loadCompressorEntries();
  loadGeneratorEntries();

  loadDBInspections();
  loadFaults();
  loadTransformerReports();
  loadLuxReports();

  loadCompressorInspections();
  loadCompressorMaintenance();
  loadGeneratorInspections();
  loadGeneratorMaintenance();

  loadQuestions();
});
</script>

</body>
</html>
