<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Your Firebase helper (firebaseConfig + savePanelToFirebase + loadPanelFromFirebase + loadAllPanels etc.) -->
  <script src="data.js"></script>

  <!-- QR Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f2f4f7;
    }

    /* TOP BAR */
    .topbar {
      background: #111;
      color: #ffc800;
      padding: 16px 24px;
      font-size: 22px;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    /* TABS */
    .tabs {
      display: flex;
      justify-content: center;
      background: #1e1e1e;
      padding: 8px;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border: none;
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 999px;
      cursor: pointer;
      background: #333;
      color: #eee;
      transition: background 0.2s, transform 0.1s;
    }

    .tab-btn:hover {
      background: #444;
      transform: translateY(-1px);
    }

    .tab-btn.active {
      background: #ffc800;
      color: #111;
      font-weight: bold;
    }

    .tab-wrapper {
      padding: 20px;
      max-width: 1100px;
      margin: 0 auto 40px auto;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* LOGIN */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #loginBox {
      background: #fff;
      padding: 25px 30px;
      border-radius: 10px;
      max-width: 320px;
      width: 90%;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    }
    #loginBox input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
    }
    #loginBox button {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      font-size: 16px;
      cursor: pointer;
      background: #c40000;
      border: none;
      color: #fff;
      border-radius: 6px;
    }
    #loginError {
      color: red;
      font-size: 14px;
      margin-top: 8px;
    }

    /* CARD STYLE FOR EACH TAB SECTION */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      margin-bottom: 20px;
    }

    h2, h3 {
      margin-top: 0;
    }

    /* FORM ELEMENTS (ENTRY TAB) */
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="file"] {
      width: 300px;
      padding: 8px;
      font-size: 16px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
    }

    #previewImage {
      width: 200px;
      margin-top: 10px;
      border: 2px solid #444;
      border-radius: 6px;
      display: none;
    }

    /* CIRCUITS (ENTRY TAB) */
    .circuit-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .circuit-row input {
      flex: 1;
      min-width: 120px;
    }
    .circuit-remove-btn {
      background: #c40000;
      color: white;
      border-radius: 4px;
      padding: 0 8px;
      cursor: pointer;
    }

    /* QR PREVIEW */
    #qrPreview {
      text-align: center;
      margin-top: 20px;
    }
    .dangerBanner {
      background: #c40000;
      color: #fff;
      padding: 10px 12px;
      font-weight: bold;
      border-radius: 8px;
      max-width: 460px;
      margin: 0 auto 15px auto;
      font-size: 16px;
    }
    #qrCanvas {
      border: 1px solid #ccc;
      padding: 10px;
      background: #fff;
    }
    #qrDBname {
      font-size: 22px;
      font-weight: bold;
      margin-top: 12px;
      color: #111;
    }

    /* TABLES (REPORT TABS) */
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      font-size: 14px;
    }
    th {
      background: #333;
      color: white;
      padding: 8px;
    }
    td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: top;
    }
    tr:nth-child(even) { background: #f9f9f9; }

    .photo-btn {
      background: #007bff;
      color: white;
      padding: 4px 6px;
      border-radius: 5px;
      cursor: pointer;
      border: none;
      font-size: 12px;
    }

    .filterBox {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .filterBox input, .filterBox select {
      padding: 6px 8px;
      font-size: 14px;
    }

    .primary-btn {
      background:#007bff;
      color:#fff;
    }
    .danger-btn {
      background:#c40000;
      color:#fff;
    }
    .secondary-btn {
      background:#555;
      color:#fff;
    }
  </style>
</head>

<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Password">
    <button onclick="checkLogin()">Login</button>
    <div id="loginError"></div>
  </div>
</div>

<!-- MAIN ADMIN DASHBOARD -->
<div id="adminWrapper" style="display:none;">

  <div class="topbar">Admin Dashboard – Electrical Panels</div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" data-target="tab-entry">DB Entry</button>
    <button class="tab-btn" data-target="tab-inspections">Inspection Reports</button>
    <button class="tab-btn" data-target="tab-faults">Fault Reports</button>
    <button class="tab-btn" data-target="tab-master">Master DB Report</button>
  </div>

  <div class="tab-wrapper">

    <!-- TAB 1: DB ENTRY (original admin.html content) -->
    <div class="tab-content active" id="tab-entry">
      <div class="card">
        <h2>DB Entry / Panel Data</h2>

        <label>DB Number</label>
        <input id="db" type="text">

        <label>Voltage Rating</label>
        <input id="volt" type="text">

        <label>Main Breaker Capacity</label>
        <input id="breaker" type="text">

        <label>Main Cable Size</label>
        <input id="cable" type="text">

        <label>Earth Status</label>
        <input id="earth" type="text">

        <label>Location</label>
        <input id="location" type="text">

        <label>Purpose</label>
        <input id="purpose" type="text">

        <label>Upload Panel Picture (Optional)</label>
        <input type="file" id="imageInput" accept="image/*" onchange="previewAndCompress(event)">
        <br>
        <img id="previewImage">
        <br>
        <button type="button" class="secondary-btn" onclick="removeImage()">Remove Picture</button>

        <h3 style="margin-top:20px;">Circuits (Name / Breaker / Load)</h3>
        <div id="circuitsContainer"></div>
        <button type="button" class="secondary-btn" onclick="addCircuitRow()">Add Circuit</button>

        <br><br>
        <button class="primary-btn" onclick="savePanel()">Save Data (to Firebase)</button>

        <hr>

        <h3>Generate QR Code</h3>
        <button class="secondary-btn" onclick="generateQR()">Generate QR Code</button>

        <!-- On-screen QR + banner preview -->
        <div id="qrPreview">
          <div class="dangerBanner">
            ⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️
          </div>
          <canvas id="qrCanvas" width="250" height="250"></canvas>
          <div id="qrDBname"></div>
        </div>

        <button id="downloadQR" style="display:none;" class="primary-btn" onclick="downloadQR()">Download QR Sheet</button>
      </div>

      <div class="card">
        <h2>All Panels</h2>
        <button class="secondary-btn" onclick="showPanels()">Refresh Panel List</button>
        <div id="panelList" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- TAB 2: INSPECTION REPORTS -->
    <div class="tab-content" id="tab-inspections">
      <div class="card">
        <h2>Inspection Reports</h2>

        <div class="filterBox">
          <input type="text" id="filterDB_i" placeholder="Filter by DB Number">
          <input type="text" id="filterElec_i" placeholder="Filter by Electrician">
          <input type="date" id="filterDate_i">
          <button class="secondary-btn" onclick="applyInspectionFilters()">Apply Filters</button>
        </div>

        <div id="inspectionTable"></div>
      </div>
    </div>

    <!-- TAB 3: FAULT REPORTS -->
    <div class="tab-content" id="tab-faults">
      <div class="card">
        <h2>Fault Reports</h2>

        <div class="filterBox">
          <input type="text" id="filterDB_f" placeholder="Filter by DB Number">
          <input type="text" id="filterElec_f" placeholder="Filter by Electrician">
          <input type="date" id="filterDate_f">
          <button class="secondary-btn" onclick="applyFaultFilters()">Apply Filters</button>
        </div>

        <div id="faultTable"></div>
      </div>
    </div>

    <!-- TAB 4: MASTER DB REPORT -->
    <div class="tab-content" id="tab-master">
      <div class="card">
        <h2>Master DB Report (All DBs & Circuits)</h2>
        <button class="secondary-btn" onclick="loadMasterReport()">Reload Data</button>
        <div id="masterContainer" style="margin-top:15px;"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ------------ LOGIN ------------ */
const ADMIN_PASSWORD = "1234";

function checkLogin() {
  const pwd = document.getElementById("adminPassword").value.trim();
  const error = document.getElementById("loginError");

  if (pwd === ADMIN_PASSWORD) {
    sessionStorage.setItem("adminDashboardLogged", "true");
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("adminWrapper").style.display = "block";
    afterLoginInit();
  } else {
    error.textContent = "Incorrect password.";
  }
}

window.addEventListener("load", () => {
  if (sessionStorage.getItem("adminDashboardLogged") === "true") {
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("adminWrapper").style.display = "block";
    afterLoginInit();
  }
});

/* ------------ AFTER LOGIN INIT ------------ */
function afterLoginInit() {
  initTabs();
  renderCircuits(null);       // at least one circuit row
  showPanels();               // load panel list
  loadReports();              // inspections + faults
  loadMasterReport();         // master DB report
}

/* ------------ TABS HANDLING ------------ */
function initTabs() {
  const buttons = document.querySelectorAll(".tab-btn");
  const tabs = document.querySelectorAll(".tab-content");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      const targetId = btn.getAttribute("data-target");

      buttons.forEach(b => b.classList.remove("active"));
      tabs.forEach(t => t.classList.remove("active"));

      btn.classList.add("active");
      document.getElementById(targetId).classList.add("active");
    });
  });
}

/* ------------ IMAGE HANDLING (ENTRY TAB) ------------ */
let uploadedImage = null;

function previewAndCompress(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const maxWidth = 800;
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = img.height * scale;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      uploadedImage = canvas.toDataURL("image/jpeg", 0.7);

      const preview = document.getElementById("previewImage");
      preview.src = uploadedImage;
      preview.style.display = "block";
    };
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  uploadedImage = null;
  document.getElementById("previewImage").style.display = "none";
  document.getElementById("imageInput").value = "";
}

/* ------------ CIRCUITS (ENTRY TAB) ------------ */
function addCircuitRow(name = "", breaker = "", load = "") {
  const container = document.getElementById("circuitsContainer");
  const row = document.createElement("div");
  row.className = "circuit-row";
  row.innerHTML = `
    <input class="c-name" placeholder="Circuit name" value="${name}">
    <input class="c-breaker" placeholder="Breaker (e.g. 10A)" value="${breaker}">
    <input class="c-load" placeholder="Load / Description" value="${load}">
    <button type="button" class="circuit-remove-btn" onclick="this.parentElement.remove()">X</button>
  `;
  container.appendChild(row);
}

function renderCircuits(circuits) {
  const container = document.getElementById("circuitsContainer");
  container.innerHTML = "";
  if (circuits) {
    const list = Array.isArray(circuits) ? circuits : Object.values(circuits);
    list.forEach(c => addCircuitRow(c.name || "", c.breaker || "", c.load || ""));
  } else {
    addCircuitRow();
  }
}

function collectCircuitsFromForm() {
  const rows = document.querySelectorAll(".circuit-row");
  const circuits = [];
  rows.forEach(row => {
    const name = row.querySelector(".c-name").value.trim();
    const br   = row.querySelector(".c-breaker").value.trim();
    const ld   = row.querySelector(".c-load").value.trim();
    if (name || br || ld) {
      circuits.push({ name, breaker: br, load: ld });
    }
  });
  return circuits.length ? circuits : null;
}

/* ------------ SAVE PANEL (ENTRY TAB) ------------ */
function savePanel() {
  const id = document.getElementById("db").value.trim();
  if (!id) {
    alert("Enter DB Number!");
    return;
  }

  const data = {
    dbNumber: id,
    voltage: document.getElementById("volt").value,
    mainBreaker: document.getElementById("breaker").value,
    cableSize: document.getElementById("cable").value,
    earthStatus: document.getElementById("earth").value,
    location: document.getElementById("location").value,
    purpose: document.getElementById("purpose").value,
    image: uploadedImage || null,
    circuits: collectCircuitsFromForm()
  };

  savePanelToFirebase(id, data, () => {
    alert("Panel saved to Firebase successfully!");
    showPanels();
  });
}

/* ------------ EDIT / DELETE / LIST PANELS (ENTRY TAB) ------------ */
function editPanel(id) {
  loadPanelFromFirebase(id, p => {
    if (!p) {
      alert("Panel not found!");
      return;
    }

    document.getElementById("db").value        = p.dbNumber || id;
    document.getElementById("volt").value      = p.voltage || "";
    document.getElementById("breaker").value   = p.mainBreaker || "";
    document.getElementById("cable").value     = p.cableSize || "";
    document.getElementById("earth").value     = p.earthStatus || "";
    document.getElementById("location").value  = p.location || "";
    document.getElementById("purpose").value   = p.purpose || "";

    uploadedImage = p.image || null;
    const preview = document.getElementById("previewImage");
    if (uploadedImage) {
      preview.src = uploadedImage;
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
    }

    renderCircuits(p.circuits || null);

    // switch to Entry tab automatically
    document.querySelector('.tab-btn[data-target="tab-entry"]').click();
    window.scrollTo(0, 0);
  });
}

function deletePanel(id) {
  if (!confirm("Are you sure you want to delete panel " + id + " ?")) return;
  firebase.database().ref("panels/" + id).remove().then(() => {
    alert("Panel " + id + " deleted.");
    showPanels();
  });
}

function showPanels() {
  loadAllPanels(all => {
    const div = document.getElementById("panelList");
    if (!all) {
      div.innerHTML = "<p>No panels in database.</p>";
      return;
    }
    let html = "<table><tr><th>DB</th><th>Location</th><th>Purpose</th><th>Action</th></tr>";
    Object.keys(all).forEach(id => {
      const p = all[id];
      html += `
        <tr>
          <td>${p.dbNumber || id}</td>
          <td>${p.location || ""}</td>
          <td>${p.purpose || ""}</td>
          <td>
            <button class="secondary-btn" onclick="editPanel('${id}')">Edit</button>
            <button class="danger-btn" onclick="deletePanel('${id}')">Delete</button>
          </td>
        </tr>
      `;
    });
    html += "</table>";
    div.innerHTML = html;
  });
}

/* ------------ QR PREVIEW + DOWNLOAD (ENTRY TAB) ------------ */
let qr;

function generateQR() {
  const id = document.getElementById("db").value.trim();
  if (!id) {
    alert("Enter DB Number first!");
    return;
  }

  const url = "https://energycew-ui.github.io/panel-system/index.html?id=" +
              encodeURIComponent(id);

  qr = new QRious({
    element: document.getElementById("qrCanvas"),
    value: url,
    size: 250
  });

  document.getElementById("qrDBname").innerText = id;
  document.getElementById("downloadQR").style.display = "inline-block";
}

function downloadQR() {
  const id = document.getElementById("db").value.trim();
  if (!id) return;

  const qrCanvasEl = document.getElementById("qrCanvas");
  const W = 700, H = 900;
  const finalCanvas = document.createElement("canvas");
  finalCanvas.width = W;
  finalCanvas.height = H;
  const ctx = finalCanvas.getContext("2d");

  // White background
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, W, H);

  const logo = new Image();
  logo.src = "logo.png";

  logo.onload = () => {
    const logoW = 420;
    const logoH = (logo.height / logo.width) * logoW;
    ctx.drawImage(logo, (W - logoW) / 2, 40, logoW, logoH);

    ctx.fillStyle = "#c40000";
    ctx.fillRect(45, 200, W - 80, 70);
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 24px Arial";
    ctx.textAlign = "center";
    ctx.fillText("DANGER–ELECTRICAL PANEL–DO NOT TOUCH", W / 2, 245);

    ctx.drawImage(qrCanvasEl, (W - 300) / 2, 300, 300, 300);

    ctx.fillStyle = "#000000";
    ctx.font = "bold 36px Arial";
    ctx.fillText(id, W / 2, 640);

    ctx.font = "20px Arial";
    ctx.textAlign = "left";
    ctx.fillText("Technician Signature:", 80, 720);
    ctx.beginPath();
    ctx.moveTo(80, 745);
    ctx.lineTo(W - 80, 745);
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#000000";
    ctx.stroke();

    const link = document.createElement("a");
    link.download = id + "_QR_sheet.png";
    link.href = finalCanvas.toDataURL();
    link.click();
  };

  logo.onerror = () => {
    alert("Logo not found (logo.png). QR sheet will be generated without logo.");
    ctx.fillStyle = "#c40000";
    ctx.fillRect(80, 80, W - 160, 70);
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 24px Arial";
    ctx.textAlign = "center";
    ctx.fillText("⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️", W / 2, 245);
    ctx.drawImage(qrCanvasEl, (W - 300) / 2, 220, 300, 300);
    ctx.fillStyle = "#000000";
    ctx.font = "bold 36px Arial";
    ctx.fillText(id, W / 2, 590);

    const link = document.createElement("a");
    link.download = id + "_QR_sheet.png";
    link.href = finalCanvas.toDataURL();
    link.click();
  };
}

/* ------------ REPORTS (INSPECTIONS + FAULTS) ------------ */

let inspectionsGlobal = [];
let faultsGlobal = [];

function loadReports() {
  // INSPECTIONS
  firebase.database().ref("inspections").once("value", snap => {
    let data = snap.val() || {};
    inspectionsGlobal = convertInspectionData(data);
    renderInspectionTable(inspectionsGlobal);
  });

  // FAULTS
  firebase.database().ref("faults").once("value", snap => {
    let data = snap.val() || {};
    faultsGlobal = convertFaultData(data);
    renderFaultTable(faultsGlobal);
  });
}

function convertInspectionData(data) {
  let list = [];
  for (let db in data) {
    for (let key in data[db]) {
      list.push({
        dbId: db,
        ...data[db][key]
      });
    }
  }
  return list;
}

function convertFaultData(data) {
  let list = [];
  for (let db in data) {
    for (let key in data[db]) {
      list.push({
        dbId: db,
        ...data[db][key]
      });
    }
  }
  return list;
}

/* RENDER INSPECTIONS TABLE (TAB 2) */
function renderInspectionTable(list) {
  let html = `
    <table>
    <tr>
        <th>Date</th>
        <th>DB</th>
        <th>Electrician</th>
        <th>Breaker</th>
        <th>Clean</th>
        <th>Locked</th>
        <th>Covered</th>
        <th>Comments</th>
        <th>Photos</th>
    </tr>
  `;

  list.forEach(r => {
    html += `
      <tr>
        <td>${r.timestamp ? new Date(r.timestamp).toLocaleString() : ""}</td>
        <td>${r.dbId}</td>
        <td>${r.electricianName || ""}</td>
        <td>${r.breakerStatus || ""}</td>
        <td>${r.cleanStatus || ""}</td>
        <td>${r.lockedStatus || ""}</td>
        <td>${r.coveredStatus || ""}</td>
        <td>${r.comments || ""}</td>
        <td>
            ${r.photo1 ? `<button class='photo-btn' onclick="openPhoto('${r.photo1}')">1</button>` : ""}
            ${r.photo2 ? `<button class='photo-btn' onclick="openPhoto('${r.photo2}')">2</button>` : ""}
            ${r.photo3 ? `<button class='photo-btn' onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("inspectionTable").innerHTML = html;
}

/* RENDER FAULTS TABLE (TAB 3) */
function renderFaultTable(list) {
  let html = `
    <table>
    <tr>
        <th>Date</th>
        <th>DB</th>
        <th>Electrician</th>
        <th>Fault Type</th>
        <th>Description</th>
        <th>Start</th>
        <th>End</th>
        <th>Downtime</th>
        <th>Production Loss</th>
        <th>Photos</th>
    </tr>
  `;

  list.forEach(r => {
    html += `
      <tr>
        <td>${r.timestamp ? new Date(r.timestamp).toLocaleString() : ""}</td>
        <td>${r.dbId}</td>
        <td>${r.electricianName || ""}</td>
        <td>${r.faultType || ""}</td>
        <td>${r.description || ""}</td>
        <td>${r.startTime || ""}</td>
        <td>${r.endTime || ""}</td>
        <td>${(r.downtimeMinutes || "") + (r.downtimeMinutes != null ? " min" : "")}</td>
        <td>${r.productionLoss || ""}<br>${r.productionLossDesc || ""}</td>
        <td>
            ${r.photo1 ? `<button class='photo-btn' onclick="openPhoto('${r.photo1}')">1</button>` : ""}
            ${r.photo2 ? `<button class='photo-btn' onclick="openPhoto('${r.photo2}')">2</button>` : ""}
            ${r.photo3 ? `<button class='photo-btn' onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("faultTable").innerHTML = html;
}

/* PHOTO VIEWER */
function openPhoto(src) {
  let win = window.open();
  win.document.write(`<img src="${src}" style="width:100%;">`);
}

/* FILTERS: INSPECTIONS */
function applyInspectionFilters() {
  let fDB = document.getElementById("filterDB_i").value.toLowerCase();
  let fElec = document.getElementById("filterElec_i").value.toLowerCase();
  let fDate = document.getElementById("filterDate_i").value;

  let filtered = inspectionsGlobal.filter(r =>
      (fDB === "" || r.dbId.toLowerCase().includes(fDB)) &&
      (fElec === "" || (r.electricianName || "").toLowerCase().includes(fElec)) &&
      (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );

  renderInspectionTable(filtered);
}

/* FILTERS: FAULTS */
function applyFaultFilters() {
  let fDB = document.getElementById("filterDB_f").value.toLowerCase();
  let fElec = document.getElementById("filterElec_f").value.toLowerCase();
  let fDate = document.getElementById("filterDate_f").value;

  let filtered = faultsGlobal.filter(r =>
      (fDB === "" || r.dbId.toLowerCase().includes(fDB)) &&
      (fElec === "" || (r.electricianName || "").toLowerCase().includes(fElec)) &&
      (fDate === "" || (r.timestamp || "").startsWith(fDate))
  );

  renderFaultTable(filtered);
}

/* ------------ MASTER DB REPORT (TAB 4) ------------ */

function loadMasterReport() {
  const container = document.getElementById("masterContainer");
  container.innerHTML = "Loading...";

  loadAllPanels(function(all) {
    if (!all) {
      container.innerHTML = "<p>No panels found.</p>";
      return;
    }

    let html = "";
    Object.keys(all).forEach(id => {
      let p = all[id];

      html += `
        <div class="card" style="margin-bottom:15px;">
          <h3>DB: ${p.dbNumber || id}</h3>
          <p><b>Voltage:</b> ${p.voltage || ""}</p>
          <p><b>Main Breaker:</b> ${p.mainBreaker || ""}</p>
          <p><b>Cable Size:</b> ${p.cableSize || ""}</p>
          <p><b>Earth Status:</b> ${p.earthStatus || ""}</p>
          <p><b>Location:</b> ${p.location || ""}</p>
          <p><b>Purpose:</b> ${p.purpose || ""}</p>
          <h4>Circuits</h4>
      `;

      if (p.circuits && Array.isArray(p.circuits) && p.circuits.length) {
        p.circuits.forEach(c => {
          html += `
            <div style="background:#fafafa;border:1px solid #ddd;border-radius:6px;padding:8px;margin-bottom:6px;">
              <b>${c.name || ""}</b><br>
              Breaker: ${c.breaker || ""}<br>
              Load: ${c.load || ""}
            </div>
          `;
        });
      } else {
        html += "<p>No circuits recorded.</p>";
      }

      html += "</div>";
    });

    container.innerHTML = html;
  });
}
</script>

</body>
</html>
