<!DOCTYPE html> 
<html>
<head>
  <title>Admin Dashboard</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Your Firebase helper (firebaseConfig + savePanelToFirebase + loadPanelFromFirebase + loadAllPanels etc.) -->
  <script src="data.js"></script>

  <!-- QR Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f2f4f7;
    }

    /* BASIC TOPBAR (used by premium header) */
    .topbar {
      background: #111;
      color: #ffc800;
      padding: 12px 24px 16px 24px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .topbar-title {
      font-size: 22px;
      font-weight: bold;
    }

    /* TABS */
    .tabs {
      display: flex;
      justify-content: center;
      background: #1e1e1e;
      padding: 8px;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tab-btn {
      border: none;
      padding: 10px 18px;
      font-size: 14px;
      border-radius: 999px;
      cursor: pointer;
      background: #333;
      color: #eee;
      transition: background 0.2s, transform 0.1s;
    }

    .tab-btn:hover {
      background: #444;
      transform: translateY(-1px);
    }

    .tab-btn.active {
      background: #ffc800;
      color: #111;
      font-weight: bold;
    }

    .tab-wrapper {
      padding: 20px;
      max-width: 1100px;
      margin: 0 auto 40px auto;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* LOGIN */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #loginBox {
      background: #fff;
      padding: 25px 30px;
      border-radius: 10px;
      max-width: 320px;
      width: 90%;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    }
    #loginBox input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
    }
    #loginBox button {
      width: 100%;
      padding: 10px;
      margin-top: 15px;
      font-size: 16px;
      cursor: pointer;
      background: #c40000;
      border: none;
      color: #fff;
      border-radius: 6px;
    }
    #loginError {
      color: red;
      font-size: 14px;
      margin-top: 8px;
    }
    .login-logo {
      width: 140px;
      height: auto;
      margin-bottom: 10px;
    }

    /* CARD STYLE */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      margin-bottom: 20px;
    }

    h2, h3 {
      margin-top: 0;
    }

    /* FORM ELEMENTS */
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="file"],
    select {
      padding: 8px;
      font-size: 16px;
    }
    input[type="text"],
    input[type="file"] {
      width: 300px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 6px;
      border: none;
    }

    #previewImage,
    #previewTransformerImage {
      width: 200px;
      margin-top: 10px;
      border: 2px solid #444;
      border-radius: 6px;
      display: none;
    }

    /* CIRCUITS (ENTRY TAB) */
    .circuit-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .circuit-row input {
      flex: 1;
      min-width: 120px;
    }
    .circuit-remove-btn {
      background: #c40000;
      color: white;
      border-radius: 4px;
      padding: 0 8px;
      cursor: pointer;
    }

    /* QR PREVIEW */
    #qrPreview, #trQrPreview {
      text-align: center;
      margin-top: 20px;
    }
    .dangerBanner {
      background: #c40000;
      color: #fff;
      padding: 10px 12px;
      font-weight: bold;
      border-radius: 8px;
      max-width: 460px;
      margin: 0 auto 15px auto;
      font-size: 16px;
    }
    #qrCanvas, #trQrCanvas {
      border: 1px solid #ccc;
      padding: 10px;
      background: #fff;
    }
    #qrDBname, #trQrName {
      font-size: 22px;
      font-weight: bold;
      margin-top: 12px;
      color: #111;
    }

    /* TABLES */
    table {
      width: 100%;
      margin-top: 20px;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      font-size: 14px;
    }
    th {
      background: #333;
      color: white;
      padding: 8px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      vertical-align: top;
    }
    tr:nth-child(even) { background: #f9f9f9; }

    .photo-btn {
      background: #007bff;
      color: white;
      padding: 4px 6px;
      border-radius: 5px;
      cursor: pointer;
      border: none;
      font-size: 12px;
    }

    .filterBox {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .filterBox input, .filterBox select {
      padding: 6px 8px;
      font-size: 14px;
    }

    .primary-btn {
      background:#007bff;
      color:#fff;
    }
    .danger-btn {
      background:#c40000;
      color:#fff;
    }
    .secondary-btn {
      background:#555;
      color:#fff;
    }

    /* SUMMARY CARDS */
    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 5px 0;
    }
    .summary-card {
      background: #f6f8fc;
      border-radius: 10px;
      padding: 8px 12px;
      min-width: 150px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-size: 13px;
    }
    .summary-title {
      font-weight: bold;
      color: #444;
      margin-bottom: 2px;
    }
    .summary-value {
      font-size: 20px;
      font-weight: bold;
      color: #111;
    }

    /* BADGES */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-ok {
      background: #e5f8e8;
      color: #0b7a2a;
    }
    .badge-warn {
      background: #fff4e5;
      color: #b26b00;
    }
    .badge-bad {
      background: #fde7e7;
      color: #b00020;
    }
    .badge-info {
      background: #e6f0ff;
      color: #174ea6;
    }

    /* MASTER DB TABLE SPECIFIC */
    .master-main-row {
      cursor: pointer;
    }
    .master-main-row:hover {
      background: #f1f5ff;
    }
    .master-details-row td {
      background: #f9fbff;
      border-top: none;
    }
    .master-details-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .master-details-left {
      flex: 1 1 60%;
      min-width: 250px;
    }
    .master-details-right {
      flex: 1 1 35%;
      min-width: 200px;
      text-align: center;
    }
    .master-details-image {
      max-width: 100%;
      max-height: 240px;
      border-radius: 8px;
      border: 1px solid #ddd;
      object-fit: cover;
    }
    .master-circuit-box {
      background:#fafafa;
      border:1px solid #ddd;
      border-radius:6px;
      padding:8px;
      margin-bottom:6px;
      font-size:13px;
    }

    /* PREMIUM HEADER DESIGN */
    .premium-header {
      position: relative;
      padding: 20px 0 28px 0;
      background: #0c0c0c;
    }

    .logo-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .topbar-logo {
      width: 110px;
      height: auto;
      margin-bottom: 10px;
      filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.45));
      opacity: 1;
      animation: fadeInDown 0.7s ease-out;
    }

    .premium-title {
      background: linear-gradient(90deg, #ffd65a, #ffb300);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-align: center;
      animation: fadeInUp 0.7s ease-out;
    }

    .header-separator {
      width: 80%;
      height: 2px;
      margin: 12px auto 0 auto;
      background: linear-gradient(90deg, #ffefc1, #ffb300, #ffefc1);
      border-radius: 2px;
      animation: fadeIn 1.2s ease-out;
    }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }
  </style>
</head>

<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay">
  <div id="loginBox">
    <img src="logo.png" alt="Chenab Logo" class="login-logo">
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Password">
    <button onclick="checkLogin()">Login</button>
    <div id="loginError"></div>
  </div>
</div>

<!-- MAIN ADMIN DASHBOARD -->
<div id="adminWrapper" style="display:none;">

  <!-- PREMIUM HEADER -->
  <div class="topbar premium-header">
    <div class="logo-wrapper">
      <img src="logo.png" class="topbar-logo" alt="Chenab Engineering Logo">
    </div>
    <div class="topbar-title premium-title">
      Admin Dashboard ‚Äì Electrical & Transformer System
    </div>
    <div class="header-separator"></div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" data-target="tab-entry">DB Entry</button>
    <button class="tab-btn" data-target="tab-transformer-entry">Transformer Entry</button>
    <button class="tab-btn" data-target="tab-inspections">DB Inspection Reports</button>
    <button class="tab-btn" data-target="tab-faults">Fault Reports</button>
    <button class="tab-btn" data-target="tab-transformer-reports">Transformer Reports</button>
    <button class="tab-btn" data-target="tab-lux-reports">LUX Reports</button>
    <button class="tab-btn" data-target="tab-master">Master DB Report</button>
    <button class="tab-btn" data-target="tab-questions">Form Questions</button>
    <button class="tab-btn" data-target="tab-safety">Safety Records</button>

    

  </div>

  <div class="tab-wrapper">

    <!-- TAB 1: DB ENTRY -->
    <div class="tab-content active" id="tab-entry">
      <div class="card">
        <h2>DB Entry / Panel Data</h2>

        <label>DB Number</label>
        <input id="db" type="text">

        <label>Voltage Rating</label>
        <input id="volt" type="text">

        <label>Main Breaker Capacity</label>
        <input id="breaker" type="text">

        <label>Main Cable Size</label>
        <input id="cable" type="text">

        <label>Earth Status</label>
        <input id="earth" type="text">

        <label>Location</label>
        <input id="location" type="text">

        <label>Purpose</label>
        <input id="purpose" type="text">

        <label>Upload Panel Picture (Optional)</label>
        <input type="file" id="imageInput" accept="image/*" onchange="previewAndCompress(event)">
        <br>
        <img id="previewImage" alt="Preview">
        <br>
        <button type="button" class="secondary-btn" onclick="removeImage()">Remove Picture</button>

        <h3 style="margin-top:20px;">Circuits (Name / Breaker / Load)</h3>
        <div id="circuitsContainer"></div>
        <button type="button" class="secondary-btn" onclick="addCircuitRow()">Add Circuit</button>

        <!-- NEW: DISTRIBUTION BREAKERS -->
        <h3 style="margin-top:20px;">Distribution Breakers (Detailed)</h3>
        <div id="distBreakersContainer"></div>
        <button type="button" class="secondary-btn" onclick="addDistBreakerRow()">Add Distribution Breaker</button>

        <h3 style="margin-top:20px;">Extra DB Questions</h3>
        <div id="dbQuestionsContainer"></div>

        <br><br>
        <button class="primary-btn" onclick="savePanel()">Save DB Data</button>

        <hr>

        <h3>Generate DB QR Code</h3>
        <button class="secondary-btn" onclick="generateQR()">Generate QR Code</button>

        <div id="qrPreview">
          <div class="dangerBanner">
            ‚ö†Ô∏è DANGER ‚Äì ELECTRICAL PANEL ‚Äì DO NOT TOUCH ‚ö†Ô∏è
          </div>
          <canvas id="qrCanvas" width="250" height="250"></canvas>
          <div id="qrDBname"></div>
        </div>

        <button id="downloadQR" style="display:none;" class="primary-btn" onclick="downloadQR()">
          Download DB QR Sheet
        </button>
      </div>

      <div class="card">
        <h2>All Panels (DBs)</h2>
        <button class="secondary-btn" onclick="showPanels()">Refresh Panel List</button>
        <div id="panelList" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- TAB 2: TRANSFORMER ENTRY -->
    <div class="tab-content" id="tab-transformer-entry">
      <div class="card">
        <h2>Transformer Entry</h2>

        <label>Transformer ID (e.g. TR-001)</label>
        <input id="tr_id" type="text">

        <label>Transformer Rating (kVA)</label>
        <input id="tr_rating" type="text">

        <label>Primary Voltage (V)</label>
        <input id="tr_vin" type="text">

        <label>Secondary Voltage (V)</label>
        <input id="tr_vout" type="text">

        <label>Location</label>
        <input id="tr_location" type="text">

        <label>Purpose / Feeder</label>
        <input id="tr_purpose" type="text">

        <label>Upload Transformer Picture (Optional)</label>
        <input type="file" id="tr_imageInput" accept="image/*" onchange="previewTransformerImage(event)">
        <br>
        <img id="previewTransformerImage" alt="Transformer Preview">
        <br>
        <button type="button" class="secondary-btn" onclick="removeTransformerImage()">Remove Picture</button>

        <br><br>
        <button class="primary-btn" onclick="saveTransformerEntry()">Save Transformer</button>

        <hr>

        <h3>Generate Transformer QR Code</h3>
        <button class="secondary-btn" onclick="generateTransformerQR()">Generate Transformer QR</button>

        <div id="trQrPreview">
          <div class="dangerBanner">
            ‚ö†Ô∏è HIGH VOLTAGE TRANSFORMER ‚Äì AUTHORIZED ONLY ‚ö†Ô∏è
          </div>
          <canvas id="trQrCanvas" width="250" height="250"></canvas>
          <div id="trQrName"></div>
        </div>

        <button id="downloadTrQR" style="display:none;" class="primary-btn" onclick="downloadTransformerQR()">
          Download Transformer QR Sheet
        </button>
      </div>

      <div class="card">
        <h2>All Transformers</h2>
        <button class="secondary-btn" onclick="showTransformers()">Refresh Transformer List</button>
        <div id="transformerList" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- TAB 3: DB INSPECTION REPORTS -->
    <div class="tab-content" id="tab-inspections">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <h2 style="margin:0;">DB Inspection Reports</h2>
          <button class="secondary-btn" onclick="exportInspectionsCSV()">Export CSV</button>
        </div>

        <div id="insSummary" class="summary-row"></div>

        <div class="filterBox">
          <input type="text" id="filterDB_i" placeholder="Filter by DB Number">
          <input type="text" id="filterElec_i" placeholder="Filter by Electrician">
          <label style="font-weight:normal;">From:
            <input type="date" id="filterFrom_i">
          </label>
          <label style="font-weight:normal;">To:
            <input type="date" id="filterTo_i">
          </label>
          <button class="secondary-btn" onclick="applyInspectionFilters()">Apply Filters</button>
        </div>

        <div id="inspectionTable"></div>
      </div>
    </div>

    <!-- TAB 4: FAULT REPORTS -->
    <div class="tab-content" id="tab-faults">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <h2 style="margin:0;">Fault Reports</h2>
          <button class="secondary-btn" onclick="exportFaultsCSV()">Export CSV</button>
        </div>

        <div id="faultSummary" class="summary-row"></div>

        <div class="filterBox">
          <input type="text" id="filterDB_f" placeholder="Filter by DB Number">
          <input type="text" id="filterElec_f" placeholder="Filter by Electrician">
          <label style="font-weight:normal;">From:
            <input type="date" id="filterFrom_f">
          </label>
          <label style="font-weight:normal;">To:
            <input type="date" id="filterTo_f">
          </label>
          <select id="filterLoss_f">
            <option value="">Loss: All</option>
            <option value="Yes">Loss: Yes</option>
            <option value="No">Loss: No</option>
          </select>
          <button class="secondary-btn" onclick="applyFaultFilters()">Apply Filters</button>
        </div>

        <div id="faultTable"></div>
      </div>
    </div>

    <!-- TAB 5: TRANSFORMER REPORTS -->
    <div class="tab-content" id="tab-transformer-reports">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <h2 style="margin:0;">Transformer Inspection Reports</h2>
          <button class="secondary-btn" onclick="exportTransformersCSV()">Export CSV</button>
        </div>

        <div id="trSummary" class="summary-row"></div>

        <div class="filterBox">
          <input type="text" id="filterTR_id" placeholder="Filter by Transformer ID">
          <input type="text" id="filterTR_elec" placeholder="Filter by Electrician">
          <label style="font-weight:normal;">From:
            <input type="date" id="filterTR_from">
          </label>
          <label style="font-weight:normal;">To:
            <input type="date" id="filterTR_to">
          </label>
          <button class="secondary-btn" onclick="applyTransformerFilters()">Apply Filters</button>
        </div>

        <div id="transformerTable"></div>
      </div>
    </div>

    <!-- TAB 6: LUX REPORTS -->
    <div class="tab-content" id="tab-lux-reports">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <h2 style="margin:0;">LUX Monitoring Reports</h2>
          <button class="secondary-btn" onclick="exportLuxCSV()">Export CSV</button>
        </div>

        <div id="luxSummary" class="summary-row"></div>

        <div class="filterBox">
          <input type="text" id="filterLX_dept" placeholder="Filter by Department">
          <input type="text" id="filterLX_elec" placeholder="Filter by Electrician">
          <label style="font-weight:normal;">From:
            <input type="date" id="filterLX_from">
          </label>
          <label style="font-weight:normal;">To:
            <input type="date" id="filterLX_to">
          </label>
          <button class="secondary-btn" onclick="applyLuxFilters()">Apply Filters</button>
        </div>

        <div id="luxTable"></div>
      </div>
    </div>

    <!-- TAB 7: MASTER DB REPORT -->
    <div class="tab-content" id="tab-master">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
          <h2 style="margin:0;">Master DB Report (All DBs & Circuits)</h2>
          <button class="secondary-btn" onclick="exportMasterCSV()">Export CSV</button>
        </div>

        <div id="masterSummary" class="summary-row"></div>

        <button class="secondary-btn" onclick="loadMasterReport()">Reload Data</button>
        <div id="masterContainer" style="margin-top:15px;"></div>
      </div>
    </div>

    <!-- TAB 8: FORM QUESTIONS -->
    <div class="tab-content" id="tab-questions">
      <div class="card">
        <h2>Form Questions (Dynamic)</h2>
        <p style="font-size:13px;">
          Add or remove questions here. They will automatically appear in DB Entry,
          Electrician Inspection and Fault forms depending on where you tick.
        </p>

        <h3 style="margin-top:20px;">Add New Question</h3>

        <label>Question Text</label>
        <input type="text" id="qText" style="width:100%;max-width:500px;">

        <label>Answer Type</label>
        <select id="qType">
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="yesno">Yes / No</option>
          <option value="dropdown">Dropdown (custom options)</option>
        </select>

        <label>Options (for dropdown, comma separated)</label>
        <input type="text" id="qOptions"
               placeholder="Example: OK, Needs repair, Not accessible"
               style="width:100%;max-width:500px;">

        <label>Applies To</label>
        <label style="font-weight:normal;"><input type="checkbox" id="qApplyDb" checked> DB Entry</label>
        <label style="font-weight:normal;"><input type="checkbox" id="qApplyInsp" checked> Inspection</label>
        <label style="font-weight:normal;"><input type="checkbox" id="qApplyFault" checked> Fault</label>

        <br>
        <button class="primary-btn" onclick="addQuestion()">Add Question</button>

        <hr>

        <h3>Existing Questions</h3>
        <div id="questionsList"></div>
      </div>
    </div>

 
<!-- TAB 9: SAFETY RECORDS -->
<div class="tab-content" id="tab-safety">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <h2 style="margin:0;">Safety Declarations</h2>
      <button class="secondary-btn" onclick="loadSafetyRecords()">Refresh</button>
    </div>

    <div id="safetySummary" class="summary-row"></div>

    <div id="safetyTable" style="margin-top:15px;"></div>
  </div>
</div>
 </div>
</div>
<script>
/* ------------ LOGIN ------------ */
const ADMIN_PASSWORD = "1234";
let questionsGlobal = {};
let inspectionsGlobal = [];
let faultsGlobal = [];
let masterPanelsGlobal = null;
let transformerReportsGlobal = [];
let luxReportsGlobal = [];

function checkLogin() {
  const pwd = document.getElementById("adminPassword").value.trim();
  const error = document.getElementById("loginError");

  if (pwd === ADMIN_PASSWORD) {
    sessionStorage.setItem("adminDashboardLogged", "true");
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("adminWrapper").style.display = "block";
    afterLoginInit();
  } else {
    error.textContent = "Incorrect password.";
  }setInterval(() => {
  if (masterPanelsGlobal) {
    loadMasterReport();
  }
}, 60000); // refresh every 60 seconds

}

window.addEventListener("load", () => {
  if (sessionStorage.getItem("adminDashboardLogged") === "true") {
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("adminWrapper").style.display = "block";
    afterLoginInit();
  }
});

/* ------------ AFTER LOGIN INIT ------------ */
function afterLoginInit() {
  initTabs();
  renderCircuits(null);
  renderDistributionBreakers(null);   // NEW: start with empty distribution breaker row
  showPanels();
  loadReports();
  loadMasterReport();
  loadQuestions();
  showTransformers();
  loadTransformerReports();
  loadLuxReports();
  loadSafetyRecords();

  // üîß Auto-load DB for editing when coming from panel.html
  const params = new URLSearchParams(window.location.search);
  const editId = params.get("edit");
  if (editId) {
    // Switch to DB Entry tab
    const entryBtn = document.querySelector('.tab-btn[data-target="tab-entry"]');
    if (entryBtn) entryBtn.click();

    loadPanelFromFirebase(editId, p => {
      if (p) {
        editPanel(editId);
      } else {
        alert("Panel not found: " + editId);
      }
    });

    window.scrollTo(0, 0);
  }
}

/* ------------ TABS HANDLING ------------ */
function initTabs() {
  const buttons = document.querySelectorAll(".tab-btn");
  const tabs = document.querySelectorAll(".tab-content");

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      const targetId = btn.getAttribute("data-target");

      buttons.forEach(b => b.classList.remove("active"));
      tabs.forEach(t => t.classList.remove("active"));

      btn.classList.add("active");
      document.getElementById(targetId).classList.add("active");
    });
  });
}

/* ------------ IMAGE HANDLING (DB ENTRY) ------------ */
let uploadedImage = null;

function previewAndCompress(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const maxWidth = 800;
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = img.height * scale;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      uploadedImage = canvas.toDataURL("image/jpeg", 0.7);

      const preview = document.getElementById("previewImage");
      preview.src = uploadedImage;
      preview.style.display = "block";
    };
  };
  reader.readAsDataURL(file);
}

function removeImage() {
  uploadedImage = null;
  document.getElementById("previewImage").style.display = "none";
  document.getElementById("imageInput").value = "";
}

/* ------------ TRANSFORMER IMAGE ------------ */
let uploadedTransformerImage = null;

function previewTransformerImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const maxWidth = 800;
      const scale = maxWidth / img.width;
      canvas.width = maxWidth;
      canvas.height = img.height * scale;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      uploadedTransformerImage = canvas.toDataURL("image/jpeg", 0.7);

      const preview = document.getElementById("previewTransformerImage");
      preview.src = uploadedTransformerImage;
      preview.style.display = "block";
    };
  };
  reader.readAsDataURL(file);
}

function removeTransformerImage() {
  uploadedTransformerImage = null;
  document.getElementById("previewTransformerImage").style.display = "none";
  document.getElementById("tr_imageInput").value = "";
}

/* ------------ CIRCUITS (DB ENTRY) ------------ */
function addCircuitRow(name = "", breaker = "", load = "") {
  const container = document.getElementById("circuitsContainer");
  const row = document.createElement("div");
  row.className = "circuit-row";
  row.innerHTML = `
    <input class="c-name" placeholder="Circuit name" value="${name}">
    <input class="c-breaker" placeholder="Breaker (e.g. 10A)" value="${breaker}">
    <input class="c-load" placeholder="Load / Description" value="${load}">
    <button type="button" class="circuit-remove-btn" onclick="this.parentElement.remove()">X</button>
  `;
  container.appendChild(row);
}

function renderCircuits(circuits) {
  const container = document.getElementById("circuitsContainer");
  container.innerHTML = "";
  if (circuits) {
    const list = Array.isArray(circuits) ? circuits : Object.values(circuits);
    list.forEach(c => addCircuitRow(c.name || "", c.breaker || "", c.load || ""));
  } else {
    addCircuitRow();
  }
}

function collectCircuitsFromForm() {
  const rows = document.querySelectorAll(".circuit-row");
  const circuits = [];
  rows.forEach(row => {
    const name = row.querySelector(".c-name").value.trim();
    const br   = row.querySelector(".c-breaker").value.trim();
    const ld   = row.querySelector(".c-load").value.trim();
    if (name || br || ld) {
      circuits.push({ name, breaker: br, load: ld });
    }
  });
  return circuits.length ? circuits : null;
}

/* ------------ DISTRIBUTION BREAKERS (NEW) ------------ */
function addDistBreakerRow(name = "", rating = "", cableSize = "", loadUse = "", loadCurrent = "") {
  const container = document.getElementById("distBreakersContainer");
  const row = document.createElement("div");
  row.className = "circuit-row";
  row.innerHTML = `
    <input class="d-name" placeholder="Name / No." value="${name}">
    <input class="d-rating" placeholder="Rating (A)" value="${rating}">
    <input class="d-cable" placeholder="Cable Size" value="${cableSize}">
    <input class="d-use" placeholder="Load Use" value="${loadUse}">
    <input class="d-current" placeholder="Load Current (A)" value="${loadCurrent}">
    <button type="button" class="circuit-remove-btn" onclick="this.parentElement.remove()">X</button>
  `;
  container.appendChild(row);
}

function renderDistributionBreakers(list) {
  const container = document.getElementById("distBreakersContainer");
  if (!container) return;
  container.innerHTML = "";
  if (list) {
    const arr = Array.isArray(list) ? list : Object.values(list);
    arr.forEach(b => {
      addDistBreakerRow(
        b.name || "",
        b.rating || "",
        b.cableSize || "",
        b.loadUse || "",
        b.loadCurrent || ""
      );
    });
  } else {
    // start with one empty row for convenience
    addDistBreakerRow();
  }
}

function collectDistBreakersFromForm() {
  const rows = document.querySelectorAll("#distBreakersContainer .circuit-row");
  const breakers = [];
  rows.forEach(row => {
    const name = row.querySelector(".d-name").value.trim();
    const rating = row.querySelector(".d-rating").value.trim();
    const cableSize = row.querySelector(".d-cable").value.trim();
    const loadUse = row.querySelector(".d-use").value.trim();
    const loadCurrent = row.querySelector(".d-current").value.trim();
    if (name || rating || cableSize || loadUse || loadCurrent) {
      breakers.push({ name, rating, cableSize, loadUse, loadCurrent });
    }
  });
  return breakers.length ? breakers : null;
}

/* ------------ SAVE PANEL (DB ENTRY) ------------ */
function savePanel() {
  const id = document.getElementById("db").value.trim();
  if (!id) {
    alert("Enter DB Number!");
    return;
  }

  const data = {
    dbNumber: id,
    voltage: document.getElementById("volt").value,
    mainBreaker: document.getElementById("breaker").value,
    cableSize: document.getElementById("cable").value,
    earthStatus: document.getElementById("earth").value,
    location: document.getElementById("location").value,
    purpose: document.getElementById("purpose").value,
    image: uploadedImage || null,
    circuits: collectCircuitsFromForm(),
    distributionBreakers: collectDistBreakersFromForm(),   // NEW
    extraAnswers: collectDynamicAnswers("db")
  };

  savePanelToFirebase(id, data, () => {
    alert("Panel saved to Firebase successfully!");
    showPanels();
    loadMasterReport(); // Master DB auto updates
  });
}

/* ------------ EDIT / DELETE / LIST PANELS (DB ENTRY) ------------ */
function editPanel(id) {
  loadPanelFromFirebase(id, p => {
    if (!p) {
      alert("Panel not found!");
      return;
    }

    document.getElementById("db").value        = p.dbNumber || id;
    document.getElementById("volt").value      = p.voltage || "";
    document.getElementById("breaker").value   = p.mainBreaker || "";
    document.getElementById("cable").value     = p.cableSize || "";
    document.getElementById("earth").value     = p.earthStatus || "";
    document.getElementById("location").value  = p.location || "";
    document.getElementById("purpose").value   = p.purpose || "";

    uploadedImage = p.image || null;
    const preview = document.getElementById("previewImage");
    if (uploadedImage) {
      preview.src = uploadedImage;
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
    }

    renderCircuits(p.circuits || null);
    renderDistributionBreakers(p.distributionBreakers || null);  // NEW

    const entryBtn = document.querySelector('.tab-btn[data-target="tab-entry"]');
    if (entryBtn) entryBtn.click();
    window.scrollTo(0, 0);
  });
}

function deletePanel(id) {
  if (!confirm("Are you sure you want to delete panel " + id + " ?")) return;
  firebase.database().ref("panels/" + id).remove().then(() => {
    alert("Panel " + id + " deleted.");
    showPanels();
    loadMasterReport();
  });
}
/* ------------ SAFETY RECORDS ------------ */

let safetyGlobal = [];

function loadSafetyRecords() {

  firebase.database().ref("safetyDeclarations").once("value", snap => {

    const data = snap.val() || {};
    const list = [];

    Object.keys(data).forEach(dbId => {
      Object.keys(data[dbId]).forEach(key => {
        list.push({
          dbId,
          recordKey: key,
          ...data[dbId][key]
        });
      });
    });

    safetyGlobal = list;

    renderSafetyTable(list);
    updateSafetySummary(list);
  });
}

function updateSafetySummary(list) {

  const container = document.getElementById("safetySummary");
  if (!container) return;

  if (!list.length) {
    container.innerHTML = "<p>No safety records.</p>";
    return;
  }

  const total = list.length;
  const open = list.filter(r => r.status !== "CLOSED").length;
  const closed = list.filter(r => r.status === "CLOSED").length;

  container.innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Safety Jobs</div>
      <div class="summary-value">${total}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">OPEN</div>
      <div class="summary-value" style="color:#c40000;">${open}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">CLOSED</div>
      <div class="summary-value" style="color:#0b7a2a;">${closed}</div>
    </div>
  `;
}

function renderSafetyTable(list) {

  const container = document.getElementById("safetyTable");
  if (!container) return;

  if (!list.length) {
    container.innerHTML = "<p>No safety records found.</p>";
    return;
  }

  let html = `
    <table>
      <tr>
        <th>Date Opened</th>
        <th>DB</th>
        <th>Electrician</th>
        <th>Score</th>
        <th>Status</th>
        <th>Duration (hrs)</th>
        <th>Alert</th>
        <th>Photo</th>
        <th>PDF</th>
        <th>Fault</th>
<th>Delete</th>

      </tr>
  `;

  list.forEach(r => {

    const openDate = r.timestamp ? new Date(r.timestamp) : null;
    const now = new Date();

    let durationMinutes = 0;

    if (openDate) {
      if (r.closedAt) {
        durationMinutes = (new Date(r.closedAt) - openDate) / 60000;
      } else {
        durationMinutes = (now - openDate) / 60000;
      }
    }

    const durationHours = (durationMinutes / 60).toFixed(2);

    let alertBadge = "";
    if (r.status !== "CLOSED" && durationMinutes > 120) {
      alertBadge = `<span class="badge badge-bad">‚ö† OPEN > 2H</span>`;
    }

    const statusBadge = r.status === "CLOSED"
      ? `<span class="badge badge-ok">CLOSED</span>`
      : `<span class="badge badge-bad">OPEN</span>`;

    html += `
      <tr>
        <td>${openDate ? openDate.toLocaleString() : ""}</td>
        <td><span class="badge badge-info">${r.dbId}</span></td>
        <td>${r.electricianName || ""}</td>
        <td>
  ${(r.checklistScore || 0) < 3
    ? `<span class="badge badge-bad">${r.checklistScore || 0} / 5</span>`
    : `<span class="badge badge-ok">${r.checklistScore || 0} / 5</span>`
  }
</td>

        <td>${statusBadge}</td>
        <td>${durationHours}</td>
        <td>${alertBadge}</td>
        <td>
          ${r.safetyPhoto 
            ? `<button class="photo-btn" onclick="openPhoto('${r.safetyPhoto}')">View</button>`
            : "‚Äî"}
        </td>
        <td>
          <button class="secondary-btn"
            onclick="window.open('safety_print.html?db=${r.dbId}&id=${r.recordKey}','_blank')">
            PDF
          </button>
        </td>
        <td>
          ${r.faultRef
            ? `<button class="secondary-btn" onclick="openFaultPrint('${r.dbId}','${r.faultRef}')">View Fault</button>`
            : "‚Äî"}
        </td>
      <td>
  <button class="danger-btn"
    onclick="deleteSafetyRecord('${r.dbId}','${r.recordKey}')">
    Delete
  </button>
</td>
</tr>
    `;
  });

  html += "</table>";
  container.innerHTML = html;
}

function showPanels() {
  loadAllPanels(all => {
    const div = document.getElementById("panelList");
    if (!all) {
      div.innerHTML = "<p>No panels in database.</p>";
      return;
    }
    let html = "<table><tr><th>DB</th><th>Location</th><th>Purpose</th><th>Action</th></tr>";
    Object.keys(all).forEach(id => {
      const p = all[id];
      html += `
        <tr>
          <td>${p.dbNumber || id}</td>
          <td>${p.location || ""}</td>
          <td>${p.purpose || ""}</td>
          <td>
            <button class="secondary-btn" onclick="editPanel('${id}')">Edit</button>
            <button class="danger-btn" onclick="deletePanel('${id}')">Delete</button>
          </td>
        </tr>
      `;
    });
    html += "</table>";
    div.innerHTML = html;
  });
}

/* ------------ TRANSFORMER ENTRY ------------ */
function saveTransformerEntry() {
  const id = document.getElementById("tr_id").value.trim();
  if (!id) {
    alert("Enter Transformer ID (e.g. TR-001)");
    return;
  }
  const data = {
    transformerId: id,
    rating: document.getElementById("tr_rating").value,
    vin: document.getElementById("tr_vin").value,
    vout: document.getElementById("tr_vout").value,
    location: document.getElementById("tr_location").value,
    purpose: document.getElementById("tr_purpose").value,
    image: uploadedTransformerImage || null
  };
  firebase.database().ref("transformers/" + id).set(data, err => {
    if (err) alert("Error saving transformer: " + err);
    else {
      alert("Transformer saved.");
      showTransformers();
    }
  });
}

function showTransformers() {

  const div = document.getElementById("transformerList");
  if (!div) return;

  firebase.database().ref("transformers").once("value").then(snap => {

    const all = snap.val();

    if (!all) {
      div.innerHTML = "<p>No transformers in database.</p>";
      return;
    }

    let html = `
      <table>
        <tr>
          <th>ID</th>
          <th>Rating</th>
          <th>Location</th>
          <th>Status</th>
          <th>Next Due</th>
          <th>Reminder</th>
          <th>Action</th>
        </tr>
    `;

    Object.keys(all).forEach(id => {

      const t = all[id];

      let statusText = "FIRST INSPECTION REQUIRED";
      let statusClass = "badge-bad";
      let nextDueText = "-";

      if (t.lastInspection && t.nextInspectionDue) {

        const nextDate = new Date(t.nextInspectionDue);
        const today = new Date();
        const diffDays = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));

        nextDueText = nextDate.toLocaleDateString("en-GB");

        if (diffDays < 0) {
          statusText = "OVERDUE";
          statusClass = "badge-bad";
        } 
        else if (diffDays <= 7) {
          statusText = "DUE SOON";
          statusClass = "badge-warn";
        } 
        else {
          statusText = "OK";
          statusClass = "badge-ok";
        }

      }

      html += `
        <tr>
          <td>${t.transformerId || id}</td>
          <td>${t.rating || ""}</td>
          <td>${t.location || ""}</td>
          <td><span class="badge ${statusClass}">${statusText}</span></td>
          <td>${nextDueText}</td>
          <td>
            <button class="secondary-btn"
              onclick="sendTransformerReminder('${t.transformerId || id}', '${nextDueText}', '${statusText}')">
              Send WhatsApp
            </button>
          </td>
          <td>
            <button class="secondary-btn" onclick="editTransformer('${id}')">Edit</button>
            <button class="danger-btn" onclick="deleteTransformer('${id}')">Delete</button>
          </td>
        </tr>
      `;

    });

    html += "</table>";
    div.innerHTML = html;

  });
}
function editTransformer(id) {
  firebase.database().ref("transformers/" + id).once("value").then(snap => {
    const t = snap.val();
    if (!t) {
      alert("Transformer not found.");
      return;
    }
    document.getElementById("tr_id").value = t.transformerId || id;
    document.getElementById("tr_rating").value = t.rating || "";
    document.getElementById("tr_vin").value = t.vin || "";
    document.getElementById("tr_vout").value = t.vout || "";
    document.getElementById("tr_location").value = t.location || "";
    document.getElementById("tr_purpose").value = t.purpose || "";
    uploadedTransformerImage = t.image || null;
    const preview = document.getElementById("previewTransformerImage");
    if (uploadedTransformerImage) {
      preview.src = uploadedTransformerImage;
      preview.style.display = "block";
    } else {
      preview.style.display = "none";
    }
    const trBtn = document.querySelector('.tab-btn[data-target="tab-transformer-entry"]');
    if (trBtn) trBtn.click();
    window.scrollTo(0, 0);
  });
}

function deleteTransformer(id) {
  if (!confirm("Delete transformer " + id + " ?")) return;
  firebase.database().ref("transformers/" + id).remove().then(() => {
    alert("Transformer deleted.");
    showTransformers();
  });
}

/* ------------ QR PREVIEW + DOWNLOAD (DB ENTRY) ------------ */
let qr;

function generateQR() {
  const id = document.getElementById("db").value.trim();
  if (!id) {
    alert("Enter DB Number first!");
    return;
  }

  const url = "https://energycew-ui.github.io/panel-system/panel.html?id=" + encodeURIComponent(id);

  qr = new QRious({
    element: document.getElementById("qrCanvas"),
    value: url,
    size: 250
  });

  document.getElementById("qrDBname").innerText = id;
  document.getElementById("downloadQR").style.display = "inline-block";
}

function downloadQR() {
  const id = document.getElementById("db").value.trim();
  if (!id) return;

  const qrCanvasEl = document.getElementById("qrCanvas");
  const W = 700, H = 900;
  const finalCanvas = document.createElement("canvas");
  finalCanvas.width = W;
  finalCanvas.height = H;
  const ctx = finalCanvas.getContext("2d");

  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, W, H);

  const logo = new Image();
  logo.src = "logo.png";

  logo.onload = () => {
    const logoW = 420;
    const logoH = (logo.height / logo.width) * logoW;
    ctx.drawImage(logo, (W - logoW) / 2, 40, logoW, logoH);

    ctx.fillStyle = "#c40000";
    ctx.fillRect(45, 200, W - 80, 70);
    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 24px Arial";
    ctx.textAlign = "center";
    ctx.fillText("DANGER‚ÄìELECTRICAL PANEL‚ÄìDO NOT TOUCH", W / 2, 245);

    ctx.drawImage(qrCanvasEl, (W - 300) / 2, 300, 300, 300);

    ctx.fillStyle = "#000000";
    ctx.font = "bold 36px Arial";
    ctx.fillText(id, W / 2, 640);

    ctx.font = "20px Arial";
    ctx.textAlign = "left";
    ctx.fillText("Technician Signature:", 80, 720);
    ctx.beginPath();
    ctx.moveTo(80, 745);
    ctx.lineTo(W - 80, 745);
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#000000";
    ctx.stroke();

    const link = document.createElement("a");
    link.download = id + "_QR_sheet.png";
    link.href = finalCanvas.toDataURL();
    link.click();
  };

  logo.onerror = () => {
    alert("Logo not found (logo.png). QR sheet will be generated without logo.");
  };
}

/* ------------ TRANFORMER QR + DOWNLOAD ------------ */
let trQR;

function generateTransformerQR() {
  const id = document.getElementById("tr_id").value.trim();
  if (!id) {
    alert("Enter Transformer ID first!");
    return;
  }

  const url = "https://energycew-ui.github.io/panel-system/transformer.html?id=" + encodeURIComponent(id);

  trQR = new QRious({
    element: document.getElementById("trQrCanvas"),
    value: url,
    size: 250
  });

  document.getElementById("trQrName").innerText = id;
  document.getElementById("downloadTrQR").style.display = "inline-block";
}

function downloadTransformerQR() {
  const id = document.getElementById("tr_id").value.trim();
  if (!id) return;

  const qrCanvasEl = document.getElementById("trQrCanvas");
  const W = 700, H = 900;
  const finalCanvas = document.createElement("canvas");
  finalCanvas.width = W;
  finalCanvas.height = H;
  const ctx = finalCanvas.getContext("2d");

  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, W, H);

  const logo = new Image();
  logo.src = "logo.png";

  logo.onload = () => {
    const logoW = 420;
    const logoH = (logo.height / logo.width) * logoW;
    ctx.drawImage(logo, (W - logoW) / 2, 40, logoW, logoH);

    ctx.fillStyle = "#ffcc00";
    ctx.fillRect(45, 200, W - 80, 70);
    ctx.fillStyle = "#000000";
    ctx.font = "bold 24px Arial";
    ctx.textAlign = "center";
    ctx.fillText("HIGH VOLTAGE TRANSFORMER ‚Äì AUTHORIZED ONLY", W / 2, 245);

    ctx.drawImage(qrCanvasEl, (W - 300) / 2, 300, 300, 300);

    ctx.fillStyle = "#000000";
    ctx.font = "bold 36px Arial";
    ctx.fillText(id, W / 2, 640);

    const link = document.createElement("a");
    link.download = id + "_Transformer_QR_sheet.png";
    link.href = finalCanvas.toDataURL();
    link.click();
  };

  logo.onerror = () => {
    alert("Logo not found (logo.png). QR sheet will be generated without logo.");
  };
}

/* ------------ HELPER: STATUS BADGES ------------ */
function badgeForStatus(value, okValues = [], warnValues = [], badValues = []) {
  if (!value) return "";
  const v = value.toLowerCase();
  if (okValues.some(x => v === x.toLowerCase())) {
    return `<span class="badge badge-ok">${value}</span>`;
  }
  if (warnValues.some(x => v === x.toLowerCase())) {
    return `<span class="badge badge-warn">${value}</span>`;
  }
  if (badValues.some(x => v === x.toLowerCase())) {
    return `<span class="badge badge-bad">${value}</span>`;
  }
  return `<span class="badge badge-info">${value}</span>`;
}

/* ------------ DB INSPECTION + FAULT REPORTS ------------ */

function loadReports() {
  firebase.database().ref("inspections").once("value", snap => {
    let data = snap.val() || {};
    inspectionsGlobal = convertInspectionData(data);
    renderInspectionTable(inspectionsGlobal);
    updateInspectionSummary(inspectionsGlobal);
  });

  firebase.database().ref("faults").once("value", snap => {
    let data = snap.val() || {};
    faultsGlobal = convertFaultData(data);
    renderFaultTable(faultsGlobal);
    updateFaultSummary(faultsGlobal);
  });
}

function convertInspectionData(data) {
  let list = [];
  for (let db in data) {
    for (let key in data[db]) {
      list.push({
        dbId: db,
        recordKey: key,
        ...data[db][key]
      });
    }
  }
  return list;
}

function convertFaultData(data) {
  let list = [];
  for (let db in data) {
    for (let key in data[db]) {
      list.push({
        dbId: db,
        recordKey: key,
        ...data[db][key]
      });
    }
  }
  return list;
}

/* INSPECTION SUMMARY */
function updateInspectionSummary(list) {
  const container = document.getElementById("insSummary");
  if (!container) return;
  if (!list || !list.length) {
    container.innerHTML = "<p>No inspection records.</p>";
    return;
  }

  const total = list.length;
  const byDb = new Set(list.map(r => r.dbId)).size;
  const recent = list.filter(r => {
    if (!r.timestamp) return false;
    const d = r.timestamp.substring(0,10);
    const today = new Date().toISOString().substring(0,10);
    return d === today;
  }).length;

  container.innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Inspections</div>
      <div class="summary-value">${total}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Panels Inspected</div>
      <div class="summary-value">${byDb}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Today</div>
      <div class="summary-value">${recent}</div>
    </div>
  `;
}

/* FAULT SUMMARY */
function updateFaultSummary(list) {
  const container = document.getElementById("faultSummary");
  if (!container) return;
  if (!list || !list.length) {
    container.innerHTML = "<p>No fault records.</p>";
    return;
  }

  const total = list.length;
  const byDb = new Set(list.map(r => r.dbId)).size;
  let totalDowntime = 0;
  let lossYes = 0;
  list.forEach(r => {
    if (r.downtimeMinutes) totalDowntime += Number(r.downtimeMinutes) || 0;
    if (r.productionLoss === "Yes") lossYes++;
  });
  const totalHours = (totalDowntime / 60).toFixed(1);

  container.innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Faults</div>
      <div class="summary-value">${total}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Panels with Faults</div>
      <div class="summary-value">${byDb}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Production Loss Cases</div>
      <div class="summary-value">${lossYes}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Downtime (hrs)</div>
      <div class="summary-value">${totalHours}</div>
    </div>
  `;
}

/* PRINT VIEW OPENERS (NEW) */
function openInspectionPrint(dbId, recordKey) {
  window.open(
    "inspection_print.html?db=" + encodeURIComponent(dbId) +
    "&id=" + encodeURIComponent(recordKey),
    "_blank"
  );
}

function openFaultPrint(dbId, recordKey) {
  window.open(
    "fault_print.html?db=" + encodeURIComponent(dbId) +
    "&id=" + encodeURIComponent(recordKey),
    "_blank"
  );
}

function openTransformerReportPrint(trId, recordKey) {
  window.open(
    "transformer_print.html?tr=" + encodeURIComponent(trId) +
    "&id=" + encodeURIComponent(recordKey),
    "_blank"
  );
}
function deleteSafetyRecord(dbId, key) {

  if (!confirm("Delete this safety declaration?")) return;

  firebase.database()
    .ref("safetyDeclarations/" + dbId + "/" + key)
    .remove()
    .then(() => {
      alert("Safety record deleted.");
      loadSafetyRecords();
    });
}

/* RENDER INSPECTIONS TABLE (with delete + print) */
function renderInspectionTable(list) {
  if (!document.getElementById("inspectionTable")) return;

  let html = `
    <table>
    <tr>
        <th>Date</th>
        <th>DB</th>
        <th>Electrician</th>
        <th>Breaker</th>
        <th>Clean</th>
        <th>Locked</th>
        <th>Covered</th>
        <th>Comments / Extra</th>
        <th>Photos</th>
        <th>Action</th>
    </tr>
  `;

  list.forEach(r => {
    const dateStr = r.timestamp ? new Date(r.timestamp).toLocaleString() : "";

    const breakerHtml = badgeForStatus(
      r.breakerStatus,
      ["OK"],
      [],
      ["Needs repair", "Not accessible"]
    );
    const cleanHtml = badgeForStatus(
      r.cleanStatus,
      ["Clean"],
      ["Needs cleaning"],
      ["Not accessible"]
    );
    const lockedHtml = badgeForStatus(
      r.lockedStatus,
      ["Locked"],
      [],
      ["Unlocked", "Not lockable"]
    );
    const coveredHtml = badgeForStatus(
      r.coveredStatus,
      ["Covered", "Not required"],
      [],
      ["Not covered"]
    );

    let extraText = "";
    if (r.extraAnswers && questionsGlobal) {
      extraText = Object.entries(r.extraAnswers).map(([qid,val]) => {
        const q = questionsGlobal[qid];
        const label = q ? q.text : qid;
        return `${label}: ${val}`;
      }).join("; ");
    }

    const commentsCell = (r.comments || "") + (extraText ? `<br><small>${extraText}</small>` : "");

    html += `
      <tr>
        <td>${dateStr}</td>
        <td><span class="badge badge-info">${r.dbId}</span></td>
        <td>${r.electricianName || ""}</td>
        <td>${breakerHtml}</td>
        <td>${cleanHtml}</td>
        <td>${lockedHtml}</td>
        <td>${coveredHtml}</td>
        <td>${commentsCell}</td>
        <td>
            ${r.photo1 ? `<button class='photo-btn' onclick="openPhoto('${r.photo1}')">1</button>` : ""}
            ${r.photo2 ? `<button class='photo-btn' onclick="openPhoto('${r.photo2}')">2</button>` : ""}
            ${r.photo3 ? `<button class='photo-btn' onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
        <td>
          <button class="secondary-btn" onclick="openInspectionPrint('${r.dbId}','${r.recordKey}')">
            View / Print
          </button>
          <button class="danger-btn" onclick="deleteInspection('${r.dbId}','${r.recordKey}')">Delete</button>
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("inspectionTable").innerHTML = html;
}

/* RENDER FAULTS TABLE (with delete + print) */
function renderFaultTable(list) {
  if (!document.getElementById("faultTable")) return;

  let html = `
    <table>
    <tr>
        <th>Date</th>
        <th>DB</th>
        <th>Electrician</th>
        <th>Fault Type</th>
        <th>Description / Extra</th>
        <th>Start</th>
        <th>End</th>
        <th>Downtime</th>
        <th>Production Loss</th>
        <th>Photos</th>
        <th>Action</th>
    </tr>
  `;

  list.forEach(r => {
    const dateStr = r.timestamp ? new Date(r.timestamp).toLocaleString() : "";
    const downtime = r.downtimeMinutes != null ? Number(r.downtimeMinutes) : null;
    let downtimeHtml = "";
    if (downtime == null) {
      downtimeHtml = "";
    } else if (downtime === 0) {
      downtimeHtml = `<span class="badge badge-ok">0 min</span>`;
    } else if (downtime <= 30) {
      downtimeHtml = `<span class="badge badge-warn">${downtime} min</span>`;
    } else {
      downtimeHtml = `<span class="badge badge-bad">${downtime} min</span>`;
    }

    let lossHtml = "";
    if (r.productionLoss === "Yes") {
      lossHtml = `<span class="badge badge-bad">Yes</span>`;
    } else if (r.productionLoss === "No") {
      lossHtml = `<span class="badge badge-ok">No</span>`;
    } else {
      lossHtml = r.productionLoss || "";
    }

    let extraText = "";
    if (r.extraAnswers && questionsGlobal) {
      extraText = Object.entries(r.extraAnswers).map(([qid,val]) => {
        const q = questionsGlobal[qid];
        const label = q ? q.text : qid;
        return `${label}: ${val}`;
      }).join("; ");
    }

    const descCell = (r.description || "") + (extraText ? `<br><small>${extraText}</small>` : "");

    html += `
      <tr>
        <td>${dateStr}</td>
        <td><span class="badge badge-info">${r.dbId}</span></td>
        <td>${r.electricianName || ""}</td>
        <td>${r.faultType || ""}</td>
        <td>${descCell}</td>
        <td>${r.startTime || ""}</td>
        <td>${r.endTime || ""}</td>
        <td>${downtimeHtml}</td>
        <td>${lossHtml}<br>${r.productionLossDesc || ""}</td>
        <td>
            ${r.photo1 ? `<button class='photo-btn' onclick="openPhoto('${r.photo1}')">1</button>` : ""}
            ${r.photo2 ? `<button class='photo-btn' onclick="openPhoto('${r.photo2}')">2</button>` : ""}
            ${r.photo3 ? `<button class='photo-btn' onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
        <td>
          <button class="secondary-btn" onclick="openFaultPrint('${r.dbId}','${r.recordKey}')">
            View / Print
          </button>
          <button class="danger-btn" onclick="deleteFault('${r.dbId}','${r.recordKey}')">Delete</button>
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("faultTable").innerHTML = html;
}

/* PHOTO VIEWER */
function openPhoto(src) {
  let win = window.open();
  win.document.write(`<img src="${src}" style="width:100%;">`);
}

/* DELETE INSPECTION / FAULT RECORDS */
function deleteInspection(dbId, key) {
  if (!confirm("Delete this inspection record?")) return;
  firebase.database().ref("inspections/" + dbId + "/" + key).remove().then(() => {
    alert("Inspection deleted.");
    loadReports();
  });
}

function deleteFault(dbId, key) {
  if (!confirm("Delete this fault record?")) return;
  firebase.database().ref("faults/" + dbId + "/" + key).remove().then(() => {
    alert("Fault report deleted.");
    loadReports();
  });
}

/* FILTERS: INSPECTIONS */
function applyInspectionFilters() {
  let fDB = document.getElementById("filterDB_i").value.toLowerCase();
  let fElec = document.getElementById("filterElec_i").value.toLowerCase();
  let from = document.getElementById("filterFrom_i").value;
  let to = document.getElementById("filterTo_i").value;

  let filtered = inspectionsGlobal.filter(r => {
    const dbMatch = (fDB === "" || r.dbId.toLowerCase().includes(fDB));
    const elecMatch = (fElec === "" || (r.electricianName || "").toLowerCase().includes(fElec));
    if (!r.timestamp) return false;
    const day = r.timestamp.substring(0,10);
    const fromOk = (!from || day >= from);
    const toOk = (!to || day <= to);
    return dbMatch && elecMatch && fromOk && toOk;
  });

  renderInspectionTable(filtered);
  updateInspectionSummary(filtered);
}

/* FILTERS: FAULTS */
function applyFaultFilters() {
  let fDB = document.getElementById("filterDB_f").value.toLowerCase();
  let fElec = document.getElementById("filterElec_f").value.toLowerCase();
  let from = document.getElementById("filterFrom_f").value;
  let to = document.getElementById("filterTo_f").value;
  let lossFilter = document.getElementById("filterLoss_f").value;

  let filtered = faultsGlobal.filter(r => {
    const dbMatch = (fDB === "" || r.dbId.toLowerCase().includes(fDB));
    const elecMatch = (fElec === "" || (r.electricianName || "").toLowerCase().includes(fElec));
    if (!r.timestamp) return false;
    const day = r.timestamp.substring(0,10);
    const fromOk = (!from || day >= from);
    const toOk = (!to || day <= to);
    const lossOk = (!lossFilter || r.productionLoss === lossFilter);
    return dbMatch && elecMatch && fromOk && toOk && lossOk;
  });

  renderFaultTable(filtered);
  updateFaultSummary(filtered);
}

/* ------------ MASTER DB REPORT (TABLE + INLINE DETAILS) ------------ */
function loadMasterReport() {
  const container = document.getElementById("masterContainer");
  if (!container) return;
  container.innerHTML = "Loading...";

  loadAllPanels(function(all) {
    masterPanelsGlobal = all;
    if (!all) {
      container.innerHTML = "<p>No panels found.</p>";
      document.getElementById("masterSummary").innerHTML = "";
      return;
    }

    const ids = Object.keys(all);
    let totalCircuits = 0;
    ids.forEach(id => {
      const p = all[id];

      if (p.circuits && Array.isArray(p.circuits)) {
        totalCircuits += p.circuits.length;
      }
    });

    document.getElementById("masterSummary").innerHTML = `
      <div class="summary-card">
        <div class="summary-title">Total DB Panels</div>
        <div class="summary-value">${ids.length}</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Total Circuits</div>
        <div class="summary-value">${totalCircuits}</div>
      </div>
    `;

    let html = `
      <table>
        <tr>
          <th>DB</th>
          <th>Voltage</th>
          <th>Main Breaker</th>
          <th>Cable</th>
          <th>Earth</th>
          <th>Location</th>
        <th>Circuits</th>
<th>Inspection Status</th>
<th>Next Due</th>
<th>Reminder</th>
<th>Action</th>

        </tr>
    `;

    ids.forEach(id => {
      const p = all[id];
let statusText = "FIRST INSPECTION REQUIRED";
let statusClass = "badge-bad";
let nextDueText = "-";

if (p.lastInspection) {

  if (p.nextInspectionDue) {

    const nextDate = new Date(p.nextInspectionDue);
    const today = new Date();
    const diffDays = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));

    nextDueText = nextDate.toLocaleDateString("en-GB");

    if (diffDays < 0) {
      statusText = "OVERDUE";
      statusClass = "badge-bad";
    } 
    else if (diffDays <= 5) {
      statusText = "DUE SOON";
      statusClass = "badge-warn";
    } 
    else {
      statusText = "OK";
      statusClass = "badge-ok";
    }

  }

}


      const circuitCount = (p.circuits && Array.isArray(p.circuits)) ? p.circuits.length : 0;
      const rowId = `master-details-${id}`;

      html += `
        <tr class="master-main-row" onclick="toggleMasterDetails('${id}')">
          <td>${p.dbNumber || id}</td>
          <td>${p.voltage || ""}</td>
          <td>${p.mainBreaker || ""}</td>
          <td>${p.cableSize || ""}</td>
          <td>${p.earthStatus || ""}</td>
          <td>${p.location || ""}</td>
          <td>${circuitCount}</td>
<td><span class="badge ${statusClass}">${statusText}</span></td>
<td>${nextDueText}</td>
<td>
  <button class="secondary-btn"
  onclick="sendInspectionReminder('${p.dbNumber || id}', '${nextDueText}', '${statusText}')">
  Send WhatsApp
</button>

</td>
<td>

            <button class="secondary-btn" onclick="event.stopPropagation(); toggleMasterDetails('${id}')">View</button>
          </td>
        </tr>
        <tr id="${rowId}" class="master-details-row" style="display:none;">
          <td colspan="11">
            <div class="master-details-wrapper">
              <div class="master-details-left">
                <h4>Circuits</h4>
      `;

      if (p.circuits && Array.isArray(p.circuits) && p.circuits.length) {
        p.circuits.forEach(c => {
          html += `
            <div class="master-circuit-box">
              <b>${c.name || ""}</b><br>
              Breaker: ${c.breaker || ""}<br>
              Load: ${c.load || ""}
            </div>
          `;
        });
      } else {
        html += `<p>No circuits recorded.</p>`;
      }

      /* NEW: Distribution Breakers section */
      html += `<h4 style="margin-top:12px;">Distribution Breakers</h4>`;
      if (p.distributionBreakers && Array.isArray(p.distributionBreakers) && p.distributionBreakers.length) {
        // table format
        html += `
          <table style="margin-top:8px;font-size:13px;">
            <tr>
              <th>Name</th>
              <th>Rating (A)</th>
              <th>Cable Size</th>
              <th>Load Use</th>
              <th>Load Current (A)</th>
            </tr>
        `;
        p.distributionBreakers.forEach(b => {
          html += `
            <tr>
              <td>${b.name || ""}</td>
              <td>${b.rating || ""}</td>
              <td>${b.cableSize || ""}</td>
              <td>${b.loadUse || ""}</td>
              <td>${b.loadCurrent || ""}</td>
            </tr>
          `;
        });
        html += `</table>`;

        // short text list under table
        html += `<div style="margin-top:6px;font-size:12px;">`;
        p.distributionBreakers.forEach(b => {
          html += `
            <div>
              <b>${b.name || "Breaker"}:</b>
              ${b.rating || ""} | Cable: ${b.cableSize || ""} | Load: ${b.loadUse || ""} | Current: ${b.loadCurrent || ""}
            </div>
          `;
        });
        html += `</div>`;
      } else {
        html += `<p>No distribution breakers recorded.</p>`;
      }

      if (p.extraAnswers && questionsGlobal) {
        html += `<h4 style="margin-top:12px;">Extra DB Info</h4>`;
        Object.entries(p.extraAnswers).forEach(([qid,val]) => {
          const q = questionsGlobal[qid];
          const label = q ? q.text : qid;
          html += `<p><b>${label}:</b> ${val}</p>`;
        });
      }

      html += `
              </div>
              <div class="master-details-right">
                <h4>Panel Image</h4>
      `;

      if (p.image) {
        html += `<img src="${p.image}" class="master-details-image" alt="Panel image">`;
      } else {
        html += `<p style="font-size:13px;color:#666;">No image available.</p>`;
      }

      html += `
              </div>
            </div>
          </td>
        </tr>
      `;
    });

    html += `</table>`;
    container.innerHTML = html;
  });
}

function toggleMasterDetails(id) {
  const row = document.getElementById("master-details-" + id);
  if (!row) return;
  row.style.display = (row.style.display === "none" || row.style.display === "") ? "table-row" : "none";
}

/* ------------ CSV EXPORT HELPERS ------------ */
function arrayToCSV(rows) {
  return rows.map(r => r.map(v => {
    if (v == null) return "";
    const s = String(v).replace(/"/g, '""');
    if (s.search(/("|,|\n)/g) >= 0) {
      return `"${s}"`;
    }
    return s;
  }).join(",")).join("\n");
}

function downloadCSV(filename, csv) {
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/* EXPORT: INSPECTIONS */
function exportInspectionsCSV() {
  if (!inspectionsGlobal || !inspectionsGlobal.length) {
    alert("No inspection data to export.");
    return;
  }
  const rows = [];
  rows.push(["Timestamp","DB","Electrician","Breaker Status","Clean Status","Locked Status","Covered Status","Comments"]);
  inspectionsGlobal.forEach(r => {
    rows.push([
      r.timestamp || "",
      r.dbId || "",
      r.electricianName || "",
      r.breakerStatus || "",
      r.cleanStatus || "",
      r.lockedStatus || "",
      r.coveredStatus || "",
      r.comments || ""
    ]);
  });
  const csv = arrayToCSV(rows);
  downloadCSV("inspections.csv", csv);
}

/* EXPORT: FAULTS */
function exportFaultsCSV() {
  if (!faultsGlobal || !faultsGlobal.length) {
    alert("No fault data to export.");
    return;
  }
  const rows = [];
  rows.push(["Timestamp","DB","Electrician","Fault Type","Description","Start Time","End Time","Downtime (min)","Production Loss","Production Loss Desc"]);
  faultsGlobal.forEach(r => {
    rows.push([
      r.timestamp || "",
      r.dbId || "",
      r.electricianName || "",
      r.faultType || "",
      r.description || "",
      r.startTime || "",
      r.endTime || "",
      r.downtimeMinutes != null ? r.downtimeMinutes : "",
      r.productionLoss || "",
      r.productionLossDesc || ""
    ]);
  });
  const csv = arrayToCSV(rows);
  downloadCSV("faults.csv", csv);
}

/* EXPORT: MASTER DB + CIRCUITS + DISTRIBUTION BREAKERS */
function exportMasterCSV() {
  if (!masterPanelsGlobal) {
    alert("No master DB data loaded yet. Click 'Reload Data' first.");
    return;
  }
  const rows = [];
  rows.push([
    "DB","Voltage","Main Breaker","Cable Size","Earth Status","Location","Purpose",
    "Circuit Name","Circuit Breaker","Circuit Load",
    "Dist Name","Dist Rating","Dist Cable","Dist Load","Dist Current"
  ]);

  Object.keys(masterPanelsGlobal).forEach(id => {
    const p = masterPanelsGlobal[id];
    const circuits = (p.circuits && Array.isArray(p.circuits)) ? p.circuits : [];
    const dist = (p.distributionBreakers && Array.isArray(p.distributionBreakers)) ? p.distributionBreakers : [];

    if (circuits.length) {
      circuits.forEach(c => {
        rows.push([
          p.dbNumber || id,
          p.voltage || "",
          p.mainBreaker || "",
          p.cableSize || "",
          p.earthStatus || "",
          p.location || "",
          p.purpose || "",
          c.name || "",
          c.breaker || "",
          c.load || "",
          "", "", "", "", ""
        ]);
      });
    } else {
      // row without circuits
      rows.push([
        p.dbNumber || id,
        p.voltage || "",
        p.mainBreaker || "",
        p.cableSize || "",
        p.earthStatus || "",
        p.location || "",
        p.purpose || "",
        "", "", "",
        "", "", "", "", ""
      ]);
    }

    if (dist.length) {
      dist.forEach(b => {
        rows.push([
          p.dbNumber || id,
          p.voltage || "",
          p.mainBreaker || "",
          p.cableSize || "",
          p.earthStatus || "",
          p.location || "",
          p.purpose || "",
          "", "", "",
          b.name || "",
          b.rating || "",
          b.cableSize || "",
          b.loadUse || "",
          b.loadCurrent || ""
        ]);
      });
    }
  });

  const csv = arrayToCSV(rows);
  downloadCSV("master_panels.csv", csv);
}

/* ------------ DYNAMIC QUESTIONS (ADMIN + DB ENTRY + REPORTS) ------------ */
function loadQuestions() {
  firebase.database().ref("questions").on("value", snap => {
    questionsGlobal = snap.val() || {};
    renderQuestionsAdmin();
    renderDbQuestions();
    // Re-render tables so extraAnswers labels are resolved
    renderInspectionTable(inspectionsGlobal || []);
    renderFaultTable(faultsGlobal || []);
    // Re-render master if loaded
    if (masterPanelsGlobal) loadMasterReport();
  });
}

function addQuestion() {
  const text = document.getElementById("qText").value.trim();
  const type = document.getElementById("qType").value;
  const optionsStr = document.getElementById("qOptions").value.trim();
  const applyDb = document.getElementById("qApplyDb").checked;
  const applyInspection = document.getElementById("qApplyInsp").checked;
  const applyFault = document.getElementById("qApplyFault").checked;

  if (!text) {
    alert("Please enter question text.");
    return;
  }
  if (!applyDb && !applyInspection && !applyFault) {
    alert("Select at least one section (DB / Inspection / Fault).");
    return;
  }

  let options = [];
  if (type === "dropdown" && optionsStr) {
    options = optionsStr.split(",").map(s => s.trim()).filter(Boolean);
  }

  const data = {
    text,
    type,
    options,
    applyDb,
    applyInspection,
    applyFault,
    active: true
  };

  firebase.database().ref("questions").push(data, err => {
    if (err) alert("Error adding question: " + err);
    else {
      document.getElementById("qText").value = "";
      document.getElementById("qOptions").value = "";
      alert("Question added.");
    }
  });
}

function renderQuestionsAdmin() {
  const container = document.getElementById("questionsList");
  if (!container) return;

  const entries = Object.entries(questionsGlobal);
  if (!entries.length) {
    container.innerHTML = "<p>No questions defined yet.</p>";
    return;
  }

  let html = `
    <table>
      <tr>
        <th>Question</th>
        <th>Type</th>
        <th>Applies To</th>
        <th>Active</th>
        <th>Action</th>
      </tr>
  `;

  entries.forEach(([id, q]) => {
    const applies = [
      q.applyDb ? "DB" : null,
      q.applyInspection ? "Inspection" : null,
      q.applyFault ? "Fault" : null
    ].filter(Boolean).join(", ");

    html += `
      <tr>
        <td>${q.text}</td>
        <td>${q.type}</td>
        <td>${applies}</td>
        <td>${q.active === false ? "No" : "Yes"}</td>
        <td>
          <button class="secondary-btn" onclick="toggleQuestionActive('${id}')">
            ${q.active === false ? "Activate" : "Deactivate"}
          </button>
          <button class="danger-btn" onclick="deleteQuestion('${id}')">Delete</button>
        </td>
      </tr>
    `;
  });

  html += "</table>";
  container.innerHTML = html;
}

function toggleQuestionActive(id) {
  const q = questionsGlobal[id];
  if (!q) return;
  const newVal = !(q.active === false ? false : true);
  firebase.database().ref("questions/" + id + "/active").set(newVal);
}

function deleteQuestion(id) {
  if (!confirm("Delete this question?")) return;
  firebase.database().ref("questions/" + id).remove();
}

function renderDbQuestions() {
  const container = document.getElementById("dbQuestionsContainer");
  if (!container) return;

  const entries = Object.entries(questionsGlobal)
    .filter(([id, q]) => q.applyDb && q.active !== false);

  if (!entries.length) {
    container.innerHTML = "<p style='font-size:13px;color:#666;'>No extra DB questions defined.</p>";
    return;
  }

  let html = "";
  entries.forEach(([id, q]) => {
    html += renderQuestionFieldHtml("db", id, q);
  });

  container.innerHTML = html;
}

function renderQuestionFieldHtml(sectionPrefix, id, q) {
  const baseId = `q_${sectionPrefix}_${id}`;
  let fieldHtml = "";

  if (q.type === "text") {
    fieldHtml = `<input type="text" id="${baseId}" style="width:100%;max-width:400px;">`;
  } else if (q.type === "number") {
    fieldHtml = `<input type="number" id="${baseId}" style="width:150px;">`;
  } else if (q.type === "yesno") {
    fieldHtml = `
      <select id="${baseId}">
        <option value=""></option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    `;
  } else if (q.type === "dropdown") {
    const opts = (q.options || []);
    const optionsHtml = ['<option value=""></option>']
      .concat(opts.map(o => `<option value="${o}">${o}</option>`))
      .join("");
    fieldHtml = `<select id="${baseId}">${optionsHtml}</select>`;
  } else {
    fieldHtml = `<input type="text" id="${baseId}" style="width:100%;max-width:400px;">`;
  }

  return `
    <div style="margin-top:10px;">
      <label style="font-weight:bold;">${q.text}</label><br>
      ${fieldHtml}
    </div>
  `;
}

/* collect answers for current section (db/insp/fault) */
function collectDynamicAnswers(sectionPrefix) {
  const result = {};
  Object.entries(questionsGlobal).forEach(([id, q]) => {
    let apply = false;
    if (sectionPrefix === "db" && q.applyDb) apply = true;
    if (sectionPrefix === "insp" && q.applyInspection) apply = true;
    if (sectionPrefix === "fault" && q.applyFault) apply = true;
    if (!apply || q.active === false) return;

    const input = document.getElementById(`q_${sectionPrefix}_${id}`);
    if (!input) return;
    const val = (input.value || "").toString().trim();
    if (val) {
      result[id] = val;
    }
  });

  return Object.keys(result).length ? result : null;
}

/* ------------ TRANSFORMER REPORTS (from transformer.html) ------------ */
function loadTransformerReports() {
  firebase.database().ref("transformerInspections").once("value", snap => {
    const data = snap.val() || {};
    const list = [];
    for (let trId in data) {
      for (let key in data[trId]) {
        list.push({
          transformerId: trId,
          recordKey: key,
          ...data[trId][key]
        });
      }
    }
    transformerReportsGlobal = list;
    renderTransformerTable(list);
    updateTransformerSummary(list);
  });
}

function updateTransformerSummary(list) {
  const container = document.getElementById("trSummary");
  if (!container) return;
  if (!list || !list.length) {
    container.innerHTML = "<p>No transformer reports.</p>";
    return;
  }
  const total = list.length;
  const transformersCount = new Set(list.map(r => r.transformerId)).size;
  const today = new Date().toISOString().slice(0,10);
  const todayCount = list.filter(r => (r.timestamp || "").slice(0,10) === today).length;

  container.innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total Reports</div>
      <div class="summary-value">${total}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Transformers</div>
      <div class="summary-value">${transformersCount}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Today</div>
      <div class="summary-value">${todayCount}</div>
    </div>
  `;
}

function renderTransformerTable(list) {
  const container = document.getElementById("transformerTable");
  if (!container) return;

  if (!list || !list.length) {
    container.innerHTML = "<p>No transformer reports.</p>";
    return;
  }

  let html = `
    <table>
      <tr>
        <th>Date/Time</th>
        <th>Transformer</th>
        <th>Electrician</th>
        <th>Oil</th>
        <th>Temp (Oil/Winding)</th>
        <th>IR (MŒ©)</th>
        <th>Earth (Œ©)</th>
        <th>Load (A)</th>
        <th>Photos</th>
        <th>Action</th>
      </tr>
  `;

  list.forEach(r => {
    const dt = r.datetimeLocal 
      ? r.datetimeLocal.replace("T"," ")
      : (r.timestamp ? new Date(r.timestamp).toLocaleString() : "");
    html += `
      <tr>
        <td>${dt}</td>
        <td>${r.transformerId || ""}</td>
        <td>${r.electricianName || ""}</td>
        <td>${r.oilCondition || ""}<br>Level: ${r.oilLevel || ""}</td>
        <td>${r.oilTemperature || ""} / ${r.windingTemperature || ""}</td>
        <td>${r.irTest || ""}</td>
        <td>${r.earthResistance || ""}</td>
        <td>${r.loadCurrent || ""}</td>
        <td>
          ${r.photo1 ? `<button class='photo-btn' onclick="openPhoto('${r.photo1}')">1</button>` : ""}
          ${r.photo2 ? `<button class='photo-btn' onclick="openPhoto('${r.photo2}')">2</button>` : ""}
          ${r.photo3 ? `<button class='photo-btn' onclick="openPhoto('${r.photo3}')">3</button>` : ""}
        </td>
        <td>
          <button class="secondary-btn" onclick="openTransformerReportPrint('${r.transformerId}','${r.recordKey}')">
            View / Print
          </button>
          <button class="danger-btn" onclick="deleteTransformerReport('${r.transformerId}','${r.recordKey}')">
            Delete
          </button>
        </td>
      </tr>
    `;
  });

  html += "</table>";
  container.innerHTML = html;
}

function applyTransformerFilters() {
  let fId = document.getElementById("filterTR_id").value.toLowerCase();
  let fElec = document.getElementById("filterTR_elec").value.toLowerCase();
  let from = document.getElementById("filterTR_from").value;
  let to   = document.getElementById("filterTR_to").value;

  let filtered = transformerReportsGlobal.filter(r => {
    const idMatch   = !fId   || (r.transformerId || "").toLowerCase().includes(fId);
    const elecMatch = !fElec || (r.electricianName || "").toLowerCase().includes(fElec);
    const day = (r.timestamp || "").slice(0,10);
    const fromOk = !from || day >= from;
    const toOk   = !to   || day <= to;
    return idMatch && elecMatch && fromOk && toOk;
  });

  renderTransformerTable(filtered);
  updateTransformerSummary(filtered);
}

function deleteTransformerReport(trId, key) {
  if (!confirm("Delete this transformer report?")) return;
  firebase.database().ref("transformerInspections/" + trId + "/" + key).remove().then(() => {
    alert("Report deleted.");
    loadTransformerReports();
  });
}

function exportTransformersCSV() {
  if (!transformerReportsGlobal.length) {
    alert("No transformer reports.");
    return;
  }
  const rows = [["DateTime","Transformer","Electrician","OilCondition","OilLevel","OilTemp","WindingTemp","IR","EarthRes","LoadCurrent","Remarks"]];

  transformerReportsGlobal.forEach(r => {
    const dt = r.datetimeLocal 
      ? r.datetimeLocal.replace("T"," ")
      : (r.timestamp || "");
    rows.push([
      dt,
      r.transformerId || "",
      r.electricianName || "",
      r.oilCondition || "",
      r.oilLevel || "",
      r.oilTemperature || "",
      r.windingTemperature || "",
      r.irTest || "",
      r.earthResistance || "",
      r.loadCurrent || "",
      r.remarks || ""
    ]);
  });

  const csv = arrayToCSV(rows);
  downloadCSV("transformer_reports.csv", csv);
}

/* ------------ LUX REPORTS (from lux.html) ------------ */

// Load all LUX reports from Firebase into luxReportsGlobal
function loadLuxReports() {
  firebase.database().ref("luxReports").once("value", snap => {
    const data = snap.val() || {};
    const list = Object.keys(data).map(key => ({
      key,
      ...data[key]
    }));
    luxReportsGlobal = list;
    renderLuxTable(list);
    updateLuxSummary(list);
  });
}

// Summary cards for LUX tab
function updateLuxSummary(list) {
  const container = document.getElementById("luxSummary");
  if (!container) return;

  if (!list || !list.length) {
    container.innerHTML = "<p>No LUX reports.</p>";
    return;
  }

  const total = list.length;
  const locs = new Set(
    list.map(r => (r.samplingLocation || r.department || "")).filter(Boolean)
  ).size;

  container.innerHTML = `
    <div class="summary-card">
      <div class="summary-title">Total LUX Reports</div>
      <div class="summary-value">${total}</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Locations / Departments</div>
      <div class="summary-value">${locs}</div>
    </div>
  `;
}

// Open printable Word-style view in new tab
function openLuxPrint(key) {
  window.open("lux_print.html?id=" + encodeURIComponent(key), "_blank");
}

// Table in LUX tab
function renderLuxTable(list) {
  const container = document.getElementById("luxTable");
  if (!container) return;

  if (!list || !list.length) {
    container.innerHTML = "<p>No LUX reports.</p>";
    return;
  }

  let html = `
    <table>
      <tr>
        <th>Date</th>
        <th>Location / Dept</th>
        <th>Type of Monitoring</th>
        <th>Collected By</th>
        <th>Meter / Calibration</th>
        <th>Measurements</th>
        <th>Action</th>
      </tr>
  `;

  list.forEach(r => {
    const dateStr = r.sampleDate || r.date || "";
    const timePart = r.timeFrom
      ? `From ${r.timeFrom}${r.timeTo ? " ‚Äì " + r.timeTo : ""}`
      : (r.time || "");

    const loc = r.samplingLocation || r.department || "";

    const typeText = [r.typeSpot, r.typeArea, r.monitorType]
      .filter(Boolean)
      .join(" / ");

    const meterText = [
      r.model || r.meterModel || "",
      (r.calibrationNo ? "Cert: " + r.calibrationNo : ""),
      (r.calibrationDate ? "(" + r.calibrationDate + ")" : "")
    ]
      .filter(Boolean)
      .join("<br>");

    let measText = "";
    if (Array.isArray(r.measurements) && r.measurements.length) {
      measText = r.measurements
        .map((m, i) =>
          `${i + 1}. ${(m.point || "")}: ${(m.measuredLux || "")} lx${
            m.limitLux ? ` (Limit: ${m.limitLux})` : ""
          }`
        )
        .join("<br>");
    }

    html += `
      <tr>
        <td>${dateStr}<br><small>${timePart}</small></td>
        <td>${loc}</td>
        <td>${typeText}</td>
        <td>${r.collectedBy || r.electricianName || ""}</td>
        <td>${meterText}</td>
        <td>${measText}</td>
        <td>
          <button class="secondary-btn" onclick="openLuxPrint('${r.key}')">
            View / Print
          </button>
          <button class="danger-btn" onclick="deleteLuxReport('${r.key}')">
            Delete
          </button>
        </td>
      </tr>
    `;
  });

  html += "</table>";
  container.innerHTML = html;
}

// Filters at top of LUX tab
function applyLuxFilters() {
  let fDept = document.getElementById("filterLX_dept").value.toLowerCase();
  let fElec = document.getElementById("filterLX_elec").value.toLowerCase();
  let from = document.getElementById("filterLX_from").value;
  let to   = document.getElementById("filterLX_to").value;

  let filtered = luxReportsGlobal.filter(r => {
    const loc = (r.samplingLocation || r.department || "").toLowerCase();
    const name = (r.collectedBy || r.electricianName || "").toLowerCase();
    const day = r.sampleDate || r.date || "";

    const deptMatch = !fDept || loc.includes(fDept);
    const elecMatch = !fElec || name.includes(fElec);
    const fromOk = !from || day >= from;
    const toOk   = !to   || day <= to;

    return deptMatch && elecMatch && fromOk && toOk;
  });

  renderLuxTable(filtered);
  updateLuxSummary(filtered);
}

// Delete LUX report (unchanged)
function deleteLuxReport(key) {
  if (!confirm("Delete this LUX report?")) return;
  firebase.database().ref("luxReports/" + key).remove().then(() => {
    alert("LUX report deleted.");
    loadLuxReports();
  });
}

// CSV export ‚Äì compatible with new structure
function exportLuxCSV() {
  if (!luxReportsGlobal.length) {
    alert("No LUX data to export.");
    return;
  }

  const rows = [
    [
      "Date",
      "Time",
      "Location/Dept",
      "Type",
      "CollectedBy",
      "MeterModel",
      "CalibNo",
      "CalibDate",
      "Measurements"
    ]
  ];

  luxReportsGlobal.forEach(r => {
    const date = r.sampleDate || r.date || "";
    const time = r.timeFrom
      ? `${r.timeFrom}${r.timeTo ? " ‚Äì " + r.timeTo : ""}`
      : (r.time || "");

    const loc  = r.samplingLocation || r.department || "";
    const type = [r.typeSpot, r.typeArea, r.monitorType]
      .filter(Boolean)
      .join(" / ");
    const name = r.collectedBy || r.electricianName || "";
    const model = r.model || r.meterModel || "";
    const calibNo = r.calibrationNo || "";
    const calibDate = r.calibrationDate || "";

    const meas = (r.measurements || [])
      .map((m, i) =>
        `${i + 1}) ${m.point || ""}: ${m.measuredLux || ""} lx${
          m.limitLux ? ` (Limit:${m.limitLux})` : ""
        }`
      )
      .join(" | ");

    rows.push([date, time, loc, type, name, model, calibNo, calibDate, meas]);
  });

  const csv = arrayToCSV(rows);
  downloadCSV("lux_reports.csv", csv);
}
function sendInspectionReminder(dbId, nextDue, status) {

  let message = "";

  if (status === "FIRST INSPECTION REQUIRED") {

    message =
`‚ö†Ô∏è FIRST INSPECTION REQUIRED

DB: ${dbId}

This panel has never been inspected.
Please conduct first inspection immediately.

Chenab Engineering Works`;

  }
  else if (status === "OVERDUE") {

    message =
`üö® INSPECTION OVERDUE

DB: ${dbId}
Due Date: ${nextDue}

Inspection is overdue.
Immediate action required.

Chenab Engineering Works`;

  }
  else if (status === "DUE SOON") {

    message =
`‚ö° Inspection Due Soon

DB: ${dbId}
Next Due: ${nextDue}

Please schedule inspection.

Chenab Engineering Works`;

  }
  else {

    message =
`‚ÑπÔ∏è Inspection Reminder

DB: ${dbId}
Next Due: ${nextDue}

Regular inspection reminder.

Chenab Engineering Works`;

  }

  const url = "https://wa.me/?text=" + encodeURIComponent(message);
  window.open(url, "_blank");
}
function sendTransformerReminder(trId, nextDue, status) {

  let message = "";

  if (status === "FIRST INSPECTION REQUIRED") {

    message =
`‚ö†Ô∏è FIRST TRANSFORMER INSPECTION REQUIRED

Transformer: ${trId}

This transformer has never been inspected.
Please conduct inspection immediately.

Chenab Engineering Works`;

  }
  else if (status === "OVERDUE") {

    message =
`üö® TRANSFORMER INSPECTION OVERDUE

Transformer: ${trId}
Due Date: ${nextDue}

Inspection is overdue.
Immediate action required.

Chenab Engineering Works`;

  }
  else if (status === "DUE SOON") {

    message =
`‚ö° Transformer Inspection Due Soon

Transformer: ${trId}
Next Due: ${nextDue}

Please schedule inspection.

Chenab Engineering Works`;

  }
  else {

    message =
`‚ÑπÔ∏è Transformer Inspection Reminder

Transformer: ${trId}
Next Due: ${nextDue}

Regular inspection reminder.

Chenab Engineering Works`;

  }

  const url = "https://wa.me/?text=" + encodeURIComponent(message);
  window.open(url, "_blank");
}

</script>

</body>
</html>
