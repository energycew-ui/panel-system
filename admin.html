<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script src="data.js"></script>

  <style>
    body { font-family: Arial; margin: 30px; }
    #loginOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    }
    #loginBox {
      background: #fff; padding: 25px 30px; border-radius: 10px;
      width: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); text-align: center;
    }
    #previewImage {
      width: 200px; display: none; margin-top: 10px;
      border: 2px solid #444; border-radius: 6px;
    }
    .circuit-row { display: flex; gap: 8px; margin-top: 8px; }
    .circuit-row input { width: 100%; }
    .circuit-remove-btn { background:#c40000;color:white;border-radius:4px;padding:0 8px;cursor:pointer; }
    .dangerBanner {
      background:#c40000;color:white;font-weight:bold;padding:12px;text-align:center;
      margin:20px auto;border-radius:8px;width:350px;
    }
    #qrCanvas { border:1px solid #ccc;padding:10px;margin-top:20px;background:white; }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div id="loginBox">
    <h2>Admin Login</h2>
    <input type="password" id="adminPassword" placeholder="Password">
    <button onclick="checkLogin()">Login</button>
    <div id="loginError" style="color:red;margin-top:10px;"></div>
  </div>
</div>

<!-- MAIN PAGE -->
<div id="adminContent" style="display:none;">

  <h2>Admin – Panel Data</h2>

  <label>DB Number</label>
  <input id="db">

  <label>Voltage Rating</label>
  <input id="volt">

  <label>Main Breaker Capacity</label>
  <input id="breaker">

  <label>Main Cable Size</label>
  <input id="cable">

  <label>Earth Status</label>
  <input id="earth">

  <label>Location</label>
  <input id="location">

  <label>Purpose</label>
  <input id="purpose">

  <label>Upload Panel Picture</label>
  <input type="file" id="imageInput" accept="image/*" onchange="previewAndCompress(event)">
  <img id="previewImage">
  <button onclick="removeImage()">Remove Picture</button>

  <h3>Circuits</h3>
  <div id="circuitsContainer"></div>
  <button onclick="addCircuitRow()">Add Circuit</button>

  <br><br>
  <button onclick="savePanel()">Save Panel</button>

  <h3>Generate QR Code</h3>
  <button onclick="generateQR()">Generate QR</button>

  <div style="text-align:center;margin-top:20px;">
    <div class="dangerBanner">⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️</div>
    <canvas id="qrCanvas"></canvas>
    <div id="qrDBname" style="font-size:22px;font-weight:bold;margin-top:10px;"></div>
  </div>

  <button id="downloadQR" style="display:none;" onclick="downloadQR()">Download QR Sheet</button>

  <hr>

  <h2>All Panels</h2>
  <button onclick="showPanels()">Show All Panels</button>
  <div id="panelList"></div>
</div>

<!-- QR LIB -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<script>
/* LOGIN */
const ADMIN_PASSWORD = "1234";
function checkLogin(){
  if(document.getElementById("adminPassword").value.trim() === ADMIN_PASSWORD){
    sessionStorage.setItem("adminLoggedIn", "1");
    loginOverlay.style.display="none";
    adminContent.style.display="block";
    renderCircuits(null);
  } else loginError.textContent="Incorrect password.";
}
if(sessionStorage.getItem("adminLoggedIn")==="1"){
  loginOverlay.style.display="none";
  adminContent.style.display="block";
  renderCircuits(null);
}

/* IMAGE */
let uploadedImage=null;
function previewAndCompress(e){
  let file=e.target.files[0];
  if(!file) return;
  let R=new FileReader();
  R.onload=ev=>{
    let img=new Image();
    img.src=ev.target.result;
    img.onload=()=>{
      let c=document.createElement("canvas");
      let ctx=c.getContext("2d");
      let maxW=800;
      let scale=maxW/img.width;
      c.width=maxW; c.height=img.height*scale;
      ctx.drawImage(img,0,0,c.width,c.height);
      uploadedImage=c.toDataURL("image/jpeg",0.7);

      previewImage.src=uploadedImage;
      previewImage.style.display="block";
    };
  };
  R.readAsDataURL(file);
}
function removeImage(){
  uploadedImage=null;
  previewImage.style.display="none";
}

/* CIRCUITS */
function addCircuitRow(name="", breaker="", load=""){
  let row=document.createElement("div");
  row.className="circuit-row";
  row.innerHTML=`
    <input class="c-name" placeholder="Circuit" value="${name}">
    <input class="c-breaker" placeholder="Breaker" value="${breaker}">
    <input class="c-load" placeholder="Load" value="${load}">
    <button class="circuit-remove-btn" onclick="this.parentElement.remove()">X</button>`;
  circuitsContainer.appendChild(row);
}
function renderCircuits(circuits){
  circuitsContainer.innerHTML="";
  if(circuits) circuits.forEach(c=>addCircuitRow(c.name,c.breaker,c.load));
  else addCircuitRow();
}
function collectCircuits(){
  let arr=[];
  document.querySelectorAll(".circuit-row").forEach(r=>{
    let n=r.querySelector(".c-name").value.trim();
    let b=r.querySelector(".c-breaker").value.trim();
    let l=r.querySelector(".c-load").value.trim();
    if(n||b||l) arr.push({name:n,breaker:b,load:l});
  });
  return arr.length?arr:null;
}

/* SAVE PANEL */
function savePanel(){
  let id=db.value.trim();
  if(!id) return alert("Enter DB number!");
  let data={
    dbNumber:id,
    voltage:volt.value,
    mainBreaker:breaker.value,
    cableSize:cable.value,
    earthStatus:earth.value,
    location:location.value,
    purpose:purpose.value,
    image:uploadedImage||null,
    circuits:collectCircuits()
  };
  savePanelToFirebase(id,data,()=>alert("Saved."));
}

/* EDIT / DELETE / LIST */
function editPanel(id){
  loadPanelFromFirebase(id,p=>{
    db.value=p.dbNumber;
    volt.value=p.voltage;
    breaker.value=p.mainBreaker;
    cable.value=p.cableSize;
    earth.value=p.earthStatus;
    location.value=p.location;
    purpose.value=p.purpose;
    uploadedImage=p.image||null;
    if(uploadedImage){ previewImage.src=uploadedImage; previewImage.style.display="block"; }
    renderCircuits(p.circuits||null);
    window.scrollTo(0,0);
  });
}
function deletePanel(id){
  if(confirm("Delete "+id+"?")){
    firebase.database().ref("panels/"+id).remove().then(()=>showPanels());
  }
}
function showPanels(){
  loadAllPanels(all=>{
    let html="<table><tr><th>DB</th><th>Location</th><th>Purpose</th><th>Action</th></tr>";
    for(let id in all){
      let p=all[id];
      html+=`
      <tr>
        <td>${p.dbNumber}</td>
        <td>${p.location}</td>
        <td>${p.purpose}</td>
        <td>
          <button onclick="editPanel('${id}')">Edit</button>
          <button onclick="deletePanel('${id}')">Delete</button>
        </td>
      </tr>`;
    }
    html+="</table>";
    panelList.innerHTML=html;
  });
}

/* QR */
let qr;
function generateQR(){
  let id=db.value.trim();
  if(!id) return alert("Enter DB first!");
  let url="https://energycew-ui.github.io/panel-system/index.html?id="+encodeURIComponent(id);
  qr=new QRious({ element:qrCanvas, value:url, size:250 });
  qrDBname.textContent=id;
  downloadQR.style.display="inline-block";
}

/* DOWNLOAD QR SHEET */
function downloadQR(){
  let id=db.value.trim();
  const qrEl=document.getElementById("qrCanvas");

  const W=700, H=900;
  let final=document.createElement("canvas");
  final.width=W; final.height=H;
  let ctx=final.getContext("2d");

  ctx.fillStyle="#fff"; ctx.fillRect(0,0,W,H);

  let logo=new Image();
  logo.src="logo.png";

  logo.onload=()=>{

    /* ---- LOGO ---- */
    let logoW=420;
    let logoH=(logo.height/logo.width)*logoW;
    ctx.drawImage(logo,(W-logoW)/2,40,logoW,logoH);

    /* ---- AUTO-SIZE BANNER ---- */
    const text="⚠️ DANGER – ELECTRICAL PANEL – DO NOT TOUCH ⚠️";
    ctx.font="bold 26px Arial";

    let textW=ctx.measureText(text).width;
    let pad=35;
    let bannerW=textW+(pad*2);
    let bannerX=(W-bannerW)/2;

    ctx.fillStyle="#c40000";
    ctx.fillRect(bannerX,200,bannerW,70);

    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.fillText(text,W/2,245);

    /* ---- QR ---- */
    ctx.drawImage(qrEl,(W-300)/2,300,300,300);

    /* ---- DB ---- */
    ctx.fillStyle="#000";
    ctx.font="bold 36px Arial";
    ctx.fillText(id,W/2,640);

    /* ---- SIGNATURE ---- */
    ctx.font="20px Arial";
    ctx.textAlign="left";
    ctx.fillText("Technician Signature:",80,720);
    ctx.beginPath();
    ctx.moveTo(80,745);
    ctx.lineTo(W-80,745);
    ctx.stroke();

    /* ---- DOWNLOAD ---- */
    let a=document.createElement("a");
    a.download=id+"_QR_sheet.png";
    a.href=final.toDataURL();
    a.click();
  };
}
</script>

</body>
</html>
